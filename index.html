<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Klick</title>
    <link id="dynamic-favicon" rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300ff66' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolygon points='13 2 3 14 12 14 11 22 21 10 12 10 13 2'%3E%3C/polygon%3E%3C/svg%3E">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800;900&display=swap');

        :root {
            --bg-base: #050505;
            --bg-surface: #111111;
            --bg-elevated: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            
            --accent-red: #ff2a5f;
            --accent-blue: #00d4ff;
            --accent-yellow: #ffb800;
            --accent-green: #00ff66;
            --accent-purple: #b5179e;
            --accent-orange: #f77f00;
            
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;

            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            
            --rank-rgb: 0, 255, 102;
            --rank-color: #00ff66;
        }

        * { 
            box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; 
            user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
            -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; 
        }
        body, html { width: 100%; height: 100%; overflow: hidden; background-color: var(--bg-base); color: var(--text-primary); }

        #app { width: 100%; height: 100%; position: relative; background: radial-gradient(circle at 50% -20%, rgba(255,255,255,0.03) 0%, transparent 70%); transition: background 0.5s ease; }
        #app.streak-active { background: radial-gradient(circle at 50% 50%, rgba(var(--rank-rgb), 0.15) 0%, var(--bg-base) 80%); animation: streak-pulse 1.5s infinite alternate ease-out; }
        @keyframes streak-pulse { 0% { box-shadow: inset 0 0 0px rgba(var(--rank-rgb), 0); } 100% { box-shadow: inset 0 0 60px rgba(var(--rank-rgb), 0.15); } }

        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        .screen { width: 100%; height: 100%; flex-direction: column; position: absolute; top: 0; left: 0; opacity: 0; visibility: hidden; pointer-events: none; transform: scale(0.97) translateY(10px); transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; z-index: 1; }
        .screen.active { opacity: 1; visibility: visible; pointer-events: auto; transform: scale(1) translateY(0); z-index: 10; }

        .glass-panel { background: rgba(17, 17, 17, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 15px 35px rgba(0,0,0,0.5); }

        #start-screen { justify-content: center; align-items: center; position: relative; }

        /* Botones superiores */
        .top-btn-container { position: absolute; top: 25px; display: flex; gap: 15px; z-index: 20; width: 100%; justify-content: space-between; padding: 0 25px; pointer-events: none; }
        .top-btn { pointer-events: auto; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; transition: all 0.3s; }
        .top-btn:hover { color: var(--text-primary); background: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }
        .top-btn svg { width: 26px; height: 26px; }

        .logo-container { font-size: clamp(3.5rem, 10vw, 7rem); font-weight: 900; font-style: italic; letter-spacing: -2px; color: var(--text-primary); text-align: center; line-height: 1; }
        .logo-dot { color: var(--accent-green); transition: color 0.5s ease; font-style: normal; }
        .logo-subtitle { font-size: clamp(0.7rem, 2vw, 0.9rem); font-weight: 600; letter-spacing: 4px; color: var(--text-secondary); margin-top: 5px; margin-bottom: 40px; display: block; text-transform: uppercase; text-align: center; }

        .menu-box { display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 360px; }
        .btn-solid, .btn-outline { width: 100%; padding: clamp(14px, 2.5vh, 18px); font-size: 1rem; font-weight: 800; letter-spacing: 1.5px; border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease-out; display: flex; justify-content: center; align-items: center; text-transform: uppercase; gap: 10px; }
        
        .btn-solid { color: #ffffff; background-color: rgba(255,255,255,0.06); border: 1.5px solid rgba(255,255,255,0.7); }
        .btn-solid:hover { background-color: rgba(255,255,255,0.14); border-color: #ffffff; transform: translateY(-2px); box-shadow: 0 8px 24px rgba(255,255,255,0.15); }
        .btn-solid:active { transform: scale(0.96); }

        .btn-outline { color: rgba(255,255,255,0.75); background-color: transparent; border: 1.5px solid rgba(255,255,255,0.3); }
        .btn-outline:hover { color: #ffffff; border-color: rgba(255,255,255,0.7); background-color: rgba(255,255,255,0.06); transform: translateY(-2px); }
        .btn-outline:active { transform: scale(0.96); }


        .top-nav { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--bg-elevated); background: rgba(5, 5, 5, 0.6); backdrop-filter: blur(15px); z-index: 10; flex-shrink: 0; }
        .btn-back { background: transparent; color: var(--text-secondary); border: 1px solid var(--bg-elevated); padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; width: 110px; }
        .btn-back:hover { color: var(--text-primary); border-color: var(--text-primary); background: rgba(255,255,255,0.05); }
        .nav-title { font-weight: 800; letter-spacing: 2px; color: var(--text-primary); text-align: center; flex: 1; text-transform: uppercase; font-size: 0.9rem; }
        .nav-spacer { width: 110px; display: block; }

        .content-fit { width: 100%; height: calc(100% - 65px); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: clamp(10px, 2vh, 20px); overflow: hidden; }
        .content-scroll { width: 100%; height: calc(100% - 65px); display: flex; flex-direction: column; align-items: center; padding: 20px 15px 40px 15px; overflow-y: auto; }
        .content-scroll::-webkit-scrollbar { width: 6px; } .content-scroll::-webkit-scrollbar-track { background: transparent; } .content-scroll::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 10px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Modales */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s var(--ease-out); z-index: 100; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        /* --- Pantallas Generales (Expansivas) --- */
        .settings-dashboard, .profile-dashboard, .guide-dashboard, .ranking-wrapper, .achievements-wrapper {
            width: 100%; max-width: 100%; padding: 0 15px; display: flex; flex-direction: column; margin: 0 auto;
        }

        .settings-dashboard { max-width: 800px; justify-content: center; min-height: 100%; padding-bottom: 20px; gap: clamp(15px, 2vh, 30px); }
        .settings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: clamp(15px, 2vw, 25px); width: 100%; }
        .setting-card { padding: clamp(20px, 3vh, 30px); border-radius: var(--radius-lg); border: 1px solid var(--bg-elevated); display: flex; flex-direction: column; gap: 20px; transition: all 0.3s ease; height: 100%; }
        .setting-card:hover { border-color: rgba(255,255,255,0.1); transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .setting-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .setting-title-box { display: flex; align-items: center; gap: 15px; }
        .setting-icon { width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .setting-icon svg { width: 22px; height: 22px; }
        .setting-label { font-size: clamp(0.9rem, 1.5vw, 1.1rem); font-weight: 800; color: var(--text-primary); text-transform: uppercase; letter-spacing: 1px; display: flex; flex-direction: column; }
        .setting-desc { font-size: clamp(0.65rem, 1vw, 0.75rem); color: var(--text-secondary); margin-top: 4px; font-weight: 500; text-transform: none; letter-spacing: 0; }
        .setting-value { font-family: monospace; font-size: clamp(0.9rem, 1.5vw, 1.1rem); font-weight: 900; padding: 6px 14px; border-radius: var(--radius-sm); border: 1px solid rgba(255,255,255,0.08); color: var(--text-primary); background: rgba(255,255,255,0.04); }

        /* Estilos de Rango/Deslizadores */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 5px 0 0 0; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; background: rgba(0,0,0,0.6); border-radius: 4px; border: 1px solid rgba(255,255,255,0.05); box-shadow: inset 0 1px 3px rgba(0,0,0,0.8); }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 22px; width: 22px; border-radius: 50%; 
            background: var(--text-primary); margin-top: -8px; cursor: pointer;
            border: 4px solid var(--bg-elevated); box-shadow: 0 0 10px rgba(255, 255, 255, 0.2); transition: all 0.3s var(--ease-spring);
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.3); background: var(--rank-color); border-color: rgba(255,255,255,0.9); box-shadow: 0 0 15px rgba(var(--rank-rgb), 0.6); }
        input[type=range]::-webkit-slider-thumb:active { transform: scale(0.9); }

        /* Perfil */
        .profile-dashboard { justify-content: center; max-width: 1200px; gap: clamp(10px, 2vh, 30px); height: 100%; }
        .profile-hero { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: clamp(20px, 4vh, 40px); border-radius: var(--radius-lg); text-align: center; }
        .profile-rank { font-weight: 800; font-size: clamp(0.8rem, 1.5vw, 1rem); text-transform: uppercase; letter-spacing: 2px; }
        .profile-name-input { width: 100%; background: transparent; border: none; border-bottom: 2px solid var(--bg-elevated); color: var(--text-primary); font-size: clamp(1.8rem, 5vw, 3.5rem); font-weight: 900; text-align: center; padding: 5px 0; outline: none; text-transform: uppercase; transition: all 0.3s; }
        .profile-name-input:focus { border-bottom-color: var(--text-primary); }
        .profile-warning { color: var(--accent-red); font-size: 0.8rem; margin-top: 5px; font-weight: 600; opacity: 0; transition: opacity 0.3s ease; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: clamp(10px, 2vw, 20px); width: 100%; }
        .stat-card { padding: clamp(15px, 3vh, 25px) 10px; border-radius: var(--radius-md); border: 1px solid var(--bg-elevated); display: flex; flex-direction: column; align-items: center; text-align: center; gap: 5px; }
        .stat-value { font-size: clamp(1.5rem, 3vw, 2.5rem); font-weight: 900; color: var(--text-primary); line-height: 1; }
        .stat-label { font-size: clamp(0.6rem, 1vw, 0.8rem); color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .profile-achievements-title { font-size: clamp(0.9rem, 2vw, 1.2rem); font-weight: 800; text-align: center; color: var(--text-primary); text-transform: uppercase; margin-top: 5px; letter-spacing: 1px; }
        .profile-achievements-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: clamp(10px, 2vw, 15px); width: 100%; }
        .achievement-slot { background: rgba(17, 17, 17, 0.4); border: 1px dashed var(--bg-elevated); border-radius: var(--radius-md); padding: clamp(10px, 2vh, 20px); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; opacity: 0.4; filter: grayscale(1); position: relative; }
        .achievement-slot.unlocked { border-style: solid; opacity: 1; filter: grayscale(0); background: rgba(17, 17, 17, 0.7); backdrop-filter: blur(10px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .ach-icon { width: clamp(24px, 4vw, 32px); height: clamp(24px, 4vw, 32px); }
        .ach-icon svg { width: 100%; height: 100%; }
        .ach-title { font-size: clamp(0.65rem, 1vw, 0.8rem); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; text-align: center; }

        /* Guía y Rangos */
        .guide-dashboard { justify-content: flex-start; gap: clamp(10px, 2vh, 20px); width: 100%; max-width: 1000px; padding: 0 0 30px 0; }
        .guide-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: clamp(12px, 2vw, 18px); width: 100%; }
        .guide-card { padding: clamp(18px, 2.5vh, 28px); border-radius: var(--radius-md); border: 1px solid var(--bg-elevated); display: flex; flex-direction: column; align-items: center; text-align: center; gap: 10px; height: 100%; }
        .guide-card:hover { }
        .guide-card.full-width { grid-column: 1 / -1; }
        .guide-icon { width: 35px; height: 35px; color: var(--text-primary); margin-bottom: 5px; }
        .guide-title { font-size: clamp(1rem, 1.5vw, 1.3rem); font-weight: 800; color: var(--text-primary); letter-spacing: -0.5px; text-transform: uppercase; }
        .guide-text { color: var(--text-secondary); font-size: clamp(0.85rem, 1.2vw, 0.95rem); line-height: 1.4; }
        .guide-text strong { color: var(--text-primary); }
        .rank-list { display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; width: 100%; gap: 10px; margin-top: 10px; }
        .rank-item { display: flex; flex-direction: column; align-items: center; padding: clamp(10px, 1.5vh, 15px); background: rgba(5,5,5,0.5); border-radius: var(--radius-sm); border: 1px solid var(--bg-elevated); flex: 1 1 30%; }
        .rank-item-name { font-weight: 800; font-size: clamp(0.85rem, 1.2vw, 1.1rem); text-transform: uppercase; margin-bottom: 4px; }
        .rank-item-pts { color: var(--text-secondary); font-size: clamp(0.7rem, 1vw, 0.85rem); line-height: 1.3; text-align: center; }

        
        /* Banco de Logros - Virtual Scroller */
        #achievements-screen { flex-direction: column; }
        .ach-vrow { display: grid; gap: 12px; padding: 0; }
        .ach-card { background: #111; padding: 16px 12px; border-radius: var(--radius-md); border: 1px dashed var(--bg-elevated); display: flex; flex-direction: column; align-items: center; text-align: center; gap: 7px; opacity: 0.45; filter: grayscale(1); position: relative; cursor: pointer; height: 148px; justify-content: center; box-sizing: border-box; transition: border-color 0.12s, box-shadow 0.12s, opacity 0.12s; }
        .ach-card:hover { border-color: rgba(255,255,255,0.2); }
        .ach-card.unlocked { border-style: solid; opacity: 1; filter: none; background: #191919; }
        .ach-card.pinned { box-shadow: 0 0 14px rgba(255,184,0,0.45) !important; border-color: var(--accent-yellow) !important; border-style: solid !important; }
        .ach-card.in-profile { border-style: solid; }
        .ach-pin-badge { position: absolute; top: 5px; right: 6px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; line-height: 1; pointer-events: none; }
        .ach-pin-manual { color: var(--accent-yellow); }
        .ach-pin-manual svg { width: 14px; height: 14px; }
        .ach-pin-auto { color: rgba(255,255,255,0.45); font-size: 13px; }
        .ach-card .ach-icon { width: 34px; height: 34px; margin-bottom: 2px; }
        .ach-card .ach-title { font-size: 0.88rem; color: var(--text-primary); font-weight: 800; line-height: 1.2; }
        .ach-desc { font-size: 0.7rem; color: var(--text-secondary); line-height: 1.3; font-style: italic; }
        .ach-card.unlocked .ach-desc { font-style: normal; }

        /* --- CLASIFICACIÓN GLOBAL --- */
        .ranking-wrapper { gap: 12px; max-width: 960px; padding: 20px; margin: 0 auto; }
        .ranking-list { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .rank-card { 
            display: grid; grid-template-columns: 62px 1fr auto; align-items: center;
            background: rgba(17, 17, 17, 0.6); backdrop-filter: blur(12px);
            padding: 18px 28px; border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.06);
            transition: all 0.25s ease; position: relative; overflow: hidden;
        }
        .rank-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--text-secondary); opacity: 0.25; transition: opacity 0.25s; }
        .rank-card:hover { background: rgba(255,255,255,0.04); transform: translateX(4px); border-color: rgba(255,255,255,0.12); }
        .rank-card:hover::before { opacity: 0.7; }
        .rc-pos { font-size: 1.5rem; font-weight: 900; color: var(--text-secondary); text-align: center; font-variant-numeric: tabular-nums; }
        .rc-info { display: flex; flex-direction: column; justify-content: center; gap: 4px; padding-left: 10px; }
        .rc-name { font-size: 1.05rem; font-weight: 800; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.5px; }
        .rc-title { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; }
        .rc-score { font-size: 1.2rem; font-weight: 900; font-family: monospace; text-align: right; }
        .rc-score span { font-size: 0.58rem; color: var(--text-secondary); display: block; letter-spacing: 1px; margin-top: 2px; text-align: right; }

        .rank-card.pos-1 { border-color: rgba(255,215,0,0.22); background: rgba(255,215,0,0.04); }
        .rank-card.pos-1::before { background: #ffd700; opacity: 1; width: 4px; }
        .rank-card.pos-1 .rc-pos { color: #ffd700; text-shadow: 0 0 12px rgba(255,215,0,0.5); }
        
        .rank-card.pos-2 { border-color: rgba(192,192,192,0.18); background: rgba(192,192,192,0.03); }
        .rank-card.pos-2::before { background: #c0c0c0; opacity: 0.85; }
        .rank-card.pos-2 .rc-pos { color: #c0c0c0; }
        
        .rank-card.pos-3 { border-color: rgba(205,127,50,0.18); background: rgba(205,127,50,0.03); }
        .rank-card.pos-3::before { background: #cd7f32; opacity: 0.85; }
        .rank-card.pos-3 .rc-pos { color: #cd7f32; }

        .rank-card.is-me { border-color: rgba(var(--rank-rgb), 0.28); background: rgba(var(--rank-rgb), 0.04); }
        .rank-card.is-me::before { background: var(--rank-color); opacity: 0.75; }

        .ranking-loading { text-align: center; color: var(--text-secondary); padding: 40px; font-weight: 600; font-size: 1rem; letter-spacing: 1px; }
        #countdown-screen { justify-content: center; align-items: center; }
        #countdown-number { transition: transform 0.25s var(--ease-spring), opacity 0.25s ease; }
        #countdown-label { transition: opacity 0.25s ease; }

        /* --- Pantalla de Pregunta --- */
        #question-screen { justify-content: space-between; }
        
        .top-bar { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 15px 20px; font-weight: 600; font-size: 0.9rem; color: var(--text-secondary); z-index: 5; background: rgba(5,5,5,0.72); backdrop-filter: blur(10px); }
        .top-bar > *:nth-child(1) { justify-self: start; display: flex; align-items: center; gap: 15px; }
        .top-bar > *:nth-child(2) { justify-self: center; text-align: center; font-size: 1rem; color: var(--text-primary); letter-spacing: 1px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .top-bar > *:nth-child(3) { justify-self: end; display: flex; align-items: center; gap: 10px; }
        
        .btn-abandon { background: transparent; color: var(--accent-red); border: 1px solid rgba(255, 42, 95, 0.5); padding: 6px 12px; border-radius: 20px; cursor: pointer; font-weight: 800; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; transition: all 0.2s; text-transform: uppercase; }
        .btn-abandon:hover { background: rgba(255, 42, 95, 0.2); border-color: var(--accent-red); transform: scale(0.95); }
        .btn-abandon svg { width: 14px; height: 14px; }

        #lives-container { display: flex; gap: 3px; color: var(--accent-yellow); }
        #lives-container svg { width: 16px; height: 16px; transition: all 0.3s; }
        .life-lost { opacity: 0.2; transform: scale(0.8); filter: grayscale(1); }

        .multiplier-badge { background: transparent; border: none !important; box-shadow: none !important; outline: none !important; color: var(--accent-red); font-weight: 900; font-size: 1.4rem; display: none; letter-spacing: -0.5px; padding: 0; }

        .score-badge { background: transparent; color: var(--text-primary); padding: 6px 15px; border-radius: 30px; border: 1px solid var(--text-secondary); font-variant-numeric: tabular-nums; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .score-badge::before { content: ''; display: inline-block; width: 8px; height: 8px; background: var(--accent-yellow); border-radius: 50%; box-shadow: 0 0 10px var(--accent-yellow); }
        
        .question-container { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px 20px; gap: 20px; width: 100%; max-width: 1000px; margin: 0 auto; z-index: 5; }
        .timer-wrapper { position: relative; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; }
        .timer-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
        .timer-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 6; }
        .timer-path { fill: none; stroke: var(--text-primary); stroke-width: 6; stroke-linecap: round; stroke-dasharray: 283; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear, stroke 0.3s ease; }
        .timer-text { font-size: 1.4rem; font-weight: 800; color: var(--text-primary); font-variant-numeric: tabular-nums; }
        .question-text { font-size: clamp(1.4rem, 4vw, 2.5rem); font-weight: 800; text-align: center; line-height: 1.2; width: 100%; letter-spacing: -1px; text-shadow: 0 2px 12px rgba(0,0,0,0.95); background: rgba(5,5,5,0.45); padding: 16px 22px; border-radius: 14px; backdrop-filter: blur(8px); }
        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 15px; padding: 10px 20px 30px 20px; flex: 0 0 45vh; max-width: 1400px; width: 100%; margin: 0 auto; z-index: 5; }
        .answer-btn { position: relative; background-color: rgba(8,8,8,0.72); backdrop-filter: blur(6px); border: 1px solid var(--text-secondary); border-radius: var(--radius-lg); color: var(--text-primary); font-size: clamp(1rem, 2vw, 1.2rem); font-weight: 600; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; opacity: 0; transform: translateY(20px); transition: transform 0.4s var(--ease-spring), opacity 0.4s var(--ease-out), background-color 0.2s, border-color 0.2s, filter 0.3s; }
        .screen.active .answer-btn { opacity: 1; transform: translateY(0); }
        .color-red { border-bottom: 2px solid var(--accent-red); } .color-blue { border-bottom: 2px solid var(--accent-blue); } .color-yellow { border-bottom: 2px solid var(--accent-yellow); } .color-green { border-bottom: 2px solid var(--accent-green); }
        .answer-btn:active { transform: scale(0.96); }
        .answers-grid.answered .answer-btn:not(.selected) { opacity: 0.2; transform: scale(0.95); filter: grayscale(1); pointer-events: none; }
        .answers-grid.answered .answer-btn.selected { background-color: rgba(255,255,255,0.1); transform: scale(1.02); z-index: 2; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .shape-icon { width: 28px; height: 28px; margin: 0 0 8px 0; }
        .progress-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: rgba(255,255,255,0.1); z-index: 10; }
        .progress-bar { height: 100%; background-color: var(--text-primary); width: 0%; transition: width 0.3s var(--ease-out); }

        /* --- Pantallas Extra --- */
        #feedback-screen { justify-content: center; align-items: center; text-align: center; }
        #feedback-screen.correct .feedback-title { color: var(--rank-color); } 
        #feedback-screen.incorrect .feedback-title { color: rgba(255,255,255,0.75); }
        #feedback-screen.timeout .feedback-title { color: rgba(255,255,255,0.6); }
        #feedback-screen.correct .feedback-points { border-color: rgba(var(--rank-rgb), 0.4); color: var(--rank-color); }
        #feedback-screen.correct #feedback-icon-container svg { stroke: var(--rank-color); filter: drop-shadow(0 0 8px rgba(var(--rank-rgb),0.4)); }
        .feedback-content { display: flex; flex-direction: column; align-items: center; transform: scale(0.9); opacity: 0; transition: all 0.5s var(--ease-spring); }
        .screen.active .feedback-content { transform: scale(1); opacity: 1; }
        #feedback-icon-container svg { width: 80px; height: 80px; margin-bottom: 15px; }
        .feedback-title { font-size: clamp(2.5rem, 8vw, 4rem); font-weight: 900; margin-bottom: 5px; letter-spacing: -2px; }
        .feedback-points { font-size: 2rem; font-weight: 800; color: var(--text-primary); margin-bottom: 20px; font-variant-numeric: tabular-nums; background: transparent; padding: 5px 20px; border-radius: 30px; border: 1px solid var(--text-secondary); }
        .streak-box { font-size: 1rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 2px; }
        .streak-box span { color: var(--accent-yellow); font-weight: 900; font-size: 1.2rem; }

        /* --- PANTALLA DE FIN --- */
        #end-screen { justify-content: center; align-items: center; background: transparent; flex-direction: column; }
        #end-screen::before { content: ''; position: absolute; inset: 0; background: radial-gradient(circle at 50% 40%, rgba(var(--rank-rgb), 0.18) 0%, rgba(5,5,5,0.85) 70%); pointer-events: none; z-index: 0; }
        .end-fullscreen { 
            width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: clamp(20px, 4vh, 50px) clamp(20px, 5vw, 80px);
            position: relative; z-index: 2; gap: clamp(10px, 2vh, 18px);
            animation: end-fadein 0.6s var(--ease-out) both;
        }
        @keyframes end-fadein { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .end-rank-label { font-size: clamp(0.65rem, 1.2vw, 0.8rem); font-weight: 800; letter-spacing: 4px; color: var(--text-secondary); text-transform: uppercase; }
        .end-message { font-size: clamp(2.2rem, 6vw, 4rem); font-weight: 900; color: var(--text-primary); line-height: 1; letter-spacing: -2px; text-shadow: 0 0 40px rgba(var(--rank-rgb), 0.3); text-align: center; }
        .end-name { font-size: clamp(0.75rem, 1.5vw, 0.95rem); color: var(--text-secondary); text-transform: uppercase; letter-spacing: 3px; font-weight: 700; }
        .end-score-value { font-size: clamp(4rem, 12vw, 7rem); font-weight: 900; color: var(--rank-color); line-height: 1; text-shadow: 0 0 60px rgba(var(--rank-rgb), 0.4); letter-spacing: -3px; animation: end-score-pop 0.5s 0.3s var(--ease-spring) both; }
        @keyframes end-score-pop { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .end-score-label { font-size: clamp(0.6rem, 1vw, 0.75rem); color: var(--text-secondary); text-transform: uppercase; letter-spacing: 3px; font-weight: 700; margin-top: -6px; }
        .end-stats-grid { display: flex; gap: clamp(12px, 3vw, 30px); width: 100%; justify-content: center; border-top: 1px solid rgba(255,255,255,0.06); padding-top: clamp(12px, 2vh, 20px); }
        .end-stat { display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 80px; }
        .end-stat-val { font-size: clamp(1.4rem, 3vw, 2rem); font-weight: 900; color: var(--text-primary); }
        .end-stat-label { font-size: clamp(0.55rem, 0.9vw, 0.65rem); color: var(--text-secondary); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
        .end-actions { display: flex; gap: 12px; width: 100%; max-width: 420px; }
        .btn-end-menu { flex: 1; padding: 14px; font-size: 0.9rem; font-weight: 800; letter-spacing: 1px; border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s; text-transform: uppercase; background: transparent; color: rgba(255,255,255,0.6); border: 1.5px solid rgba(255,255,255,0.2); }
        .btn-end-menu:hover { color: #fff; border-color: rgba(255,255,255,0.5); background: rgba(255,255,255,0.05); transform: translateY(-2px); }
        .btn-end-replay { flex: 1; padding: 14px; font-size: 0.9rem; font-weight: 800; letter-spacing: 1px; border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s; text-transform: uppercase; background: rgba(var(--rank-rgb), 0.12); color: var(--rank-color); border: 1.5px solid rgba(var(--rank-rgb), 0.5); }
        .btn-end-replay:hover { background: rgba(var(--rank-rgb), 0.22); border-color: var(--rank-color); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(var(--rank-rgb), 0.2); }

        /* Toast UI */
        .toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100; pointer-events: none; }
        .toast-item { background: rgba(17, 17, 17, 0.9); backdrop-filter: blur(10px); border: 1px solid var(--bg-elevated); padding: 12px 15px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 10px; transform: translateX(120%); opacity: 0; transition: all 0.5s var(--ease-spring); }
        .toast-item.show { transform: translateX(0); opacity: 1; }
        .toast-icon { width: 24px; height: 24px; color: var(--accent-yellow); }
        .toast-title { font-size: 0.7rem; text-transform: uppercase; color: var(--text-secondary); font-weight: 800; display: block; }
        .toast-name { font-size: 0.85rem; color: var(--text-primary); font-weight: 800; }

        /* --- Animaciones Frenesí Escalables --- */
        @keyframes frenzy-pulse-x2 { 0%,100%{text-shadow:0 0 10px rgba(247,127,0,0.6);} 50%{text-shadow:0 0 20px rgba(247,127,0,1);} }
        @keyframes frenzy-pulse-x3 { 0%,100%{text-shadow:0 0 12px rgba(255,42,95,0.7);} 50%{text-shadow:0 0 25px rgba(255,42,95,1);} }
        @keyframes frenzy-pulse-x4 { 0%,100%{text-shadow:0 0 15px rgba(181,23,158,0.8);} 50%{text-shadow:0 0 30px rgba(181,23,158,1), 0 0 50px rgba(255,42,95,0.8);} }
        @keyframes frenzy-pulse-x5 { 0%,100%{text-shadow:0 0 20px rgba(255,184,0,0.8);filter:hue-rotate(0deg);} 50%{text-shadow:0 0 35px rgba(255,184,0,1), 0 0 60px rgba(255,42,95,0.8);filter:hue-rotate(20deg);} }
        @keyframes frenzy-neon-x6 { 0%,100%{text-shadow:0 0 20px #fff,0 0 40px var(--rank-color);letter-spacing:0px;} 50%{text-shadow:0 0 30px #fff,0 0 60px var(--rank-color);letter-spacing:2px;} }

        .mult-x2 { color: var(--accent-orange); animation: frenzy-pulse-x2 1.2s ease-in-out infinite; transform: none !important; }
        .mult-x3 { color: var(--accent-red); animation: frenzy-pulse-x3 0.9s ease-in-out infinite; }
        .mult-x4 { color: var(--accent-purple); animation: frenzy-pulse-x4 0.7s ease-in-out infinite; }
        .mult-x5 { color: var(--accent-yellow); animation: frenzy-pulse-x5 0.5s ease-in-out infinite; }
        .mult-x6 { color: var(--rank-color); animation: frenzy-neon-x6 0.4s ease-in-out infinite; }
        .mult-x7 { color: #ff2a5f; animation: frenzy-pulse-x3 0.35s ease-in-out infinite; }
        .mult-x8 { color: var(--accent-purple); animation: frenzy-pulse-x4 0.3s ease-in-out infinite; }
        .mult-x9 { color: #ffb800; animation: frenzy-pulse-x5 0.25s ease-in-out infinite; }
        .mult-x10 { color: #fff; animation: frenzy-neon-x6 0.4s ease-in-out infinite; }


        /* Ach pin indicator on profile */
        .achievement-slot { cursor: default; }

        @media (max-width: 850px) {
            .btn-back span, .nav-spacer { width: 60px; } .btn-back span { display: none; }
            .answers-grid { grid-template-columns: 1fr; grid-template-rows: repeat(4, 1fr); flex: 0 0 55vh; gap: 10px; padding: 10px; }
            .answer-btn { padding: 15px; font-size: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .guide-grid { grid-template-columns: 1fr; }
            .profile-achievements-grid { grid-template-columns: repeat(3, 1fr); }
            .settings-grid { grid-template-columns: 1fr; }
            .toast-container { bottom: auto; top: 20px; right: 50%; transform: translateX(50%); width: 90%; }
            .toast-item { transform: translateY(-120%); }
            .toast-item.show { transform: translateY(0); }
            .achievements-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        }
    </style>
</head>
<body ondragstart="return false;" ondrop="return false;">

<div id="app">
    <canvas id="particle-canvas"></canvas>
    <div class="toast-container" id="toast-container"></div>

    <div id="start-screen" class="screen active content-fit">
        <div class="top-btn-container">
            <button class="top-btn" onclick="goToRanking()" title="Clasificación Global">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="18" y="3" width="4" height="18"></rect><rect x="10" y="8" width="4" height="13"></rect><rect x="2" y="13" width="4" height="8"></rect></svg>
            </button>
            <button class="top-btn" onclick="openSettings()" title="Configuración">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>

        <div class="logo-container" id="logo-title" onclick="onLogoClick()" style="cursor:pointer;">KLICK<span class="logo-dot">.</span></div>
        <div class="logo-subtitle">By Didac-Click Group</div>

        <div class="menu-box" id="menu-box">
            <button class="btn-solid" onclick="startGameCheck()">¡Jugar!</button>
            <button class="btn-outline" onclick="goToProfile()" style="margin-top: 10px;">Mi Perfil</button>
            <button class="btn-outline" onclick="goToAchievements()">Banco de Logros</button>
            <button class="btn-outline" onclick="goToGuide()">Instrucciones</button>
        </div>
    </div>

    <div id="settings-screen" class="screen nav-screen">
        <div class="top-nav">
            <button class="btn-back" onclick="goToMainMenu()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg><span>Regresar</span></button>
            <div class="nav-title">CONFIGURACIÓN</div><div class="nav-spacer"></div>
        </div>
        <div class="content-scroll no-scrollbar">
            <div class="settings-dashboard">
                <div class="settings-grid">
                    
                    <div class="setting-card glass-panel">
                        <div class="setting-header">
                            <div class="setting-title-box">
                                <div class="setting-icon" style="color: var(--text-primary);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                                </div>
                                <div class="setting-label">Música Ambiental<div class="setting-desc">Volumen de la banda sonora</div></div>
                            </div>
                            <span id="val-music" class="setting-value">100%</span>
                        </div>
                        <input type="range" id="op-music" min="0" max="1" step="0.05" value="1">
                    </div>

                    <div class="setting-card glass-panel">
                        <div class="setting-header">
                            <div class="setting-title-box">
                                <div class="setting-icon" style="color: var(--text-primary);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </div>
                                <div class="setting-label">Efectos (SFX)<div class="setting-desc">Volumen de respuestas y clics</div></div>
                            </div>
                            <span id="val-sfx" class="setting-value">100%</span>
                        </div>
                        <input type="range" id="op-sfx" min="0" max="1" step="0.05" value="1">
                    </div>

                    <div class="setting-card glass-panel">
                        <div class="setting-header">
                            <div class="setting-title-box">
                                <div class="setting-icon" style="color: var(--text-primary);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                </div>
                                <div class="setting-label">Fondo Activo<div class="setting-desc">Opacidad de las partículas reactivas</div></div>
                            </div>
                            <span id="val-particles" class="setting-value">100%</span>
                        </div>
                        <input type="range" id="op-particles" min="0" max="1" step="0.05" value="1">
                    </div>

                    <div class="setting-card glass-panel">
                        <div class="setting-header">
                            <div class="setting-title-box">
                                <div class="setting-icon" style="color: var(--text-primary);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                </div>
                                <div class="setting-label">Fluidez (FPS)<div class="setting-desc">Tasa de refresco del sistema</div></div>
                            </div>
                            <span id="val-fps" class="setting-value">60 FPS</span>
                        </div>
                        <input type="range" id="op-fps" min="0" max="4" step="1" value="2">
                    </div>

                    <!-- Selector de Pistas — ocupa las 2 columnas del grid -->
                    <div class="setting-card glass-panel" style="grid-column: 1/-1;">
                        <div class="setting-header">
                            <div class="setting-title-box">
                                <div class="setting-icon" style="color: var(--text-primary);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                                </div>
                                <div class="setting-label">Pista Musical<div class="setting-desc">Elige la banda sonora del juego</div></div>
                            </div>
                        </div>
                        <div id="track-selector" style="display:flex;gap:10px;flex-wrap:wrap;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="abandon-modal" class="modal-overlay">
        <div class="settings-card glass-panel" style="text-align: center; max-width: 320px; padding: 25px 30px; border-radius: var(--radius-lg); border-top: 4px solid var(--accent-red); display: flex; flex-direction: column; gap: 15px;">
            <div style="font-size: 1.2rem; font-weight: 900; color: var(--accent-red); text-transform: uppercase;">¿Abandonar Partida?</div>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">Se aplicará una penalidad de <strong style="color: var(--accent-red);">-300 pts</strong> a tu acumulado.</p>
            <div style="display: flex; gap: 10px; width: 100%;">
                <button class="btn-outline" onclick="cancelAbandon()" style="flex: 1; border-color: var(--text-secondary); color: var(--text-secondary);">Cancelar</button>
                <button class="btn-solid" onclick="confirmAbandon()" style="flex: 1; background: transparent; color: var(--accent-red); border-color: var(--accent-red);">Salir</button>
            </div>
        </div>
    </div>

    <div id="ranking-screen" class="screen nav-screen">
        <div class="top-nav">
            <button class="btn-back" onclick="goToMainMenu()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg><span>Regresar</span></button>
            <div class="nav-title">CLASIFICACIÓN</div><div class="nav-spacer"></div>
        </div>
        <div class="content-scroll no-scrollbar">
            <div class="ranking-wrapper">
                <div id="ranking-list" class="ranking-list">
                    <div class="ranking-loading">Conectando con la base de datos global...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-screen" class="screen nav-screen">
        <div class="top-nav">
            <button class="btn-back" onclick="goToMainMenu()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg><span>Regresar</span></button>
            <div class="nav-title">DASHBOARD</div><div class="nav-spacer"></div>
        </div>
        <div class="content-fit">
            <div class="profile-dashboard">
                <div class="profile-hero glass-panel">
                    <div class="profile-rank" id="profile-rank-display">Rango: Novato</div>
                    <input type="text" id="profile-name-input" class="profile-name-input" placeholder="JUGADOR" autocomplete="off" maxlength="12">
                    <div id="profile-warning" class="profile-warning">Se requiere un nombre</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card glass-panel"><div class="stat-value" id="stat-score">0</div><div class="stat-label">Mejor Puntuación</div></div>
                    <div class="stat-card glass-panel"><div class="stat-value" id="stat-games">0</div><div class="stat-label">Partidas</div></div>
                    <div class="stat-card glass-panel"><div class="stat-value" id="stat-streak">0</div><div class="stat-label">Racha Máx</div></div>
                    <div class="stat-card glass-panel"><div class="stat-value" id="stat-days">0</div><div class="stat-label">Días</div></div>
                </div>
                <div class="profile-achievements-title">Logros Destacados</div>
                <div class="profile-achievements-grid" id="profile-achievements-grid"></div>
            </div>
        </div>
    </div>

    <div id="guide-screen" class="screen nav-screen">
        <div class="top-nav">
            <button class="btn-back" onclick="goToMainMenu()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg><span>Regresar</span></button>
            <div class="nav-title">INSTRUCCIONES</div><div class="nav-spacer"></div>
        </div>
        <div class="content-scroll no-scrollbar">
            <div class="guide-dashboard">
                <div class="guide-grid">

                    <!-- Objetivo del juego -->
                    <div class="guide-card glass-panel full-width" style="border-color: rgba(255,255,255,0.12); padding-bottom: 20px;">
                        <svg class="guide-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-primary);"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                        <div class="guide-title">Objetivo del Juego</div>
                        <div class="guide-text">Klick es un trivia de <strong>preguntas sobre Lengua Española</strong>. Tienes <strong>15 segundos</strong> para responder cada pregunta y <strong>3 vidas</strong> para sobrevivir. Si fallas una respuesta o se te acaba el tiempo, pierdes una vida. Cuando pierdes las 3, la partida termina. ¡Tu objetivo es acumular el mayor puntaje posible!</div>
                    </div>

                    <!-- Puntuación -->
                    <div class="guide-card glass-panel" style="border-color: rgba(255,255,255,0.1);">
                        <svg class="guide-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-secondary);"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        <div class="guide-title">Puntuación por Velocidad</div>
                        <div class="guide-text">Ganar puntos depende de <strong>qué tan rápido respondas</strong>. Una respuesta en los primeros segundos vale hasta <strong>1,600 pts</strong>, mientras que responder al límite vale solo <strong>800 pts</strong>. ¡La velocidad es clave!</div>
                    </div>

                    <!-- Modo Frenesí -->
                    <div class="guide-card glass-panel" style="border-color: rgba(255,255,255,0.1);">
                        <svg class="guide-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-secondary);"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/></svg>
                        <div class="guide-title">Modo Frenesí</div>
                        <div class="guide-text">Al encadenar <strong>5 aciertos seguidos</strong> activas el Modo Frenesí. El fondo cambia, la música se acelera y obtienes un <strong>multiplicador de puntos (x2)</strong>. Cada 5 aciertos más, el multiplicador sube: <strong>x2 → x3 → … → x10 (máximo)</strong>. ¡Un solo fallo lo resetea todo!</div>
                    </div>

                    <!-- Sistema de Rangos completo -->
                    <div class="guide-card full-width glass-panel" style="border-color: rgba(255,255,255,0.1);">
                        <svg class="guide-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-primary);"><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/><circle cx="12" cy="8" r="7"/></svg>
                        <div class="guide-title">Sistema de Rangos</div>
                        <div class="guide-text" style="margin-bottom: 10px;">Debes cumplir <strong>TODOS</strong> los requisitos a la vez para ascender. Los rangos demuestran tu estatus real en el juego.</div>
                        <div class="rank-list">
                            <div class="rank-item" style="border-color: rgba(0,255,102,0.3);">
                                <span class="rank-item-name" style="color: var(--accent-green);">Novato</span>
                                <span class="rank-item-pts">El rango de inicio. ¡No te preocupes, todos empiezan aquí!</span>
                            </div>
                            <div class="rank-item" style="border-color: rgba(0,212,255,0.3);">
                                <span class="rank-item-name" style="color: var(--accent-blue);">Junior</span>
                                <span class="rank-item-pts">15,000 pts récord · 5 partidas jugadas</span>
                            </div>
                            <div class="rank-item" style="border-color: rgba(255,42,95,0.3);">
                                <span class="rank-item-name" style="color: var(--accent-red);">Pro</span>
                                <span class="rank-item-pts">60,000 pts acum. · 200 aciertos · Racha de 12</span>
                            </div>
                            <div class="rank-item" style="border-color: rgba(181,23,158,0.3);">
                                <span class="rank-item-name" style="color: var(--accent-purple);">Maestro</span>
                                <span class="rank-item-pts">150,000 pts acum. · 50 partidas · Mult. x4</span>
                            </div>
                            <div class="rank-item" style="border-color: rgba(255,184,0,0.3); background: rgba(255,184,0,0.04);">
                                <span class="rank-item-name" style="color: var(--accent-yellow);">Leyenda</span>
                                <span class="rank-item-pts">400,000 pts acum. · 1,500 aciertos · 10 partidas largas</span>
                            </div>
                        </div>
                        <!-- Rangos de Podio Leyenda -->
                        <div style="margin-top:18px;width:100%;border-top:1px solid rgba(255,184,0,0.25);padding-top:15px;">
                            <div style="font-size:0.7rem;font-weight:800;color:var(--accent-yellow);text-transform:uppercase;letter-spacing:2px;margin-bottom:12px;text-align:center;">Rangos Exclusivos de Podio — Solo Top 3 + Leyenda</div>
                            <div style="font-size:0.78rem;color:var(--text-secondary);line-height:1.5;margin-bottom:12px;text-align:center;">Estos títulos <strong style="color:var(--text-primary);">solo existen para los 3 primeros del ranking global</strong> que, además, ya tengan el rango <strong style="color:var(--accent-yellow);">Leyenda</strong>. Si dejas el podio o pierdes el rango Leyenda, el título desaparece. Son los únicos rangos del juego que no se obtienen por progreso individual sino por posición en el ranking.</div>
                            <div class="rank-list" style="gap:8px;">
                                <div class="rank-item" style="border-color:rgba(224,64,251,0.5);background:rgba(224,64,251,0.06);flex:1 1 30%;position:relative;">
                                    <span class="rank-item-name" style="color:#e040fb;font-size:1rem;">Rey Klick</span>
                                    <span class="rank-item-pts" style="color:rgba(224,64,251,0.7);">Leyenda + 1.º del Ranking</span>
                                </div>
                                <div class="rank-item" style="border-color:rgba(0,229,255,0.5);background:rgba(0,229,255,0.05);flex:1 1 30%;">
                                    <span class="rank-item-name" style="color:#00e5ff;font-size:0.95rem;">Señor Klick</span>
                                    <span class="rank-item-pts" style="color:rgba(0,229,255,0.7);">Leyenda + 2.º del Ranking</span>
                                </div>
                                <div class="rank-item" style="border-color:rgba(105,255,71,0.5);background:rgba(105,255,71,0.05);flex:1 1 30%;">
                                    <span class="rank-item-name" style="color:#69ff47;font-size:0.95rem;">Caballero Klick</span>
                                    <span class="rank-item-pts" style="color:rgba(105,255,71,0.7);">Leyenda + 3.º del Ranking</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Logros -->
                    <div class="guide-card glass-panel" style="border-color: rgba(255,255,255,0.1);">
                        <svg class="guide-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-secondary);"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                        <div class="guide-title">Banco de Logros</div>
                        <div class="guide-text">Hay <strong>248 logros</strong> para desbloquear. Algunos son escalables (por jugar más), otros son únicos y secretos. Puedes <strong>fijar hasta 3 logros</strong> en tu perfil. ¡Descúbrelos explorando todas las secciones del juego!</div>
                    </div>

                    <!-- Power Level / Ranking -->
                    <div class="guide-card glass-panel" style="border-color: rgba(255,255,255,0.1);">
                        <svg class="guide-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-secondary);"><rect x="18" y="3" width="4" height="18"/><rect x="10" y="8" width="4" height="13"/><rect x="2" y="13" width="4" height="8"/></svg>
                        <div class="guide-title">Clasificación Global</div>
                        <div class="guide-text">La clasificación usa tu <strong>Nivel de Poder (PL)</strong>, calculado a partir de tu récord, racha máxima, partidas perfectas, logros y precisión. Compite con jugadores del mundo en <strong>tiempo real</strong>.</div>
                    </div>

                    <!-- LO QUE NO DEBES HACER -->
                    <div class="guide-card full-width glass-panel" style="border-color: rgba(255,255,255,0.1);">
                        <svg class="guide-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-secondary);"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                        <div class="guide-title">Lo que NO debes hacer</div>
                        <div class="guide-text" style="text-align:left;line-height:1.7;">
                            <strong>Tu cuenta puede ser penalizada o marcada permanentemente si:</strong><br><br>
                            — <strong>Cambias de pestaña o minimizas</strong> la ventana durante una partida activa — el sistema detecta la trampa, aplica penalizaciones de puntos, racha y partidas perfectas, y te marca con el logro <em>TRAMPOSO</em> imborrable.<br>
                            — <strong>Abandonas una partida</strong> a mitad — recibes una penalidad de <strong>-300 pts</strong> en tu puntaje acumulado.<br>
                            — <strong>No responder a tiempo</strong> (dejar el reloj llegar a cero) te quita <strong>una vida</strong> exactamente igual que una respuesta incorrecta.<br>
                            — <strong>Perder las 3 vidas</strong> termina la partida inmediatamente — no hay forma de recuperarlas en la misma ronda.<br>
                            — <strong>Un fallo durante una racha</strong> reinicia el multiplicador completamente a x1 y desactiva el Modo Frenesí.<br><br>
                            <strong>Nota:</strong> La marca de TRAMPOSO aparece fijada en tu perfil de forma permanente y no puede quitarse ni ocultarse.<br><br>
                            <strong>Advertencia:</strong> Si borras el historial del navegador o limpias los datos del sitio, <strong>perderás tu cuenta, puntajes, logros y progreso permanentemente</strong>. El juego guarda todos los datos en el almacenamiento local del navegador.
                        </div>
                    </div>



                </div>
            </div>
        </div>
    </div>


    <div id="achievements-screen" class="screen nav-screen">
        <div class="top-nav">
            <button class="btn-back" onclick="goToMainMenu()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg><span>Regresar</span></button>
            <div class="nav-title">LOGROS</div><div class="nav-spacer"></div>
        </div>
        <div class="achievements-stats" id="achievements-progress-text" style="text-align:center;color:var(--text-secondary);font-weight:600;font-size:1rem;letter-spacing:1px;padding:12px 0 8px;flex-shrink:0;">Desbloqueados: 0 / 247</div>
        <!-- Virtual scroller: solo se renderizan las tarjetas visibles -->
        <div id="vscroll-container" style="flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;position:relative;">
            <div id="vscroll-spacer" style="position:relative;width:100%;">
                <div id="vscroll-content" style="position:absolute;left:0;right:0;top:0;padding:0 15px 40px;"></div>
            </div>
        </div>
    </div>

    <div id="countdown-screen" class="screen">
        <div style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:15px;">
            <div id="countdown-number" style="font-size:clamp(8rem,25vw,14rem);font-weight:900;color:var(--rank-color);text-shadow:0 0 40px rgba(var(--rank-rgb),0.5);transition:all 0.3s var(--ease-spring);line-height:1;"></div>
            <div id="countdown-label" style="font-size:clamp(0.8rem,2vw,1.1rem);font-weight:700;letter-spacing:4px;color:var(--text-secondary);text-transform:uppercase;"></div>
        </div>
    </div>

    <div id="question-screen" class="screen">
        <div class="top-bar">
            <div>
                <button class="btn-abandon" onclick="abandonGame()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Salir
                </button>
            </div>
            <div>
                <div id="player-name-display">JUGADOR</div>
                <div id="lives-container">
                    </div>
            </div>
            <div>
                <div id="multiplier-badge" class="multiplier-badge">x1</div>
                <div class="score-badge" id="score-display">0</div>
            </div>
        </div>
        <div class="question-container">
            <div class="timer-wrapper">
                <svg class="timer-svg" viewBox="0 0 100 100"><circle class="timer-bg" cx="50" cy="50" r="45"></circle><circle class="timer-path" id="timer-path" cx="50" cy="50" r="45"></circle></svg>
                <div class="timer-text" id="timer-display">20</div>
            </div>
            <div class="question-text" id="question-text">Cargando...</div>
        </div>
        <div class="answers-grid" id="answers-grid">
            <button class="answer-btn color-red ans-delay-1" onclick="selectAnswer(0)"><svg class="shape-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 22 20 2 20"></polygon></svg><span id="ans-0">Opción 1</span></button>
            <button class="answer-btn color-blue ans-delay-2" onclick="selectAnswer(1)"><svg class="shape-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 22 12 12 22 2 12"></polygon></svg><span id="ans-1">Opción 2</span></button>
            <button class="answer-btn color-yellow ans-delay-3" onclick="selectAnswer(2)"><svg class="shape-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle></svg><span id="ans-2">Opción 3</span></button>
            <button class="answer-btn color-green ans-delay-4" onclick="selectAnswer(3)"><svg class="shape-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="3" ry="3"></rect></svg><span id="ans-3">Opción 4</span></button>
        </div>
        <div class="progress-bar-container" id="progress-container"><div class="progress-bar" id="global-progress"></div></div>
    </div>

    <div id="feedback-screen" class="screen">
        <div class="feedback-content">
            <div id="feedback-icon-container"></div>
            <div class="feedback-title" id="feedback-title">Correcto</div>
            <div class="feedback-points" id="feedback-points">+850</div>
            <div class="streak-box">Racha <span id="streak-display">1</span></div>
        </div>
    </div>

    <div id="end-screen" class="screen">
        <div class="end-fullscreen" id="end-glass-panel">
            <div class="end-rank-label" id="end-rank-label">Resultado</div>
            <div class="end-message" id="final-message">Buen Desempeño</div>
            <div class="end-name" id="final-name">JUGADOR</div>
            <div class="end-score-value" id="final-score-display">0</div>
            <div class="end-score-label">Puntos</div>
            <div class="end-stats-grid">
                <div class="end-stat"><span class="end-stat-val" id="final-correct">0</span><span class="end-stat-label" id="final-correct-label">Aciertos</span></div>
                <div class="end-stat"><span class="end-stat-val" id="final-streak">0</span><span class="end-stat-label">Racha Max</span></div>
                <div class="end-stat"><span class="end-stat-val" id="final-speed">0</span><span class="end-stat-label">Rapidas</span></div>
            </div>
            <div class="end-actions">
                <button class="btn-end-menu" onclick="goToMainMenu()">Menu</button>
                <button class="btn-end-replay" onclick="replayGame()">Jugar de Nuevo</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- SISTEMAS DE PROTECCIÓN ANTI-TRAMPAS ---
    document.addEventListener('contextmenu', e => e.preventDefault());

    document.addEventListener('keydown', e => {
        if (e.keyCode === 123 || 
            (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || 
            (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 67 || e.keyCode === 83 || e.keyCode === 80))) { 
            e.preventDefault();
            return false;
        }
    });

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'hidden' && isAnsweringAllowed && !isGamePaused) punishCheater();
    });
    window.addEventListener("blur", () => {
        if (isAnsweringAllowed && !isGamePaused) punishCheater();
    });

    function punishCheater() {
        if(!isAnsweringAllowed || isGamePaused) return;
        isAnsweringAllowed = false;
        clearInterval(timerInterval);
        
        const penalty = 2000; 
        playerStats.totalScore = Math.max(0, playerStats.totalScore - penalty);
        playerStats.bestScore = Math.max(0, playerStats.bestScore - penalty);
        playerStats.maxStreak = Math.max(0, playerStats.maxStreak - 5);
        playerStats.perfectGames = Math.max(0, playerStats.perfectGames - 1);
        
        // --- LOGRO OCULTO TRAMPOSO ---
        if (!playerStats.achievements.includes('tramposo')) {
            playerStats.achievements.push('tramposo');
        }

        saveStatsLocally();
        submitLeaderboard(); 
        
        initAudio(); SFX.incorrect();
        showToast('Trampa Detectada', `Has recibido la marca permanente de TRAMPOSO.`, 'var(--accent-red)', SVG_SKULL);
        
        document.getElementById('app').classList.remove('streak-active');
        streak = 0;
        switchScreen('start-screen');
    }

    // --- GENERACIÓN DE UUID ---
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // --- SVGs ---
    const SVG_CORRECT = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
    const SVG_INCORRECT = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
    const SVG_TIMEOUT = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
    const SVG_LOCK = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;
    const SVG_TROPHY = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline><circle cx="12" cy="8" r="7"></circle></svg>`;
    const SVG_USER = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`;
    const SVG_STAR = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
    const SVG_PIN = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>`;
    const SVG_TARGET = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`;
    const SVG_FIRE = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"></path></svg>`;
    const SVG_BOLT = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`;
    const SVG_CLOCK = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
    const SVG_SKULL = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="12" r="1"></circle><circle cx="15" cy="12" r="1"></circle><path d="M8 20v2h8v-2"></path><path d="M12.5 17l-.5-1-.5 1h1z"></path><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"></path></svg>`;
    const SVG_HEART = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
    const SVG_SHIELD = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`;

    // --- Stats y Logros (Persistencia Absoluta) ---
    const defaultStats = {
        uuid: generateUUID(),
        playerName: "JUGADOR", gamesPlayed: 0, bestScore: 0, maxStreak: 0, achievements: [], pinnedAchievements: [],
        nameChanges: 0, achViews: 0, guideViews: 0, totalScore: 0, perfectGames: 0, totalCorrect: 0, totalWrong: 0, 
        totalTimeouts: 0, fastAnswersTotal: 0, frenziesTriggered: 0, lastLoginDate: "", currentLoginStreak: 0, 
        maxLoginStreak: 0, todayGames: 0, maxScoreCount: 0, perfectStreak: 0, previousGameScore: -1,
        musicVol: 1.0, sfxVol: 1.0, particleOpacity: 1.0, maxFps: 60,
        rankingViews: 0, configViews: 0, fpsChanges: 0, allSectionsVisited: false,
        sectionsVisitedThisSession: [], rankingPosition: 999,
        musicSetTo0: false, sfxSetTo0: false, particles0: false,
        powerLevel: 0, maxMult: 1, maxQuestionReached: 0, totalDaysPlayed: 0,
        profileViewedAfterGames: 0, guideViewedBeforeGame: false,
        selectedTrack: 'track_chill', trackSwitches: 0, tracksTriedSet: [], triedAllTracks: false,
        sameTrackGames: 0, lastGameTrack: ''
    };
    
    const STORAGE_KEY = 'klick_player_data_permanent';
    let savedData = localStorage.getItem(STORAGE_KEY) || localStorage.getItem('klickStats_v9') || '{}';
    let playerStats = { ...defaultStats, ...JSON.parse(savedData) };
    
    if(!playerStats.uuid) playerStats.uuid = generateUUID();

    // ── MIGRACIÓN v2: retira logros que el jugador no ha ganado realmente ──
    // Se ejecuta UNA vez por perfil (marca con migratedV2=true al terminar).
    // Compara stats reales contra los nuevos umbrales del modo infinito y
    // elimina del array achievements cualquier id que ya no se cumpla.
    (function migrateAchievementsV2() {
        if (playerStats.migratedV2) {
            // ── Migración v2b: revoca fin1/fin2 si se ganaron sin el flag real ──
            if (!playerStats.migratedV2b) {
                const toRevoke2b = [];
                if (playerStats.achievements.includes('fin1') && !playerStats.playedNocturno) toRevoke2b.push('fin1');
                if (playerStats.achievements.includes('fin2') && !playerStats.playedMadrugador) toRevoke2b.push('fin2');
                if (toRevoke2b.length > 0) {
                    playerStats.achievements = playerStats.achievements.filter(id => !toRevoke2b.includes(id));
                    playerStats.pinnedAchievements = playerStats.pinnedAchievements.filter(id => !toRevoke2b.includes(id));
                }
                playerStats.migratedV2b = true;
                saveStatsLocally();
            }
            return;
        }

        const bs  = playerStats.bestScore    || 0;
        const tot = playerStats.totalScore   || 0;
        const msc = playerStats.maxScoreCount|| 0; // ahora umbral 100k
        const pf  = playerStats.maxQuestionReached || 0;
        const sk  = playerStats.maxStreak    || 0;

        // Umbrales NUEVOS indexados por id de logro
        const newBsTiers  = [5000,25000,75000,150000,300000,600000,1000000,2000000];
        const newPtsTiers = [10000,50000,200000,500000,1000000,2500000,5000000,10000000];
        const newPfTiers  = [10,20,30,50,75,100,150,200];
        const newSkTiers  = [5,10,15,20,25,30,40,50];
        // hs ahora requiere superar 100k por partida; maxScoreCount se recalcula
        // → cualquier hs ganado con el umbral de 20k se revoca salvo que
        //   playerStats.maxScore sea ≥ 100k (al menos 1 partida lo cumple).
        //   Para los de conteo múltiple no podemos saber cuántas veces,
        //   así que revocamos todo hs y dejamos que checkAchievements los reotorgue.
        const newHsCountTiers = [1,3,5,10,20,35,50,100];

        const toRevoke = [];

        // bs1-bs8
        for(let i=0;i<8;i++) if(bs < newBsTiers[i]) toRevoke.push(`bs${i+1}`);
        // pt1-pt8
        for(let i=0;i<8;i++) if(tot < newPtsTiers[i]) toRevoke.push(`pt${i+1}`);
        // hs1-hs8: revocamos todos; checkAchievements reotorgará los que correspondan
        // usando el nuevo maxScoreCount (que aún puede estar inflado por el umbral viejo
        // de 20k → no podemos confiar en él; lo reseteamos si bestScore < 100k)
        if(bs < 100000) {
            // Nunca superó 100k → maxScoreCount inflado con 20k, lo limpiamos
            playerStats.maxScoreCount = 0;
            for(let i=0;i<8;i++) toRevoke.push(`hs${i+1}`);
        }
        // Si bestScore >= 100k, sabemos que al menos hs1 es válido pero no cuántos.
        // Lo más justo: dejamos maxScoreCount en 1 mínimo y revocamos hs2+.
        else {
            playerStats.maxScoreCount = Math.max(1, playerStats.maxScoreCount);
            for(let i=1;i<8;i++) toRevoke.push(`hs${i+1}`); // revoca hs2..hs8
        }
        // pf1-pf8
        for(let i=0;i<8;i++) if(pf < newPfTiers[i]) toRevoke.push(`pf${i+1}`);
        // sk1-sk8
        for(let i=0;i<8;i++) if(sk < newSkTiers[i]) toRevoke.push(`sk${i+1}`);

        // x4: ahora requiere 75k dos veces seguidas — no podemos verificar
        //     el histórico de partidas, revocamos si bestScore < 75k
        if(bs < 75000) toRevoke.push('x4');
        // x6: consistente ahora es 25k x5 partidas — revocamos si bestScore < 25k
        if(bs < 25000) toRevoke.push('x6');
        // x7: 3k primera pregunta — si bestScore < 3k (imposible tenerlo en realidad)
        if(bs < 3000) toRevoke.push('x7');
        // x12: 50k primera partida del día — revocamos si bestScore < 50k
        if(bs < 50000) toRevoke.push('x12');
        // x15: exactamente 100k ±500 — revocamos si bestScore < 99500
        if(bs < 99500) toRevoke.push('x15');

        if(toRevoke.length > 0) {
            playerStats.achievements = playerStats.achievements.filter(id => !toRevoke.includes(id));
            playerStats.pinnedAchievements = playerStats.pinnedAchievements.filter(id => !toRevoke.includes(id));
        }

        // También revoca fin1/fin2 si se ganaron sin el flag real (bug del check de hora en checkAchievements)
        const toRevokeFin = [];
        if (playerStats.achievements.includes('fin1') && !playerStats.playedNocturno) toRevokeFin.push('fin1');
        if (playerStats.achievements.includes('fin2') && !playerStats.playedMadrugador) toRevokeFin.push('fin2');
        if (toRevokeFin.length > 0) {
            playerStats.achievements = playerStats.achievements.filter(id => !toRevokeFin.includes(id));
            playerStats.pinnedAchievements = playerStats.pinnedAchievements.filter(id => !toRevokeFin.includes(id));
        }

        playerStats.migratedV2 = true;
        playerStats.migratedV2b = true; // mark v2b done too since we handled it here
        saveStatsLocally();
    })();

    // ── MIGRACIÓN tracks: remapea IDs de pistas viejas ──
    (function migrateTrackIds() {
        const remap = { 'track_electro': 'track_pulse', 'track_frenzy': 'track_bass' };
        if (remap[playerStats.selectedTrack]) {
            playerStats.selectedTrack = remap[playerStats.selectedTrack];
        }
        if (playerStats.tracksTriedSet) {
            playerStats.tracksTriedSet = playerStats.tracksTriedSet.map(id => remap[id] || id);
        }
    })();

    function saveStatsLocally() { 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(playerStats)); 
    }
    // Versión debounced para guardados frecuentes durante gameplay (no bloquea el hilo principal)
    let _saveTimeout = null;
    function saveStatsDebounced() {
        clearTimeout(_saveTimeout);
        _saveTimeout = setTimeout(saveStatsLocally, 800);
    }

    // ── Revoca logros obtenidos por bugs/errores de lógica ──────────────────────
    // Función pública: puede llamarse en cualquier momento para limpiar logros inválidos.
    function revokeInvalidAchievements() {
        const before = playerStats.achievements.length;
        const toRevoke = new Set();

        // fin1 (Nocturno): solo válido si se jugó en ese horario (flag real)
        if (!playerStats.playedNocturno && playerStats.achievements.includes('fin1')) toRevoke.add('fin1');
        // fin2 (Madrugador): solo válido si se jugó antes de las 6am (flag real)
        if (!playerStats.playedMadrugador && playerStats.achievements.includes('fin2')) toRevoke.add('fin2');
        // ret1–ret5 (Fiel): solo válidos si totalDaysPlayed >= umbral (bug: split devolvía array)
        const retTiers = [3,7,15,30,60];
        retTiers.forEach((t,i) => { 
            if ((playerStats.totalDaysPlayed||0) < t && playerStats.achievements.includes(`ret${i+1}`)) toRevoke.add(`ret${i+1}`); 
        });
        // bs1–bs8: requieren bestScore real
        const bsTiers2 = [5000,25000,75000,150000,300000,600000,1000000,2000000];
        bsTiers2.forEach((t,i) => { 
            if ((playerStats.bestScore||0) < t && playerStats.achievements.includes(`bs${i+1}`)) toRevoke.add(`bs${i+1}`);
        });
        // hs1–hs8: requieren haber superado 100k, no 20k
        if ((playerStats.bestScore||0) < 100000) {
            for(let i=0;i<8;i++) { if(playerStats.achievements.includes(`hs${i+1}`)) toRevoke.add(`hs${i+1}`); }
        }
        // x1 (Primer Día): siempre válido si hay datos (no revocar)
        // x18 (El Clásico): solo válido si nameChanges===0 y maxLoginStreak>=30
        if (!( playerStats.nameChanges===0 && (playerStats.maxLoginStreak||0)>=30 ) && playerStats.achievements.includes('x18')) toRevoke.add('x18');

        if (toRevoke.size > 0) {
            playerStats.achievements = playerStats.achievements.filter(id => !toRevoke.has(id));
            playerStats.pinnedAchievements = playerStats.pinnedAchievements.filter(id => !toRevoke.has(id));
            saveStatsLocally();
            const revokedCount = before - playerStats.achievements.length;
            if (revokedCount > 0) {
                showToast('Logros Corregidos', `Se retiraron ${revokedCount} logro(s) obtenido(s) por errores.`, 'var(--accent-orange)', SVG_SHIELD);
                renderAchievements();
            }
        }
        return toRevoke.size;
    }

    window.addEventListener('beforeunload', () => {
        saveStatsLocally();
    });

    // --- Audio y Reactividad Musical ---
    // ── AUDIO ENGINE (Web Audio API – lookahead scheduler) ──────────────────
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    let masterMusicGain, masterSFXGain, masterLimiter, audioAnalyser, audioDataArray;
    let isMusicPlaying = false, musicSeqStep = 0, nextNoteTime = 0, musicTimerID = null;
    let chordIndex = 0;
    // Lookahead and schedule interval (seconds / ms) – tight for accuracy
    const SCHED_AHEAD = 0.12;   // schedule this far ahead
    const SCHED_INTERVAL = 25;  // scheduler polling interval ms

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new AudioContext();
            // Master music gain (lower so it doesn't overpower SFX)
            masterMusicGain = audioCtx.createGain();
            masterMusicGain.gain.value = playerStats.musicVol * 0.55;
            // Master SFX gain
            masterSFXGain = audioCtx.createGain();
            masterSFXGain.gain.value = playerStats.sfxVol;
            // Limiter/compressor to avoid clipping
            masterLimiter = audioCtx.createDynamicsCompressor();
            masterLimiter.threshold.value = -3;
            masterLimiter.knee.value = 3;
            masterLimiter.ratio.value = 12;
            masterLimiter.attack.value = 0.001;
            masterLimiter.release.value = 0.1;
            // Analyser for visuals
            audioAnalyser = audioCtx.createAnalyser();
            audioAnalyser.fftSize = 64;
            audioDataArray = new Uint8Array(audioAnalyser.frequencyBinCount);
            // Routing: music -> analyser -> limiter -> out
            //          sfx             -> limiter -> out
            masterMusicGain.connect(audioAnalyser);
            audioAnalyser.connect(masterLimiter);
            masterSFXGain.connect(masterLimiter);
            masterLimiter.connect(audioCtx.destination);
            startMusicEngine();
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function updateVolumes() {
        if (!audioCtx) return;
        const t = audioCtx.currentTime;
        if (masterMusicGain) masterMusicGain.gain.setTargetAtTime(playerStats.musicVol * 0.55, t, 0.05);
        if (masterSFXGain)   masterSFXGain.gain.setTargetAtTime(playerStats.sfxVol, t, 0.05);
    }

    let currentAudioPulse = 0;
    let smoothedPulse = 0;
    function getAudioPulse() {
        if (!audioAnalyser) return 0;
        audioAnalyser.getByteFrequencyData(audioDataArray);
        let sum = 0;
        for (let i = 0; i < 4; i++) sum += audioDataArray[i];
        const rawPulse = sum / (4 * 255);
        // Smooth the pulse with lerp to avoid sudden jumps
        smoothedPulse += (rawPulse - smoothedPulse) * 0.15;
        currentAudioPulse = smoothedPulse;
        return currentAudioPulse;
    }

    // Schedule a single oscillator note at an exact AudioContext time
    function schedNote(freq, type, startTime, duration, vol, dest) {
        const osc  = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, startTime);
        gain.gain.setValueAtTime(0.0001, startTime);
        gain.gain.linearRampToValueAtTime(vol, startTime + 0.005);
        gain.gain.exponentialRampToValueAtTime(0.0001, startTime + duration);
        osc.connect(gain);
        gain.connect(dest || masterSFXGain);
        osc.start(startTime);
        osc.stop(startTime + duration + 0.01);
    }

    // Play an SFX: array of [freq, type, offsetSec, duration, vol]
    function playSFX(notes) {
        if (!audioCtx || playerStats.sfxVol === 0) return;
        const now = audioCtx.currentTime + 0.01;  // tiny buffer to avoid scheduling in past
        notes.forEach(([freq, type, offset, duration, vol]) => {
            schedNote(freq, type, now + offset, duration, vol * playerStats.sfxVol);
        });
    }

    // Noise burst for music (scheduled to exact time)
    function playNoiseAt(time, duration, vol, cutoff = 5000) {
        if (!audioCtx) return;
        const sr = audioCtx.sampleRate;
        const buf = audioCtx.createBuffer(1, Math.ceil(sr * duration), sr);
        const d = buf.getChannelData(0);
        for (let i = 0; i < d.length; i++) d[i] = Math.random() * 2 - 1;
        const src    = audioCtx.createBufferSource();
        const gain   = audioCtx.createGain();
        const filter = audioCtx.createBiquadFilter();
        src.buffer = buf;
        filter.type = 'highpass';
        filter.frequency.value = cutoff;
        gain.gain.setValueAtTime(vol, time);
        gain.gain.exponentialRampToValueAtTime(0.0001, time + duration);
        src.connect(filter);
        filter.connect(gain);
        gain.connect(masterMusicGain);
        src.start(time);
    }

    // ── TRACK SELECTION SYSTEM ───────────────────────────────────────────────
    const MUSIC_TRACKS = [
        {
            id: 'track_chill',
            name: 'Neon Chill',
            desc: 'Ambiental · Suave',
            color: 'var(--accent-blue)'
        },
        {
            id: 'track_pulse',
            name: 'Soft Glow',
            desc: 'Melódico · Agradable',
            color: 'var(--accent-green)'
        },
        {
            id: 'track_bass',
            name: 'Deep Current',
            desc: 'Bass · Groovey',
            color: 'var(--accent-purple)'
        }
    ];

    function renderTrackSelector() {
        const container = document.getElementById('track-selector');
        if (!container) return;
        const currentTrack = playerStats.selectedTrack || 'track_chill';
        container.innerHTML = MUSIC_TRACKS.map(t => {
            const isSelected = t.id === currentTrack;
            return `
            <div onclick="selectTrack('${t.id}')" style="
                flex:1;min-width:120px;padding:12px 15px;border-radius:var(--radius-md);
                border:1.5px solid ${isSelected ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.1)'};
                background:${isSelected ? 'rgba(255,255,255,0.07)' : 'transparent'};
                cursor:pointer;text-align:center;transition:all 0.25s;
                box-shadow:${isSelected ? '0 0 15px rgba(255,255,255,0.08)' : 'none'};
            ">
                <div style="font-size:0.8rem;font-weight:800;color:${isSelected ? 'var(--text-primary)' : 'var(--text-secondary)'};text-transform:uppercase;letter-spacing:1px;">${t.name}</div>
                <div style="font-size:0.65rem;color:var(--text-secondary);margin-top:3px;">${t.desc}</div>
            </div>
        `}).join('');
    }

    function selectTrack(trackId) {
        if (!audioCtx) initAudio();
        SFX.click();
        const prev = playerStats.selectedTrack || 'track_chill';
        playerStats.selectedTrack = trackId;
        saveStatsLocally();
        renderTrackSelector();
        // Track changed achievement
        if (prev !== trackId) {
            playerStats.trackSwitches = (playerStats.trackSwitches || 0) + 1;
            const trackIds = MUSIC_TRACKS.map(t => t.id);
            if (!playerStats.tracksTriedSet) playerStats.tracksTriedSet = [];
            if (!playerStats.tracksTriedSet.includes(trackId)) {
                playerStats.tracksTriedSet.push(trackId);
            }
            if (playerStats.tracksTriedSet.length >= 3) {
                playerStats.triedAllTracks = true;
            }
            checkAchievements();
        }
        // Restart music engine with new track
        if (isMusicPlaying && audioCtx) {
            stopMusicEngine();
            startMusicEngine();
        }
    }

    function stopMusicEngine() {
        isMusicPlaying = false;
        clearTimeout(musicTimerID);
        musicSeqStep = 0;
        chordIndex = 0;
    }

    // Track-specific music definitions
    const TRACK_CONFIGS = {
        // NEON CHILL: slow ambient, sine waves only, pads, no percussion aggression
        track_chill: {
            bpmBase: 88, bpmFrenzy: 104,
            CHORD_PROG: [[57,62,65,69],[60,65,67,72],[62,65,69,74],[55,60,62,67]],
            ARP_PAT: [0,2,1,3,0,1,2,0,3,1,0,2,1,3,2,0],
            arpType: 'sine', bassType: 'sine', kickFreq: 80,
            kickVol: 0.3, bassVol: 0.2, arpVol: 0.18,
            hasPad: true, hasHihat: false
        },
        // SOFT GLOW: dreamy bell-chime, pentatonic, no kick/bass/pad, high register, waltz feel
        // Uses arpType 'sine' for bell tone, no percussion at all, very different from chill & bass
        track_pulse: {
            bpmBase: 78, bpmFrenzy: 96,
            CHORD_PROG: [[72,76,79,83],[74,77,81,84],[69,72,76,81],[71,74,78,83]],
            ARP_PAT: [2,0,3,1,2,3,0,2,1,3,0,1,3,2,0,1],
            arpType: 'sine', bassType: 'sine', kickFreq: 0,
            kickVol: 0, bassVol: 0, arpVol: 0.28,
            hasPad: false, hasHihat: false, hasBells: true, noKick: true, noBass: true
        },
        // DEEP CURRENT: slow to mid, sawtooth bass dominant, sparse melody, groovey feel
        track_bass: {
            bpmBase: 98, bpmFrenzy: 118,
            CHORD_PROG: [[48,55,60,67],[50,57,62,69],[52,55,59,64],[46,53,58,65]],
            ARP_PAT: [1,0,2,0,3,0,1,2,0,3,1,0,2,0,3,1],
            arpType: 'triangle', bassType: 'sawtooth', kickFreq: 55,
            kickVol: 0.7, bassVol: 0.55, arpVol: 0.15,
            hasPad: false, hasHihat: false, hasWobble: true
        }
    };

    function getActiveTrack() {
        return TRACK_CONFIGS[playerStats.selectedTrack || 'track_chill'] || TRACK_CONFIGS.track_chill;
    }

    function startMusicEngine() {
        isMusicPlaying = true;
        musicSeqStep = 0;
        chordIndex = 0;
        nextNoteTime = audioCtx.currentTime + 0.05;
        schedulerTick();
    }

    function schedulerTick() {
        if (!isMusicPlaying || !audioCtx) return;
        while (nextNoteTime < audioCtx.currentTime + SCHED_AHEAD) {
            playMusicStep(nextNoteTime);
            advanceMusicStep();
        }
        musicTimerID = setTimeout(schedulerTick, SCHED_INTERVAL);
    }

    function advanceMusicStep() {
        const tc = getActiveTrack();
        const bpm = (typeof streak !== 'undefined' && streak >= 5) ? tc.bpmFrenzy : tc.bpmBase;
        nextNoteTime += 60.0 / bpm / 4;
        musicSeqStep++;
        if (musicSeqStep >= 16) { musicSeqStep = 0; chordIndex = (chordIndex + 1) % 4; }
    }

    const midiToHz = m => 440 * Math.pow(2, (m - 69) / 12);

    function playMusicStep(t) {
        const isFrenzy = (typeof streak !== 'undefined' && streak >= 5);
        const tc = getActiveTrack();
        const chord = tc.CHORD_PROG[chordIndex];
        const step  = musicSeqStep;

        // Kick (every 4 steps) — skip if noKick
        if (!tc.noKick && step % 4 === 0) {
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.type = 'sine';
            o.frequency.setValueAtTime(tc.kickFreq, t);
            o.frequency.exponentialRampToValueAtTime(0.01, t + 0.25);
            const kv = tc.kickVol || 0.7;
            g.gain.setValueAtTime(isFrenzy ? kv * 1.2 : kv, t);
            g.gain.exponentialRampToValueAtTime(0.0001, t + 0.28);
            o.connect(g); g.connect(masterMusicGain); o.start(t); o.stop(t + 0.3);
        }

        // Snare on beat 2 and 4 (for track_pulse only)
        if (tc.hasSnare && (step === 4 || step === 12)) {
            playNoiseAt(t, 0.25, 0.12, 3000);
            playNoiseAt(t, 0.18, 0.08, 8000);
        }

        // Bass (every 2 steps) — skip if noBass
        if (!tc.noBass && step % 2 === 0) {
            const o = audioCtx.createOscillator(), g = audioCtx.createGain(), f = audioCtx.createBiquadFilter();
            o.type = tc.bassType;
            o.frequency.setValueAtTime(midiToHz(chord[0] - 12), t);
            f.type = 'lowpass';
            const bv = tc.bassVol || 0.3;
            f.frequency.setValueAtTime(isFrenzy ? 900 : 400, t);
            f.frequency.exponentialRampToValueAtTime(80, t + 0.18);
            // Wobble for deep current track
            if (tc.hasWobble) {
                const lfo = audioCtx.createOscillator();
                const lfoGain = audioCtx.createGain();
                lfo.frequency.setValueAtTime(isFrenzy ? 6 : 3, t);
                lfoGain.gain.setValueAtTime(120, t);
                lfo.connect(lfoGain); lfoGain.connect(f.frequency);
                lfo.start(t); lfo.stop(t + 0.4);
            }
            g.gain.setValueAtTime(isFrenzy ? bv * 1.3 : bv, t);
            g.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);
            o.connect(f); f.connect(g); g.connect(masterMusicGain); o.start(t); o.stop(t + 0.2);
        }

        // Bells: for Soft Glow — two-tone bell with detuned overtone, only on even steps
        if (tc.hasBells && step % 2 === 0) {
            const noteMidi2 = chord[tc.ARP_PAT[(step + 4) % 16]] + 12;
            [noteMidi2, noteMidi2 + 7].forEach((m, idx) => {
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.type = 'sine';
                o.frequency.setValueAtTime(midiToHz(m), t);
                const bv2 = (idx === 0 ? 0.10 : 0.05) * (isFrenzy ? 1.3 : 1);
                g.gain.setValueAtTime(0.0001, t);
                g.gain.linearRampToValueAtTime(bv2, t + 0.01);
                g.gain.exponentialRampToValueAtTime(0.0001, t + 0.9);
                o.connect(g); g.connect(masterMusicGain); o.start(t); o.stop(t + 1.0);
            });
        }

        // Pad: sustained chord for chill track (every 16 steps = new chord)
        if (tc.hasPad && step === 0) {
            chord.forEach((note, i) => {
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.type = 'sine';
                o.frequency.setValueAtTime(midiToHz(note), t);
                const padV = 0.06;
                g.gain.setValueAtTime(0.0001, t);
                g.gain.linearRampToValueAtTime(padV, t + 0.3);
                g.gain.setValueAtTime(padV, t + 1.5);
                g.gain.linearRampToValueAtTime(0.0001, t + 2.2);
                o.connect(g); g.connect(masterMusicGain); o.start(t); o.stop(t + 2.4);
            });
        }

        // Arp melody (every step)
        const noteMidi = chord[tc.ARP_PAT[step]] + (isFrenzy ? 12 : 0);
        const arpDur   = tc.hasBells ? (isFrenzy ? 0.35 : 0.65) : (isFrenzy ? 0.12 : 0.22);
        const av = tc.arpVol || 0.25;
        {
            const o = audioCtx.createOscillator(), g = audioCtx.createGain(), f = audioCtx.createBiquadFilter();
            o.type = tc.arpType;
            o.frequency.setValueAtTime(midiToHz(noteMidi), t);
            f.type = 'lowpass';
            f.frequency.setValueAtTime(tc.hasBells ? 4000 : (isFrenzy ? 3000 : 1200), t);
            g.gain.setValueAtTime(0.0001, t);
            g.gain.linearRampToValueAtTime(av, t + (tc.hasBells ? 0.005 : 0.015));
            g.gain.exponentialRampToValueAtTime(0.0001, t + arpDur);
            o.connect(f); f.connect(g); g.connect(masterMusicGain); o.start(t); o.stop(t + arpDur + 0.01);
        }

        // Hi-hat: for pulse track (every step) and in frenzy for others
        if (tc.hasHihat) {
            if (step % 2 !== 0) playNoiseAt(t, 0.04, 0.08, 9000);
            if (step === 0 || step === 8) playNoiseAt(t, 0.1, 0.15, 5000);
        } else if (isFrenzy && !tc.hasBells) {
            if (step % 2 !== 0) playNoiseAt(t, 0.03, 0.12, 8000);
            if (step === 0 || step === 8) playNoiseAt(t, 0.08, 0.2, 2000);
        } else if (isFrenzy && tc.hasBells) {
            // In frenzy, add soft shimmer for bells track
            if (step % 4 === 0) playNoiseAt(t, 0.08, 0.04, 12000);
        }
    }

    // ── SFX definitions (all notes pre-scheduled via WebAudio clock) ─────────
    const SFX = {
        // UI click: short crisp high tick
        click:        () => playSFX([[1200, 'sine', 0, 0.06, 0.05]]),
        // Timer tick: metronome-like sharp square pulse
        tick:         () => playSFX([[880, 'square', 0, 0.03, 0.03]]),
        // Answer select: low-mid soft thud (selection confirmed)
        select:       () => playSFX([[220, 'sine', 0, 0.12, 0.06], [330, 'sine', 0.03, 0.08, 0.05]]),
        // Correct: ascending chime, bright and satisfying
        correct:      () => playSFX([[659, 'sine', 0, 0.14, 0.10], [988, 'sine', 0.07, 0.18, 0.10], [1319, 'sine', 0.14, 0.22, 0.09]]),
        // Incorrect: deep descending buzz — clearly negative
        incorrect:    () => playSFX([[160, 'sawtooth', 0, 0.18, 0.08], [110, 'sawtooth', 0.06, 0.22, 0.12]]),
        // Streak trigger: synth fanfare — rising 3 tones
        streakTrigger:() => playSFX([[523, 'triangle', 0, 0.12, 0.10], [784, 'triangle', 0.10, 0.15, 0.12], [1047, 'triangle', 0.22, 0.28, 0.13]]),
        // Achievement: sparkling arpeggiated run
        achievement:  () => playSFX([[1047, 'sine', 0, 0.10, 0.09], [1319, 'sine', 0.06, 0.12, 0.09], [1568, 'sine', 0.12, 0.15, 0.09], [2093, 'sine', 0.18, 0.30, 0.10]]),
        // Game start: punchy low impact + mid tone
        gameStart:    () => playSFX([[110, 'sine', 0, 0.25, 0.08], [440, 'triangle', 0.08, 0.20, 0.12], [660, 'sine', 0.20, 0.15, 0.11]]),
        // Game end: warm resolving chord
        gameEnd:      () => playSFX([[330, 'sine', 0, 0.18, 0.14], [415, 'sine', 0.10, 0.18, 0.14], [554, 'sine', 0.20, 0.22, 0.14]])
    };

    // --- UI Modal y Configuracion ---
    function openSettings() {
        initAudio(); SFX.click();
        playerStats.configViews = (playerStats.configViews||0) + 1;
        trackSectionVisit('settings');
        saveStatsLocally(); checkAchievements();
        document.getElementById('op-music').value = playerStats.musicVol; document.getElementById('op-sfx').value = playerStats.sfxVol; 
        document.getElementById('op-particles').value = playerStats.particleOpacity; 
        document.getElementById('op-fps').value = FPS_VALUES.indexOf(playerStats.maxFps) >= 0 ? FPS_VALUES.indexOf(playerStats.maxFps) : 2;
        document.getElementById('val-music').innerText = Math.round(playerStats.musicVol*100)+'%'; document.getElementById('val-sfx').innerText = Math.round(playerStats.sfxVol*100)+'%'; 
        document.getElementById('val-particles').innerText = Math.round(playerStats.particleOpacity*100)+'%'; document.getElementById('val-fps').innerText = playerStats.maxFps+' FPS';
        renderTrackSelector();
        switchScreen('settings-screen');
    }

    document.getElementById('op-music').addEventListener('input', (e) => { 
        playerStats.musicVol = parseFloat(e.target.value); 
        document.getElementById('val-music').innerText = Math.round(playerStats.musicVol*100)+'%'; 
        updateVolumes(); 
        if(playerStats.musicVol===0) { playerStats.musicSetTo0=true; checkAchievements(); }
        if(playerStats.musicVol>=1.0) { playerStats.musicAt100=true; checkAchievements(); }
        if(playerStats.musicVol>=1.0 && (playerStats.particleOpacity||1)>=1.0) { playerStats.particles100=true; checkAchievements(); }
        saveStatsLocally(); 
    });
    document.getElementById('op-sfx').addEventListener('input', (e) => { 
        playerStats.sfxVol = parseFloat(e.target.value); 
        document.getElementById('val-sfx').innerText = Math.round(playerStats.sfxVol*100)+'%'; 
        updateVolumes(); 
        if(playerStats.sfxVol===0) { playerStats.sfxSetTo0=true; checkAchievements(); }
        saveStatsLocally(); 
    });
    document.getElementById('op-particles').addEventListener('input', (e) => { 
        playerStats.particleOpacity = parseFloat(e.target.value); 
        document.getElementById('val-particles').innerText = Math.round(playerStats.particleOpacity*100)+'%'; 
        if(playerStats.particleOpacity===0) { playerStats.particles0=true; checkAchievements(); }
        if(playerStats.particleOpacity>=1.0) { playerStats.particles100=true; }
        if(playerStats.musicVol>=1.0 && playerStats.particleOpacity>=1.0) { playerStats.musicAt100=true; playerStats.particles100=true; checkAchievements(); }
        saveStatsLocally(); 
    });
    // unlock_cfg8 ya integrado en checkAchievements vía flags musicAt100 + particles100
    const FPS_VALUES = [15, 30, 60, 120, 240];
    document.getElementById('op-fps').addEventListener('input', (e) => { 
        playerStats.maxFps = FPS_VALUES[parseInt(e.target.value)]; 
        fpsInterval = 1000/playerStats.maxFps; 
        document.getElementById('val-fps').innerText = playerStats.maxFps+' FPS'; 
        playerStats.fpsChanges = (playerStats.fpsChanges||0)+1;
        checkAchievements();
        saveStatsLocally(); 
    });

    function showToast(title, message, color, icon) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div'); 
        toast.className = 'toast-item'; 
        toast.innerHTML = `<div class="toast-icon" style="color: ${color}">${icon}</div><div class="toast-text"><span class="toast-title" style="color:${color}">${title}</span><span class="toast-name">${message}</span></div>`;
        container.appendChild(toast); 
        setTimeout(() => toast.classList.add('show'), 50); 
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 3500);
    }

    // --- Módulo: Clasificación Global ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxbLrjL45NYaQsRaSlZJXHKlQj-1Qh4f-CPxz4KsOMpfMI4jwwYC1UrNpnm_-f6ISeCww/exec"; 
    
    function calculatePowerLevel(stats) {
        const base = stats.totalScore * 0.05; 
        const best = stats.bestScore * 1.5; 
        const streak = stats.maxStreak * 200;
        const perf = stats.perfectGames * 1000;
        const achs = stats.achievements.length * 300;
        const winRate = stats.gamesPlayed > 0 ? (stats.totalCorrect / (stats.gamesPlayed * 20)) * 5000 : 0;
        return Math.floor(base + best + streak + perf + achs + winRate);
    }

    async function submitLeaderboard() {
        if (!playerStats.playerName || playerStats.playerName === "JUGADOR" || GAS_URL === "URL_DE_TU_GOOGLE_APPS_SCRIPT_AQUI") return;
        playerStats.powerLevel = calculatePowerLevel(playerStats);
        const payload = {
            uuid: playerStats.uuid, name: playerStats.playerName, rankTitle: getRankInfo(playerStats).title,
            powerLevel: calculatePowerLevel(playerStats), totalScore: playerStats.totalScore, maxStreak: playerStats.maxStreak
        };

        try { await fetch(GAS_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(payload) });
        } catch(e) {}
    }

    async function fetchLeaderboard() {
        if(GAS_URL === "URL_DE_TU_GOOGLE_APPS_SCRIPT_AQUI") return;
        try {
            const res = await fetch(GAS_URL);
            const topPlayers = await res.json();
            
            let html = "";
            topPlayers.forEach((p, index) => {
                const pos = index + 1;
                const isMe = p.uuid === playerStats.uuid;
                if(isMe) { playerStats.rankingPosition = pos; saveStatsLocally(); checkAchievements(); }
                let classPos = pos <= 3 ? `pos-${pos}` : ``;
                if(isMe) classPos += " is-me";

                // Determine podium rank title (only if player is Leyenda AND in top 3)
                let rankTitle = p.rankTitle;
                const podiumTitles = { 1: 'Rey Klick', 2: 'Señor Klick', 3: 'Caballero Klick' };
                if (pos <= 3 && p.rankTitle === 'Leyenda') {
                    rankTitle = podiumTitles[pos];
                }
                // Color map: rank colors + distinctive podio colors (not repeating any rank color)
                const rankColorMap = { 
                    'Leyenda': 'var(--accent-yellow)', 
                    'Maestro': 'var(--accent-purple)', 
                    'Pro': 'var(--accent-red)', 
                    'Junior': 'var(--accent-blue)', 
                    'Novato': 'var(--accent-green)',
                    'Rey Klick':      '#e040fb',  // magenta vivid
                    'Señor Klick':    '#00e5ff',  // cyan eléctrico
                    'Caballero Klick':'#69ff47'   // lima neón
                };
                const titleColor = rankColorMap[rankTitle] || 'var(--text-secondary)';
                const scoreColor = rankColorMap[p.rankTitle] || 'var(--text-primary)';
                const displayName = isMe ? `<span style="color:var(--rank-color)">${p.name}</span>` : p.name;
                
                html += `
                <div class="rank-card ${classPos}">
                    <div class="rc-pos">${pos}</div>
                    <div class="rc-info">
                        <div class="rc-name">${displayName}</div>
                        <div class="rc-title" style="color:${titleColor}">${rankTitle}</div>
                    </div>
                    <div class="rc-score" style="color:${scoreColor}">${p.powerLevel.toLocaleString()} <span>PL</span></div>
                </div>`;
            });
            document.getElementById('ranking-list').innerHTML = html;
        } catch(e) {
            if(document.getElementById('ranking-list').innerHTML.includes('ranking-loading')) {
               document.getElementById('ranking-list').innerHTML = `<div class="ranking-loading">Error al conectar con la base de datos global. Reintentando...</div>`;
            }
        }
    }
    setInterval(() => { submitLeaderboard(); fetchLeaderboard(); }, 60000);

    // --- SISTEMA DE PREGUNTAS MASIVAS (JSON EXTERNO) ---
    let quizDataPool = [];
    async function loadQuestions() {
        try {
            const response = await fetch('preguntas.json');
            if (!response.ok) throw new Error('No se pudo cargar el archivo');
            quizDataPool = await response.json();
        } catch (error) {
            quizDataPool = [
                { "question": "ERROR: No se pudo cargar 'preguntas.json'. ¿Estás abriendo el HTML directamente (file://) en vez de usar un servidor local?", "answers": ["Sí, ese es el error", "Debo usar Live Server", "Falta el archivo JSON", "Todas las anteriores"], "correctIndex": 3 }
            ];
            while(quizDataPool.length < 20) {
                quizDataPool.push({ "question": "Por favor, carga el juego en un servidor web o súbelo a GitHub Pages para que el JSON funcione.", "answers": ["Entendido", "Ok", "Comprendo", "Solucionar"], "correctIndex": 0 });
            }
        }
    }

    // --- Data Logros ---
    const ACHIEVEMENTS_DATA = [];
    const colors = { blue: 'var(--accent-blue)', green: 'var(--accent-green)', yellow: 'var(--accent-yellow)', orange: 'var(--accent-orange)', red: 'var(--accent-red)', purple: 'var(--accent-purple)', dark: 'var(--text-secondary)' };
    
    const CHEATER_ACHIEVEMENT = { id: 'tramposo', title: 'TRAMPOSO', desc: 'Infringió las normas. Marca imborrable.', color: 'var(--accent-red)', icon: SVG_SKULL };

    function addAchs(arr) { arr.forEach(a => ACHIEVEMENTS_DATA.push(a)); }

    // --- META (10) ---
    addAchs([
        { id: 'm1',  title: 'Bautizado',      desc: 'Configura tu nombre de jugador por primera vez.',           color: colors.blue,   icon: SVG_USER },
        { id: 'm2',  title: 'Agente Secreto', desc: 'Cambia tu nombre de jugador 5 veces.',                     color: colors.purple, icon: SVG_USER },
        { id: 'm3',  title: 'Identidad Falsa',desc: 'Cambia tu nombre de jugador 20 veces.',                    color: colors.red,    icon: SVG_USER },
        { id: 'm4',  title: 'Curioso',         desc: 'Abre el Banco de Logros por primera vez.',                 color: colors.orange, icon: SVG_TROPHY },
        { id: 'm5',  title: 'Investigador',    desc: 'Visita el Banco de Logros 10 veces.',                      color: colors.blue,   icon: SVG_TROPHY },
        { id: 'm6',  title: 'Obsesivo',        desc: 'Visita el Banco de Logros 50 veces.',                      color: colors.purple, icon: SVG_TROPHY },
        { id: 'm7',  title: 'Diseñador',       desc: 'Fija tu primer logro en el perfil.',                       color: colors.yellow, icon: SVG_STAR },
        { id: 'm8',  title: 'Coleccionista',   desc: 'Desbloquea 10 logros en total.',                           color: colors.green,  icon: SVG_STAR },
        { id: 'm9',  title: 'Completista',     desc: 'Alcanza el hito de 50 logros desbloqueados.',              color: colors.orange, icon: SVG_STAR },
        { id: 'm10', title: 'Centenario',      desc: 'Consigue 100 logros desbloqueados.',                      color: colors.red,    icon: SVG_STAR },
    ]);

    // --- COLECCIÓN MAESTRA (4) ---
    addAchs([
        { id: 'master1', title: 'Casi Dios',    desc: 'Desbloquea 150 logros en total.',                        color: colors.yellow, icon: SVG_STAR },
        { id: 'master2', title: 'Semidivino',   desc: 'Desbloquea 200 logros en total.',                        color: colors.orange, icon: SVG_STAR },
        { id: 'master4', title: 'Leyenda Total',desc: 'Desbloquea 225 logros en total.',                        color: colors.purple, icon: SVG_STAR },
        { id: 'master3', title: 'Dios Klick',   desc: 'Consigue los 242 logros del juego. Eres absoluto.',      color: colors.red,    icon: SVG_STAR },
    ]);

    // --- DÍAS DE ACTIVIDAD (10) ---
    const daysTiers  = [1,2,3,5,7,15,21,30,60,90];
    const daysTitles = ['Hola Mundo','Doble','Triple','Cinco','Semana Activa','Quincena','Tres Semanas','Un Mes','Bimestre','Trimestre Fuego'];
    for(let i=0;i<5;i++) addAchs([{ id:`d${i+1}`, title:daysTitles[i], desc:`Inicia sesión durante ${daysTiers[i]} días consecutivos.`, color:colors.green, icon:SVG_CLOCK }]);
    for(let i=5;i<10;i++) addAchs([{ id:`d${i+1}`, title:daysTitles[i], desc:`Juega en ${daysTiers[i]} días distintos en total.`, color:colors.green, icon:SVG_CLOCK }]);

    // --- PARTIDAS JUGADAS (8) ---
    const ptTiers=[1,5,10,25,50,100,200,500];
    for(let i=0;i<8;i++) addAchs([{ id:`p${i+1}`, title:`Jugador ${i+1}`, desc:`Acumula ${ptTiers[i]} partidas jugadas.`, color:colors.blue, icon:SVG_TARGET }]);

    // --- PUNTOS TOTALES (8) ---
    const ptsTiers=[10000,50000,200000,500000,1000000,2500000,5000000,10000000];
    for(let i=0;i<8;i++) addAchs([{ id:`pt${i+1}`, title:`Ahorrador ${i+1}`, desc:`Acumula ${ptsTiers[i].toLocaleString()} puntos totales en tu carrera.`, color:colors.green, icon:SVG_STAR }]);

    // --- RÉCORDS PERFECTOS (8) ---
    const hsCountTiers=[1,3,5,10,20,35,50,100];
    for(let i=0;i<8;i++) addAchs([{ id:`hs${i+1}`, title:`Récord ${i+1}`, desc:`Supera 100,000 puntos en ${hsCountTiers[i]} partidas distintas.`, color:colors.purple, icon:SVG_FIRE }]);

    // --- FRENESÍ (8) ---
    const frTiers=[1,5,10,25,50,100,200,500];
    for(let i=0;i<8;i++) addAchs([{ id:`r${i+1}`, title:`Frenético ${i+1}`, desc:`Activa el Modo Frenesí en ${frTiers[i]} ocasiones.`, color:colors.orange, icon:SVG_FIRE }]);

    // --- PARTIDAS PERFECTAS (8) ---
    const pfTiers=[10,20,30,50,75,100,150,200];
    for(let i=0;i<8;i++) addAchs([{ id:`pf${i+1}`, title:`Resistencia ${i+1}`, desc:`Llega a la pregunta ${pfTiers[i]} en una sola partida.`, color:colors.yellow, icon:SVG_TARGET }]);

    // --- VELOCIDAD (8) ---
    const spdTiers=[5,15,30,60,100,200,350,500];
    for(let i=0;i<8;i++) addAchs([{ id:`sp${i+1}`, title:`Reflejos ${i+1}`, desc:`Responde correctamente en los primeros 2s en ${spdTiers[i]} ocasiones.`, color:colors.blue, icon:SVG_BOLT }]);

    // --- ACIERTOS TOTALES (8) ---
    const acTiers=[10,50,100,250,500,1000,2500,5000];
    for(let i=0;i<8;i++) addAchs([{ id:`ac${i+1}`, title:`Cerebro ${i+1}`, desc:`Acumula ${acTiers[i]} respuestas correctas en total.`, color:colors.green, icon:SVG_CORRECT }]);

    // --- RACHA MÁX ACUMULADA (8 escalables) ---
    const strkTiers=[5,10,15,20,25,30,40,50];
    for(let i=0;i<8;i++) addAchs([{ id:`sk${i+1}`, title:`Encadenado ${i+1}`, desc:`Alcanza una racha de ${strkTiers[i]} aciertos seguidos en alguna partida.`, color:colors.orange, icon:SVG_BOLT }]);

    // --- MULTIPLICADOR MÁX (5 escalables) ---
    const multTiers=[2,3,4,5,6];
    for(let i=0;i<5;i++) addAchs([{ id:`mx${i+1}`, title:`Multiplicador x${multTiers[i]}`, desc:`Alcanza el multiplicador x${multTiers[i]} en una partida.`, color:colors.red, icon:SVG_FIRE }]);

    // --- VISITAS A RANKING (5 escalables) ---
    const rankVisTiers=[1,5,15,30,60];
    for(let i=0;i<5;i++) addAchs([{ id:`rv${i+1}`, title:`Espía de Clasificación ${i+1}`, desc:`Visita la Clasificación Global ${rankVisTiers[i]} veces.`, color:colors.blue, icon:SVG_TROPHY }]);

    // --- VISITAS A CONFIGURACIÓN (4 escalables) ---
    const cfgVisTiers=[1,5,15,30];
    for(let i=0;i<4;i++) addAchs([{ id:`cv${i+1}`, title:`Ajustador ${i+1}`, desc:`Abre el menú de Configuración ${cfgVisTiers[i]} veces.`, color:colors.purple, icon:SVG_USER }]);

    // --- VISITAS AL MANUAL (5 escalables) ---
    const guideVisTiers=[1,5,10,25,50];
    for(let i=0;i<5;i++) addAchs([{ id:`gv${i+1}`, title:`Estudiante ${i+1}`, desc:`Visita las Instrucciones del juego ${guideVisTiers[i]} veces.`, color:colors.green, icon:SVG_TARGET }]);

    // --- TIEMPO SIN FALLOS (5 escalables) ---
    const noTimoutTiers=[5,10,20,35,50];
    for(let i=0;i<5;i++) addAchs([{ id:`nt${i+1}`, title:`Puntual ${i+1}`, desc:`Responde ${noTimoutTiers[i]} preguntas seguidas sin que se acabe el tiempo.`, color:colors.yellow, icon:SVG_CLOCK }]);

    // --- LOGROS ÚNICOS (24) ---
    addAchs([
        { id: 'u1',  title: 'Error Inicial',   desc: 'Equivócate al responder por primera vez.',                         color: colors.dark,   icon: SVG_INCORRECT },
        { id: 'u2',  title: 'Tropiezo',        desc: 'Acumula 100 respuestas incorrectas en tu carrera.',                color: colors.dark,   icon: SVG_INCORRECT },
        { id: 'u3',  title: 'Dormilón',        desc: 'Deja que el reloj llegue a cero en una pregunta.',                 color: colors.dark,   icon: SVG_CLOCK },
        { id: 'u4',  title: 'AFK',             desc: 'Deja que el reloj llegue a cero 50 veces en total.',               color: colors.dark,   icon: SVG_CLOCK },
        { id: 'u5',  title: 'Por los Pelos',   desc: 'Acierta una pregunta cuando el reloj marque exactamente 1 segundo.',color: colors.red,   icon: SVG_CLOCK },
        { id: 'u_junior', title: 'Junior',     desc: 'Alcanza el rango Junior.',                                            color: colors.blue,   icon: SVG_TROPHY },
        { id: 'u6',  title: 'Pro',             desc: 'Alcanza el rango Pro.',                                            color: colors.red,    icon: SVG_TROPHY },
        { id: 'u7',  title: 'Maestro',         desc: 'Alcanza el rango Maestro.',                                        color: colors.purple, icon: SVG_TROPHY },
        { id: 'u8',  title: 'Leyenda',         desc: 'Alcanza el codiciado rango Leyenda.',                              color: colors.yellow, icon: SVG_TROPHY },
        { id: 'u9',  title: 'Inmortal',        desc: 'Completa 50 preguntas seguidas sin perder ninguna vida.',          color: colors.purple, icon: SVG_SHIELD },
        { id: 'u10', title: 'Desastre',        desc: 'Pierde las 3 vidas en las primeras 3 preguntas.',                  color: colors.dark,   icon: SVG_SKULL },
        { id: 'u11', title: 'Fénix',           desc: 'Pierde 2 vidas al inicio pero llega a 30 aciertos consecutivos.',  color: colors.orange, icon: SVG_FIRE },
        { id: 'u12', title: 'Tragedia',        desc: 'Pierde la última vida durante una racha de 20 o más.',             color: colors.dark,   icon: SVG_INCORRECT },
        { id: 'u13', title: 'Flash',           desc: 'Responde correctamente en menos de 1 segundo.',                    color: colors.yellow, icon: SVG_BOLT },
        { id: 'u14', title: 'Calculador',      desc: 'Acierta dejando que el reloj baje a 2-3 segundos.',                color: colors.blue,   icon: SVG_CLOCK },
        { id: 'u15', title: 'Superviviente',   desc: 'Llega a 100 preguntas en una sola partida.',                       color: colors.green,  icon: SVG_SHIELD },
        { id: 'u16', title: 'Frenesí Máximo',  desc: 'Alcanza el multiplicador x4 o superior.',                          color: colors.orange, icon: SVG_FIRE },
        { id: 'u17', title: 'Reloj de Arena',  desc: 'Acumula 50 respuestas de último segundo (1-2 seg).',               color: colors.blue,   icon: SVG_CLOCK },
        { id: 'u18', title: 'Suicida',         desc: 'Pierde las 3 vidas en menos de 30 segundos de partida.',           color: colors.dark,   icon: SVG_SKULL },
        { id: 'u19', title: 'Resurrección',    desc: 'Pierde 2 vidas seguidas y encadena 10 aciertos consecutivos.',     color: colors.yellow, icon: SVG_HEART },
        { id: 'u20', title: 'Centinela',       desc: 'Llega a la pregunta 50 sin usar ningún fallo por tiempo.',         color: colors.dark,   icon: SVG_CLOCK },
        { id: 'u21', title: 'Metralleta',      desc: 'Responde 10 preguntas seguidas en menos de 3 segundos cada una.',  color: colors.red,    icon: SVG_BOLT },
        { id: 'u22', title: 'Maratón',         desc: 'Juega 50 partidas en un solo día.',                                color: colors.purple, icon: SVG_HEART },
        { id: 'u23', title: 'Imparable',       desc: 'Encadena una racha de 25 aciertos o más en una partida.',          color: colors.yellow, icon: SVG_TARGET },
        { id: 'u24', title: 'Extremis',        desc: 'Consigue 3 aciertos de último segundo (1 seg) en una partida.',   color: colors.red,    icon: SVG_SHIELD },
    ]);

    // --- MODO DE JUEGO (oculto – interacciones con el ranking) (10) ---
    addAchs([
        { id: 'nm1', title: 'Primera Sangre',     desc: 'Aparece por primera vez en la Clasificación Global.',            color: colors.red,    icon: SVG_TROPHY },
        { id: 'nm2', title: 'Top 10',             desc: 'Entra en el Top 10 de la Clasificación.',                       color: colors.orange, icon: SVG_TROPHY },
        { id: 'nm3', title: 'Podio',              desc: 'Entra en el Top 3 de la Clasificación.',                        color: colors.yellow, icon: SVG_TROPHY },
        { id: 'nm4', title: 'El Primero',         desc: 'Llega al primer lugar de la Clasificación.',                    color: colors.yellow, icon: SVG_STAR },
        { id: 'nm5', title: 'Vigilia',            desc: 'Sube en la Clasificación en 3 días consecutivos.',              color: colors.blue,   icon: SVG_CLOCK },
        { id: 'nm6', title: 'Impostado',          desc: 'Supera a otro jugador que tenía más de 1,000 PL que tú.',       color: colors.purple, icon: SVG_BOLT },
        { id: 'nm7', title: 'Remontada',          desc: 'Estabas en puesto 15+ y ascendiste al Top 5 en una partida.',   color: colors.orange, icon: SVG_FIRE },
        { id: 'nm8', title: 'PL 10,000',          desc: 'Alcanza 10,000 Puntos de Poder (Nivel inicial).',               color: colors.green,  icon: SVG_STAR },
        { id: 'nm9', title: 'PL 100,000',         desc: 'Alcanza 100,000 Puntos de Poder (Nivel Intermedio, Rango Pro).',color: colors.blue,   icon: SVG_STAR },
        { id: 'nm10',title: 'PL 1,000,000',       desc: 'Alcanza 1,000,000 de Puntos de Poder. Meta del Top Mundial.',   color: colors.yellow, icon: SVG_STAR },
    ]);

    // --- OCULTOS: CONFIGURACIÓN (8) ---
    addAchs([
        { id: 'cfg1', title: 'Silencio Total',     desc: 'Pon la música en 0% desde Configuración.',                     color: colors.dark,   icon: SVG_CLOCK },
        { id: 'cfg2', title: 'Oídos Abiertos',    desc: 'Sube la música al 100% desde Configuración.',                  color: colors.green,  icon: SVG_STAR },
        { id: 'cfg3', title: 'Sordomudo',          desc: 'Pon tanto la música como el SFX en 0%.',                      color: colors.dark,   icon: SVG_SKULL },
        { id: 'cfg4', title: 'Ajuste Fino',        desc: 'Cambia el valor de FPS al menos 5 veces.',                   color: colors.purple, icon: SVG_BOLT },
        { id: 'cfg5', title: 'Velocista',          desc: 'Activa 240 FPS en Configuración.',                            color: colors.red,    icon: SVG_FIRE },
        { id: 'cfg6', title: 'Ahorro de Batería',  desc: 'Activa 15 FPS en Configuración.',                            color: colors.dark,   icon: SVG_CLOCK },
        { id: 'cfg7', title: 'Fantasma',           desc: 'Pon las partículas en 0%.',                                  color: colors.dark,   icon: SVG_SKULL },
        { id: 'cfg8', title: 'Purpurina',          desc: 'Pon las partículas en 100% y la música en 100% al mismo tiempo.',color: colors.purple, icon: SVG_STAR },
    ]);

    // --- OCULTOS: INTERFAZ Y CLASIFICACIÓN (10) ---
    addAchs([
        { id: 'ui1',  title: 'Explorador',         desc: 'Visita todas las secciones del menú en una misma sesión.',     color: colors.blue,   icon: SVG_TARGET },
        { id: 'ui2',  title: 'Vuelvo en Un Segundo',desc: 'Entra y sal del menú de Configuración en menos de 3 segundos.',color: colors.yellow, icon: SVG_BOLT },
        { id: 'ui3',  title: 'La Guía No Miente',  desc: 'Lee el Manual y luego completa 5 aciertos en una partida.',   color: colors.green,  icon: SVG_SHIELD },
        { id: 'ui5',  title: 'El Perfil Importa',  desc: 'Visita tu perfil después de cada una de tus primeras 5 partidas.',color: colors.blue, icon: SVG_USER },
        { id: 'ui6',  title: 'Fan de Clasificación',desc: 'Visita la Clasificación mientras hay menos de 5 jugadores.',   color: colors.dark,   icon: SVG_TROPHY },
        { id: 'ui7',  title: 'Nuevo en el Barrio', desc: 'Juega tu primera partida con nombre registrado.',             color: colors.green,  icon: SVG_USER },
        { id: 'ui8',  title: 'Bien Conectado',     desc: 'La clasificación global carga sin errores 10 veces.',         color: colors.blue,   icon: SVG_TARGET },
        { id: 'ui9',  title: 'Puntaje en Mente',   desc: 'Revisa tu perfil inmediatamente después de un puntaje récord.',color: colors.yellow, icon: SVG_STAR },
        { id: 'ui10', title: 'El Circuito',        desc: 'Navega por las 5 secciones del juego en orden secuencial.',   color: colors.purple, icon: SVG_FIRE },
    ]);

    // --- ESCALABLES: FALLOS, TIMEOUTS, PARTIDAS HOY (15) ---
    const wrnTiers=[10,50,100,250,500];
    for(let i=0;i<5;i++) addAchs([{ id:`wr${i+1}`, title:`Torpeza ${i+1}`, desc:`Acumula ${wrnTiers[i]} respuestas incorrectas en tu carrera.`, color:colors.dark, icon:SVG_INCORRECT }]);
    const toTiers=[5,20,50,100,250];
    for(let i=0;i<5;i++) addAchs([{ id:`to${i+1}`, title:`Ausente ${i+1}`, desc:`Deja el reloj llegar a cero ${toTiers[i]} veces.`, color:colors.dark, icon:SVG_CLOCK }]);
    const todayTiers=[3,5,8,10,15];
    for(let i=0;i<5;i++) addAchs([{ id:`td${i+1}`, title:`Intenso ${i+1}`, desc:`Juega ${todayTiers[i]} partidas en un solo día.`, color:colors.orange, icon:SVG_FIRE }]);

    // --- ESCALABLES: PUNTAJE RECORD (8) ---
    const bestScoreTiers=[5000,25000,75000,150000,300000,600000,1000000,2000000];
    const bestScoreTitles=['Primera Marca','Principiante','Prometedor','Serio','Élite','Extraordinario','El Millón','Leyenda Viva'];
    for(let i=0;i<8;i++) addAchs([{ id:`bs${i+1}`, title:bestScoreTitles[i], desc:`Alcanza un puntaje récord de ${bestScoreTiers[i].toLocaleString()} puntos en una partida.`, color:colors.yellow, icon:SVG_TROPHY }]);

    // --- ESCALABLES VARIOS (20) ---
    const totalDaysTiers=[5,10,20,30,60];
    for(let i=0;i<5;i++) addAchs([{ id:`td2${i+1}`, title:`Asiduo ${i+1}`, desc:`Juega en ${totalDaysTiers[i]} días distintos en total (no necesariamente seguidos).`, color:colors.green, icon:SVG_CLOCK }]);
    const pinTiers=[1,5,10,20,50];
    for(let i=0;i<5;i++) addAchs([{ id:`pin${i+1}`, title:`Curador ${i+1}`, desc:`Fija logros en el perfil ${pinTiers[i]} veces en total.`, color:colors.blue, icon:SVG_PIN }]);
    const dailyAchTiers=[1,3,5,8,12];
    for(let i=0;i<5;i++) addAchs([{ id:`da${i+1}`, title:`Productivo ${i+1}`, desc:`Desbloquea ${dailyAchTiers[i]} logros nuevos en un mismo día.`, color:colors.purple, icon:SVG_STAR }]);
    const frenzyTimeTiers=[3,5,8,12,20];
    for(let i=0;i<5;i++) addAchs([{ id:`ft${i+1}`, title:`Frenesí Eterno ${i+1}`, desc:`Mantén el Modo Frenesí activo durante ${frenzyTimeTiers[i]} preguntas consecutivas.`, color:colors.red, icon:SVG_FIRE }]);

    // --- ÚNICOS EXTRA JUGABILIDAD (20) ---
    addAchs([
        { id: 'x1',  title: 'Primer Día',      desc: 'Inicia sesión por primera vez.',                              color: colors.blue,   icon: SVG_CLOCK },
        { id: 'x2',  title: 'Paciente',         desc: 'Espera 10 segundos en el menú principal sin hacer nada.',    color: colors.dark,   icon: SVG_CLOCK },
        { id: 'x3',  title: 'Aprendiz',         desc: 'Completa tu primera partida (sin importar el puntaje).',     color: colors.green,  icon: SVG_TARGET },
        { id: 'x4',  title: 'Doble Victoria',   desc: 'Supera 75,000 puntos dos partidas seguidas.',              color: colors.yellow, icon: SVG_TROPHY },
        { id: 'x5',  title: 'La Revancha',      desc: 'Después de una partida con 0 aciertos, consigue más de 10 aciertos.', color: colors.orange, icon: SVG_FIRE },
        { id: 'x6',  title: 'Consistente',      desc: 'Termina 5 partidas seguidas con al menos 25,000 puntos.',  color: colors.blue,   icon: SVG_SHIELD },
        { id: 'x7',  title: 'Un Golpe Certero', desc: 'Acumula 3,000 puntos en la primera pregunta.',             color: colors.yellow, icon: SVG_BOLT },
        { id: 'x8',  title: 'Sin Prisa',        desc: 'Termina una partida usando menos de 5 respuestas rápidas.', color: colors.dark,   icon: SVG_CLOCK },
        { id: 'x9',  title: 'Todo Gas',         desc: 'Responde las primeras 10 preguntas en menos de 3 segundos cada una.', color: colors.red, icon: SVG_BOLT },
        { id: 'x10', title: 'Economía',         desc: 'Completa 20 preguntas sin perder ninguna vida.',             color: colors.green,  icon: SVG_HEART },
        { id: 'x11', title: 'El Último Chance', desc: 'Responde correctamente estando en la última vida.',          color: colors.orange, icon: SVG_SHIELD },
        { id: 'x12', title: 'Principiante Letal',desc:'Consigue 50,000 puntos en tu primera partida del día.',     color: colors.blue,   icon: SVG_STAR },
        { id: 'x13', title: 'Noche de Fuego',   desc: 'Juega más de 10 partidas en un único día.',                 color: colors.red,    icon: SVG_FIRE },
        { id: 'x14', title: 'Invicto',          desc: 'Llega a la pregunta 30 sin perder una vida.',               color: colors.green,  icon: SVG_SHIELD },
        { id: 'x15', title: 'Punto de Quiebre', desc: 'Alcanza exactamente 100,000 puntos (±500).',                color: colors.purple, icon: SVG_TARGET },
        { id: 'x16', title: 'Regreso Triunfal', desc: 'Después de no jugar por un día, supera tu último récord.',  color: colors.yellow, icon: SVG_TROPHY },
        { id: 'x17', title: 'Veterano',         desc: 'Acumula más de 100 partidas jugadas.',                      color: colors.blue,   icon: SVG_TROPHY },
        { id: 'x18', title: 'El Clásico',       desc: 'Usa el mismo nombre de jugador por 30 días seguidos.',      color: colors.purple, icon: SVG_USER },
        { id: 'x19', title: 'Espectacular',     desc: 'Consigue 5 respuestas Flash (< 1 seg) en una partida.',    color: colors.yellow, icon: SVG_BOLT },
        { id: 'x20', title: 'Pura Determinación',desc:'Juega 20 partidas en un día con al menos 1 logro desbloqueado en cada.', color:colors.red, icon:SVG_FIRE },
    ]);

    // --- MÁS ESCALABLES (15) ---
    const profileVisTiers=[1,5,15,30,60];
    for(let i=0;i<5;i++) addAchs([{ id:`pv${i+1}`, title:`Egocéntrico ${i+1}`, desc:`Visita tu perfil ${profileVisTiers[i]} veces.`, color:colors.purple, icon:SVG_USER }]);
    const returnDayTiers=[3,7,15,30,60];
    for(let i=0;i<5;i++) addAchs([{ id:`ret${i+1}`, title:`Fiel ${i+1}`, desc:`Regresa a jugar ${returnDayTiers[i]} días diferentes en total.`, color:colors.green, icon:SVG_HEART }]);

    // --- ÚNICOS FINALES Y MODOS PERFECCIÓN (9) ---
    addAchs([
        { id: 'fin1', title: 'Nocturno',       desc: 'Juega una partida después de las 11:00 PM.',                 color: colors.dark,   icon: SVG_CLOCK },
        { id: 'fin2', title: 'Madrugador',     desc: 'Juega una partida antes de las 6:00 AM.',                   color: colors.blue,   icon: SVG_CLOCK },
        { id: 'fin3', title: 'Momento Épico',  desc: 'Entra en Modo Frenesí y luego consigue 20 aciertos más.',   color: colors.red,    icon: SVG_FIRE },
        { id: 'fin4', title: 'El Pacto',       desc: 'Juega durante 7 días seguidos y alcanza el rango Junior.',  color: colors.green,  icon: SVG_SHIELD },
        { id: 'fin5', title: 'Monarca',        desc: 'Alcanza simultáneamente el rango Leyenda y 200 logros.',    color: colors.yellow, icon: SVG_TROPHY },
        { id: 'np1',  title: 'Examen de Oro',  desc: 'Logra 10 aciertos seguidos sin perder ninguna vida.',       color: colors.yellow, icon: SVG_SHIELD },
        { id: 'np2',  title: 'Presumido',      desc: 'Fija 3 logros de color Rojo o Dorado en tu perfil.',        color: colors.red,    icon: SVG_STAR },
        { id: 'np3',  title: 'Sin Límites',    desc: 'Completa una partida de más de 60 preguntas sin rendirte.', color: colors.purple, icon: SVG_BOLT },
        { id: 'np4',  title: 'La Última Bala', desc: 'Consigue exactamente 1 acierto antes de perder todas las vidas.', color: colors.dark, icon: SVG_SKULL },
    ]);

    // --- NUEVOS: PISTAS Y MULTIPLICADORES (10) ---
    addAchs([
        { id: 'trk1', title: 'Explorador Musical', desc: 'Cambia de pista musical al menos una vez desde Configuración.', color: colors.green, icon: SVG_STAR },
        { id: 'trk2', title: 'DJ Klick',           desc: 'Prueba las 3 pistas musicales disponibles.',                   color: colors.blue,  icon: SVG_STAR },
        { id: 'trk3', title: 'Fiel al Ritmo',      desc: 'Juega 10 partidas con la misma pista sin cambiarla.',          color: colors.purple,icon: SVG_FIRE },
        { id: 'mx6',  title: 'Multiplicador x6',   desc: 'Alcanza el multiplicador x6 en una partida.',                  color: colors.purple,icon: SVG_FIRE },
        { id: 'mx7',  title: 'Multiplicador x7',   desc: 'Alcanza el multiplicador x7 en una partida.',                  color: colors.red,   icon: SVG_FIRE },
        { id: 'mx8',  title: 'Multiplicador x8',   desc: 'Alcanza el multiplicador x8 en una partida.',                  color: colors.red,   icon: SVG_BOLT },
        { id: 'mx9',  title: 'Multiplicador x9',   desc: 'Alcanza el multiplicador x9 en una partida.',                  color: colors.yellow,icon: SVG_BOLT },
        { id: 'mx10', title: 'Multiplicador x10 — MÁXIMO', desc: 'Alcanza el multiplicador máximo x10. Eres imparable.', color: colors.yellow,icon: SVG_TROPHY },
        { id: 'pod1', title: 'Rey Klick',          desc: 'Eres Leyenda y ocupas el 1.er lugar de la clasificación.',     color: '#e040fb',    icon: SVG_TROPHY },
        { id: 'pod2', title: 'Señor Klick',        desc: 'Eres Leyenda y ocupas el 2.º lugar de la clasificación.',      color: '#00e5ff',    icon: SVG_TROPHY },
        { id: 'pod3', title: 'Caballero Klick',    desc: 'Eres Leyenda y ocupas el 3.er lugar de la clasificación.',     color: '#69ff47',    icon: SVG_TROPHY },
    ]);

    // --- LOGRO OCULTO: CLICK EN EL LOGO ---
    addAchs([
        { id: 'secret_logo', title: '¡Klick!',  desc: 'Hiciste clic en el nombre del juego en la pantalla principal.', color: colors.yellow, icon: SVG_BOLT, hidden: true },
    ]);


    function processDailyLogin() {
        const now = new Date(); const todayStr = now.toISOString().split('T')[0];
        if (playerStats.lastLoginDate !== todayStr) {
            const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1); const yesterdayStr = yesterday.toISOString().split('T')[0];
            if (playerStats.lastLoginDate === yesterdayStr) { playerStats.currentLoginStreak++; playerStats.maxLoginStreak = Math.max(playerStats.maxLoginStreak, playerStats.currentLoginStreak); } 
            else { playerStats.currentLoginStreak = 1; if(playerStats.maxLoginStreak === 0) playerStats.maxLoginStreak = 1; }
            playerStats.lastLoginDate = todayStr; playerStats.todayGames = 0; saveStatsLocally(); checkAchievements();
        }
    }
    function shuffleArray(array) { let current = array.length, random; while (current !== 0) { random = Math.floor(Math.random() * current); current--; [array[current], array[random]] = [array[random], array[current]]; } return array; }

    function getRankInfo(stats) {
        if (stats.totalScore >= 400000 && stats.totalCorrect >= 1500 && stats.perfectGames >= 10) return { title: "Leyenda", color: "var(--accent-yellow)", rgb: "255, 184, 0" };
        if (stats.totalScore >= 150000 && stats.gamesPlayed >= 50 && (stats.maxMult||1) >= 4) return { title: "Maestro", color: "var(--accent-purple)", rgb: "181, 23, 158" };
        if (stats.totalScore >= 60000 && stats.totalCorrect >= 200 && stats.maxStreak >= 12) return { title: "Pro", color: "var(--accent-red)", rgb: "255, 42, 95" };
        if (stats.bestScore >= 15000 && stats.gamesPlayed >= 5) return { title: "Junior", color: "var(--accent-blue)", rgb: "0, 212, 255" };
        return { title: "Novato", color: "var(--accent-green)", rgb: "0, 255, 102" };
    }
    let currentRankInfo = getRankInfo(playerStats);

    function checkAchievements() {
        let newlyUnlocked = [];
        const achSet = new Set(playerStats.achievements);
        const unlock = (id) => { 
            if (!achSet.has(id)) { 
                achSet.add(id);
                playerStats.achievements.push(id); 
                const f = ACHIEVEMENTS_DATA.find(a => a.id === id); 
                if(f) newlyUnlocked.push(f); 
            } 
        };
        
        if (achSet.has('tramposo')) {
            if (!playerStats.pinnedAchievements.includes('tramposo')) {
                playerStats.pinnedAchievements.unshift('tramposo');
                if (playerStats.pinnedAchievements.length > 3) playerStats.pinnedAchievements.pop();
            } else if (playerStats.pinnedAchievements.indexOf('tramposo') !== 0) {
                playerStats.pinnedAchievements.splice(playerStats.pinnedAchievements.indexOf('tramposo'), 1);
                playerStats.pinnedAchievements.unshift('tramposo');
            }
        }

        const normalAchs = playerStats.achievements.filter(id => id !== 'tramposo').length;

        // META
        if (playerStats.nameChanges >= 1) unlock('m1'); if (playerStats.nameChanges >= 5) unlock('m2'); if (playerStats.nameChanges >= 20) unlock('m3');
        if (playerStats.achViews >= 1) unlock('m4'); if (playerStats.achViews >= 10) unlock('m5'); if (playerStats.achViews >= 50) unlock('m6');
        if (playerStats.pinnedAchievements.filter(id => id !== 'tramposo').length > 0) unlock('m7'); 
        if (normalAchs >= 10) unlock('m8'); if (normalAchs >= 50) unlock('m9'); if (normalAchs >= 100) unlock('m10');
        if (normalAchs >= 150) unlock('master1'); if (normalAchs >= 200) unlock('master2'); if (normalAchs >= 225) unlock('master4'); if (normalAchs >= 250) unlock('master3');

        // DÍAS (Consecutivos vs Totales)
        const days = playerStats.maxLoginStreak; 
        for(let i=0;i<5;i++) if(days>=daysTiers[i]) unlock(`d${i+1}`);
        const totalDays = playerStats.totalDaysPlayed || 0;
        for(let i=5;i<10;i++) if(totalDays>=daysTiers[i]) unlock(`d${i+1}`);

        // PARTIDAS
        const pts = playerStats.gamesPlayed; for(let i=0;i<8;i++) if(pts>=ptTiers[i]) unlock(`p${i+1}`);
        const tot = playerStats.totalScore; for(let i=0;i<8;i++) if(tot>=ptsTiers[i]) unlock(`pt${i+1}`);
        const hsc = playerStats.maxScoreCount; for(let i=0;i<8;i++) if(hsc>=hsCountTiers[i]) unlock(`hs${i+1}`);
        const fr = playerStats.frenziesTriggered; for(let i=0;i<8;i++) if(fr>=frTiers[i]) unlock(`r${i+1}`);
        const pf = playerStats.maxQuestionReached||0; for(let i=0;i<8;i++) if(pf>=pfTiers[i]) unlock(`pf${i+1}`);
        const sp = playerStats.fastAnswersTotal; for(let i=0;i<8;i++) if(sp>=spdTiers[i]) unlock(`sp${i+1}`);
        const ac = playerStats.totalCorrect; for(let i=0;i<8;i++) if(ac>=acTiers[i]) unlock(`ac${i+1}`);
        const sk = playerStats.maxStreak; for(let i=0;i<8;i++) if(sk>=strkTiers[i]) unlock(`sk${i+1}`);
        const mx = playerStats.maxMult||1; for(let i=0;i<5;i++) if(mx>=multTiers[i]) unlock(`mx${i+1}`);
        const rv = playerStats.rankingViews||0; for(let i=0;i<5;i++) if(rv>=rankVisTiers[i]) unlock(`rv${i+1}`);
        const cv = playerStats.configViews||0; for(let i=0;i<4;i++) if(cv>=cfgVisTiers[i]) unlock(`cv${i+1}`);
        const gv = playerStats.guideViews||0; for(let i=0;i<5;i++) if(gv>=guideVisTiers[i]) unlock(`gv${i+1}`);
        const nt = playerStats.maxNoTimeoutStreak||0; for(let i=0;i<5;i++) if(nt>=noTimoutTiers[i]) unlock(`nt${i+1}`);

        // ÚNICOS
        if (playerStats.totalWrong > 0) unlock('u1'); if (playerStats.totalWrong >= 100) unlock('u2'); 
        if (playerStats.totalTimeouts > 0) unlock('u3'); if (playerStats.totalTimeouts >= 50) unlock('u4'); 
        if (playerStats.todayGames >= 50) unlock('u22'); if ((playerStats.maxStreak||0) >= 25) unlock('u23');
        const rank = getRankInfo(playerStats).title; 
        if (rank==="Junior"||rank==="Pro"||rank==="Maestro"||rank==="Leyenda") unlock('u_junior');
        if (rank==="Pro"||rank==="Maestro"||rank==="Leyenda") unlock('u6'); 
        if (rank==="Maestro"||rank==="Leyenda") unlock('u7'); 
        if (rank==="Leyenda") unlock('u8');
        if (playerStats.clickedLogo) unlock('secret_logo');

        // ESCALABLES GENERALES
        const wr = playerStats.totalWrong||0; for(let i=0;i<5;i++) if(wr>=wrnTiers[i]) unlock(`wr${i+1}`);
        const to = playerStats.totalTimeouts||0; for(let i=0;i<5;i++) if(to>=toTiers[i]) unlock(`to${i+1}`);
        const td = playerStats.todayGames||0; for(let i=0;i<5;i++) if(td>=todayTiers[i]) unlock(`td${i+1}`);

        // CLASIFICACIÓN
        const pl = playerStats.powerLevel||0; 
        if(pl>=10000) unlock('nm8'); if(pl>=100000) unlock('nm9'); if(pl>=1000000) unlock('nm10');
        const rp = playerStats.rankingPosition||999;
        if(rp<=20) unlock('nm1'); if(rp<=10) unlock('nm2'); if(rp<=3) unlock('nm3'); if(rp===1) unlock('nm4');

        // PODIO LEYENDA (solo top 1-3 Y rango Leyenda)
        const curRankTitle = getRankInfo(playerStats).title;
        if(rp===1 && curRankTitle==='Leyenda') unlock('pod1');
        if(rp===2 && curRankTitle==='Leyenda') unlock('pod2');
        if(rp===3 && curRankTitle==='Leyenda') unlock('pod3');

        // MULTIPLICADORES x6-x10
        const mx2 = playerStats.maxMult||1;
        if(mx2>=6) unlock('mx6'); if(mx2>=7) unlock('mx7'); if(mx2>=8) unlock('mx8'); if(mx2>=9) unlock('mx9'); if(mx2>=10) unlock('mx10');

        // PISTAS MUSICALES
        if((playerStats.trackSwitches||0)>=1) unlock('trk1');
        if(playerStats.triedAllTracks) unlock('trk2');
        if((playerStats.sameTrackGames||0)>=10) unlock('trk3');

        // CONFIG Y UI
        if(playerStats.musicSetTo0) unlock('cfg1');
        if(playerStats.musicAt100) unlock('cfg2');
        if(playerStats.musicSetTo0 && playerStats.sfxSetTo0) unlock('cfg3');
        if((playerStats.fpsChanges||0)>=5) unlock('cfg4');
        if(playerStats.maxFps===240) unlock('cfg5');
        if(playerStats.maxFps===15) unlock('cfg6');
        if(playerStats.particles0) unlock('cfg7');
        if(playerStats.musicAt100 && playerStats.particles100) unlock('cfg8');
        if(playerStats.allSectionsVisited) unlock('ui1');
        if(playerStats.nameChanges>=1 && playerStats.gamesPlayed>=1) unlock('ui7');

        const pvv = playerStats.profileViews||0; for(let i=0;i<5;i++) if(pvv>=profileVisTiers[i]) unlock(`pv${i+1}`);
        const retv = playerStats.totalDaysPlayed||0; for(let i=0;i<5;i++) if(retv>=returnDayTiers[i]) unlock(`ret${i+1}`);

        const bsv = playerStats.bestScore||0; for(let i=0;i<8;i++) if(bsv>=bestScoreTiers[i]) unlock(`bs${i+1}`);
        const fts = playerStats.maxFrenzyStreak||0; for(let i=0;i<5;i++) if(fts>=frenzyTimeTiers[i]) unlock(`ft${i+1}`);

        // ÚNICOS EXTRA
        if(playerStats.gamesPlayed>=1) unlock('x3');
        if(playerStats.gamesPlayed>=1 || playerStats.maxLoginStreak>=1) unlock('x1');
        if(playerStats.gamesPlayed>=100) unlock('x17');
        if(playerStats.nameChanges===0 && playerStats.maxLoginStreak>=30) unlock('x18');
        if(rank==='Leyenda' && normalAchs>=200) unlock('fin5');
        if(days>=7 && (rank==='Junior'||rank==='Pro'||rank==='Maestro'||rank==='Leyenda')) unlock('fin4');
        if((playerStats.maxMult||1)>=4) unlock('u16');

        if(playerStats.playedNocturno) unlock('fin1');
        if(playerStats.playedMadrugador) unlock('fin2');

        // MODO PERFECCIÓN
        let redGoldCount = 0;
        playerStats.pinnedAchievements.forEach(id => {
            const ach = ACHIEVEMENTS_DATA.find(a => a.id === id);
            if (ach && (ach.color === colors.red || ach.color === colors.yellow || ach.color === colors.orange)) redGoldCount++;
        });
        if (redGoldCount >= 3) unlock('np2');

        if (newlyUnlocked.length > 0) { 
            saveStatsLocally(); 
            renderAchievements(); 
            newlyUnlocked.forEach((ach, index) => { 
                setTimeout(() => { SFX.achievement(); showToast('Logro Desbloqueado', ach.title, ach.color, ach.icon); }, index * 1300); 
            }); 
        }
    }

    function togglePin(achId) {
        if (achId === 'tramposo') { 
            showToast('Condena Permanente', 'Los tramposos no pueden ocultar sus actos.', 'var(--accent-red)', SVG_SKULL); 
            return; 
        }
        if (!playerStats.achievements.includes(achId)) return; SFX.click(); const index = playerStats.pinnedAchievements.indexOf(achId);
        if (index > -1) { playerStats.pinnedAchievements.splice(index, 1); showToast('Quitado del perfil', 'Ya no aparecerá destacado.', 'var(--text-secondary)', SVG_PIN); } 
        else { if (playerStats.pinnedAchievements.length >= 3) { showToast('Límite', 'Máximo 3 fijados', 'var(--accent-red)', SVG_INCORRECT); return; } playerStats.pinnedAchievements.push(achId); const ach_data = ACHIEVEMENTS_DATA.find(a => a.id === achId); showToast('Fijado en Perfil', ach_data ? ach_data.title : achId, ach_data ? ach_data.color : '', ach_data ? ach_data.icon : ''); }
        saveStatsLocally(); checkAchievements(); renderAchievements();
    }
    
    // togglePin y revokeInvalidAchievements usan el virtual scroller automáticamente
    
    // Rarity score: how exclusive/rare is each achievement (higher = rarer)
    // ── Rarity score for auto-profile fill ──────────────────────────────────
    const RARITY_SCORE = {master3:100,master4:96,master2:91,master1:86,fin5:83,u8:81,u7:79,u15:76,nm4:74,nm3:71,nm10:69,u9:66,u23:63,u11:61,u16:59,nm9:56,u19:53,u24:51,np1:49,np3:47,u21:44};
    function getAchRarity(id) { return RARITY_SCORE[id] || 10; }

    function getAutoProfileAchs() {
        const result = [];
        if (playerStats.achievements.includes('tramposo')) result.push('tramposo');
        playerStats.pinnedAchievements
            .filter(id => id !== 'tramposo')
            .forEach(id => { if (result.length < 3 && playerStats.achievements.includes(id)) result.push(id); });
        if (result.length < 3) {
            const rest = playerStats.achievements
                .filter(id => id !== 'tramposo' && !result.includes(id))
                .sort((a,b) => getAchRarity(b) - getAchRarity(a));
            rest.forEach(id => { if (result.length < 3) result.push(id); });
        }
        return result;
    }

    // ══════════════════════════════════════════════════════════════════
    //  VIRTUAL SCROLLER — solo renderiza las tarjetas visibles en pantalla
    //  Elimina el lag al hacer scroll por los 247 logros.
    // ══════════════════════════════════════════════════════════════════
    const CARD_HEIGHT   = 148;  // px — debe coincidir con el CSS
    const CARD_GAP      = 12;   // px gap entre cards
    const ROW_PAD_PX    = 15;   // padding lateral del contenedor
    const OVERSCAN_ROWS = 4;    // filas extra arriba/abajo para suavidad (más en gama baja)

    let _vsColCount   = 2;      // columnas actuales (se recalcula)
    let _vsRowHeight  = CARD_HEIGHT + CARD_GAP;
    let _vsRendered   = new Map(); // rowIndex -> DOM row element
    let _vsAchSet     = null;   // Set live de logros desbloqueados
    let _vsPinned     = [];
    let _vsDisplayPin = [];
    let _vsScrollEl   = null;
    let _vsSpacerEl   = null;
    let _vsContentEl  = null;
    let _vsInitialized = false;
    let _vsScrollRAF  = null;

    function _vsGetCols() {
        const w = window.innerWidth;
        if (w >= 1500) return 6;
        if (w >= 1200) return 5;
        if (w >= 900)  return 4;
        if (w >= 600)  return 3;
        return 2;
    }

    function _vsCardHTML(ach, isUnlocked, isManualPin, isInProfile) {
        let cls = 'ach-card';
        if (isUnlocked)   cls += ' unlocked';
        if (isManualPin)  cls += ' pinned';
        else if (isInProfile) cls += ' in-profile';

        const bdrColor = isUnlocked ? ach.color : '';
        let shadow = '';
        if (isManualPin)       shadow = `0 0 14px ${ach.color}66`;
        else if (isInProfile)  shadow = `0 0 7px ${ach.color}33`;

        let badge = '';
        if (isManualPin)      badge = `<div class="ach-pin-badge ach-pin-manual">${SVG_PIN}</div>`;
        else if (isInProfile) badge = `<div class="ach-pin-badge ach-pin-auto">★</div>`;

        const isHidden = ach.hidden && !isUnlocked;
        const iconColor = isUnlocked ? ach.color : 'var(--text-secondary)';
        const iconSVG   = isUnlocked ? ach.icon  : SVG_LOCK;
        const title     = isHidden ? '???' : ach.title;
        const desc      = isUnlocked ? ach.desc  : (isHidden ? 'Logro secreto — descúbrelo tú mismo.' : 'Sigue jugando para descubrirlo.');

        return `<div class="${cls}" style="border-color:${bdrColor};box-shadow:${shadow}" onclick="togglePin('${ach.id}')">`+
            badge +
            `<div class="ach-icon" style="color:${iconColor}">${iconSVG}</div>`+
            `<div class="ach-title">${title}</div>`+
            `<div class="ach-desc">${desc}</div>`+
            `</div>`;
    }

    function _vsRenderRow(rowIdx) {
        if (_vsRendered.has(rowIdx)) return;
        const cols   = _vsColCount;
        const start  = rowIdx * cols;
        const end    = Math.min(start + cols, ACHIEVEMENTS_DATA.length);
        if (start >= ACHIEVEMENTS_DATA.length) return;

        const rowEl = document.createElement('div');
        rowEl.className = 'ach-vrow';
        rowEl.style.cssText = `position:absolute;left:${ROW_PAD_PX}px;right:${ROW_PAD_PX}px;top:${rowIdx * _vsRowHeight}px;grid-template-columns:repeat(${cols},1fr);`;

        let html = '';
        for (let i = start; i < end; i++) {
            const ach         = ACHIEVEMENTS_DATA[i];
            const isUnlocked  = _vsAchSet.has(ach.id);
            const isManualPin = _vsPinned.includes(ach.id);
            const isInProfile = _vsDisplayPin.includes(ach.id);
            html += _vsCardHTML(ach, isUnlocked, isManualPin, isInProfile);
        }
        rowEl.innerHTML = html;
        _vsContentEl.appendChild(rowEl);
        _vsRendered.set(rowIdx, rowEl);
    }

    function _vsRemoveRow(rowIdx) {
        const el = _vsRendered.get(rowIdx);
        if (el) { el.remove(); _vsRendered.delete(rowIdx); }
    }

    function _vsOnScroll() {
        if (_vsScrollRAF) cancelAnimationFrame(_vsScrollRAF);
        _vsScrollRAF = requestAnimationFrame(() => {
            _vsScrollRAF = null;
            _vsUpdate();
        });
    }

    function _vsUpdate() {
        if (!_vsScrollEl || !_vsSpacerEl) return;
        const scrollTop    = _vsScrollEl.scrollTop;
        const viewHeight   = _vsScrollEl.clientHeight;
        const totalRows    = Math.ceil(ACHIEVEMENTS_DATA.length / _vsColCount);

        const firstRow = Math.max(0, Math.floor(scrollTop / _vsRowHeight) - OVERSCAN_ROWS);
        const lastRow  = Math.min(totalRows - 1, Math.ceil((scrollTop + viewHeight) / _vsRowHeight) + OVERSCAN_ROWS);

        // Remove rows that scrolled out
        for (const [idx] of _vsRendered) {
            if (idx < firstRow || idx > lastRow) _vsRemoveRow(idx);
        }
        // Add rows that scrolled in
        for (let r = firstRow; r <= lastRow; r++) _vsRenderRow(r);
    }

    function _vsRefreshAll() {
        // Flush all rendered rows and re-render visible ones
        for (const [, el] of _vsRendered) el.remove();
        _vsRendered.clear();
        _vsUpdate();
    }

    function _vsSetup() {
        _vsScrollEl  = document.getElementById('vscroll-container');
        _vsSpacerEl  = document.getElementById('vscroll-spacer');
        _vsContentEl = document.getElementById('vscroll-content');
        if (!_vsScrollEl) return;

        _vsScrollEl.addEventListener('scroll', _vsOnScroll, { passive: true });
        window.addEventListener('resize', () => {
            const newCols = _vsGetCols();
            if (newCols !== _vsColCount) {
                _vsColCount = newCols;
                const totalRows = Math.ceil(ACHIEVEMENTS_DATA.length / _vsColCount);
                const totalH    = totalRows * _vsRowHeight;
                _vsSpacerEl.style.height = totalH + 'px';
                _vsRefreshAll();
            }
        });
        _vsInitialized = true;
    }

    // Actualiza el estado y dispara re-render de filas afectadas
    function renderAchievements() {
        if (!_vsInitialized) _vsSetup();
        if (!_vsScrollEl)    return;

        _vsAchSet    = new Set(playerStats.achievements);
        _vsPinned    = playerStats.pinnedAchievements;
        _vsDisplayPin = getAutoProfileAchs();
        _vsColCount  = _vsGetCols();

        const totalRows = Math.ceil(ACHIEVEMENTS_DATA.length / _vsColCount);
        const totalH    = totalRows * _vsRowHeight;
        _vsSpacerEl.style.height = totalH + 'px';

        // Flush rendered rows so they rebuild with fresh state
        _vsRefreshAll();

        // Profile grid (solo 3 slots)
        const profileGrid = document.getElementById('profile-achievements-grid');
        if (profileGrid) {
            profileGrid.innerHTML = '';
            const frag = document.createDocumentFragment();
            let n = 0;
            _vsDisplayPin.forEach(id => {
                if (n >= 3) return;
                let ach = ACHIEVEMENTS_DATA.find(a => a.id === id);
                if (id === 'tramposo') ach = CHEATER_ACHIEVEMENT;
                if (!ach) return;
                const slot = document.createElement('div');
                slot.className = 'achievement-slot unlocked';
                slot.style.borderColor = ach.color;
                slot.style.boxShadow = `0 0 12px ${ach.color}44`;
                slot.innerHTML = `<div class="ach-icon" style="color:${ach.color}">${ach.icon}</div><div class="ach-title">${ach.title}</div>`;
                frag.appendChild(slot); n++;
            });
            while (n < 3) {
                const slot = document.createElement('div');
                slot.className = 'achievement-slot';
                slot.innerHTML = `<div class="ach-icon" style="color:var(--text-secondary)">${SVG_LOCK}</div><div class="ach-title" style="color:var(--text-secondary)">Vacío</div>`;
                frag.appendChild(slot); n++;
            }
            profileGrid.appendChild(frag);
        }

        const el = document.getElementById('achievements-progress-text');
        if (el) el.innerText = `Desbloqueados: ${_vsAchSet.size - (_vsAchSet.has('tramposo') ? 1 : 0)} / ${ACHIEVEMENTS_DATA.length}`;
    }

    // initializeAchievementsDOM y achCardElements ya no son necesarios con el virtual scroller
    let isAchievementsInitialized = true; // siempre true, setup es lazy
    const achCardElements = {};           // mantenido vacío para compatibilidad con código existente
    let _currentScreen = null;
    function switchScreen(id) { 
        if (_currentScreen) _currentScreen.classList.remove('active');
        const next = document.getElementById(id);
        setTimeout(() => { if(next) { next.classList.add('active'); _currentScreen = next; } }, 50); 
    }
    // Initialize current screen
    _currentScreen = document.querySelector('.screen.active');
    function goToMainMenu() { SFX.click(); switchScreen('start-screen'); }

    function onLogoClick() {
        if (!playerStats.clickedLogo) {
            playerStats.clickedLogo = true;
            saveStatsLocally();
            initAudio(); SFX.achievement();
            checkAchievements();
        } else {
            // Subtle bounce animation feedback
            const logo = document.getElementById('logo-title');
            if (logo) { logo.style.transform = 'scale(1.08)'; setTimeout(() => logo.style.transform = '', 200); }
        }
    }
    // Helper: marca una sección visitada en sesión y verifica si se han visitado todas
    function trackSectionVisit(section) {
        if (!Array.isArray(playerStats.sectionsVisitedThisSession)) playerStats.sectionsVisitedThisSession = [];
        if (!playerStats.sectionsVisitedThisSession.includes(section)) {
            playerStats.sectionsVisitedThisSession.push(section);
        }
        const ALL_SECTIONS = ['profile', 'achievements', 'ranking', 'guide', 'settings'];
        if (!playerStats.allSectionsVisited && ALL_SECTIONS.every(s => playerStats.sectionsVisitedThisSession.includes(s))) {
            playerStats.allSectionsVisited = true;
        }
    }

    function goToGuide() { initAudio(); SFX.click(); playerStats.guideViews++; trackSectionVisit('guide'); saveStatsLocally(); checkAchievements(); switchScreen('guide-screen'); }
    function goToAchievements() { initAudio(); SFX.click(); playerStats.achViews++; trackSectionVisit('achievements'); saveStatsLocally(); checkAchievements(); renderAchievements(); switchScreen('achievements-screen'); const sc = document.getElementById('vscroll-container'); if(sc) sc.scrollTop = 0; }
    
    function goToRanking() { 
        initAudio(); SFX.click();
        playerStats.rankingViews = (playerStats.rankingViews||0) + 1;
        trackSectionVisit('ranking');
        saveStatsLocally(); checkAchievements();
        switchScreen('ranking-screen');
    }


    function goToProfile(needsName = false) {
        initAudio(); SFX.click();
        playerStats.profileViews = (playerStats.profileViews||0) + 1;
        trackSectionVisit('profile');
        document.getElementById('stat-games').innerText = playerStats.gamesPlayed; document.getElementById('stat-score').innerText = playerStats.bestScore; document.getElementById('stat-streak').innerText = playerStats.maxStreak; document.getElementById('stat-days').innerText = playerStats.maxLoginStreak;
        document.getElementById('profile-name-input').value = (playerStats.playerName === "JUGADOR") ? "" : playerStats.playerName;
        document.getElementById('profile-warning').style.opacity = needsName ? '1' : '0';
        currentRankInfo = getRankInfo(playerStats); updateLogoDots(); document.getElementById('profile-rank-display').innerText = `Rango: ${currentRankInfo.title}`; document.getElementById('profile-rank-display').style.color = currentRankInfo.color;
        renderAchievements(); switchScreen('profile-screen');
        if (needsName) setTimeout(() => { document.getElementById('profile-name-input').focus(); document.getElementById('profile-name-input').classList.add('shake'); setTimeout(() => document.getElementById('profile-name-input').classList.remove('shake'), 400); }, 400);
    }

    async function startGameCheck() { 
        initAudio(); 
        if (!playerStats.playerName || playerStats.playerName === "JUGADOR") { 
            SFX.incorrect(); goToProfile(true); 
            return;
        } 
        if (quizDataPool.length === 0) {
            const btn = document.querySelector('.btn-solid');
            const originalText = btn.innerText;
            btn.innerText = "Cargando..."; btn.style.opacity = "0.7";
            await loadQuestions();
            btn.innerText = originalText; btn.style.opacity = "1";
        }
        startGame(); 
    }

    document.getElementById('profile-name-input').addEventListener('input', e => { e.target.value = e.target.value.replace(/[^a-zA-Z0-9ÁÉÍÓÚÑáéíóúñ ]/g, '').toUpperCase(); document.getElementById('profile-warning').style.opacity = e.target.value ? '0' : '1'; });
    document.getElementById('profile-name-input').addEventListener('change', e => { 
        const n = e.target.value.trim(); 
        if(n && n !== "JUGADOR" && n !== playerStats.playerName) playerStats.nameChanges++; 
        playerStats.playerName = n || "JUGADOR"; 
        saveStatsLocally(); checkAchievements(); 
        submitLeaderboard();
    });
    document.getElementById('profile-name-input').addEventListener('keypress', function(e) { if(e.key === 'Enter') this.blur(); });
    
    function updateLogoDots() { 
        document.documentElement.style.setProperty('--rank-rgb', currentRankInfo.rgb); 
        document.documentElement.style.setProperty('--rank-color', currentRankInfo.color); 
        document.querySelectorAll('.logo-dot').forEach(d => { d.style.color = currentRankInfo.color; d.style.textShadow = `0 0 15px rgba(${currentRankInfo.rgb}, 0.5)`; }); 
        
        const favicon = document.getElementById('dynamic-favicon');
        if(favicon) {
            const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='rgb(${currentRankInfo.rgb})' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'><polygon points='13 2 3 14 12 14 11 22 21 10 12 10 13 2'></polygon></svg>`;
            favicon.href = `data:image/svg+xml,${encodeURIComponent(svg)}`;
        }
    }

    // --- Game Logic ---
    let currentSessionQuestions = [], currentQuestionIndex = 0, score = 0, streak = 0, currentMaxStreak = 0, timerInterval, timeLeft = 15; 
    const TIMER_LIMIT = 15;
    let currentFastAnswers = 0, currentWrongAnswers = 0, currentTimeoutAnswers = 0, isAnsweringAllowed = false, currentGameLog = [];
    let isGamePaused = false;
    let lives = 3;
    let multiplier = 1;
    let lastSecondAnswers = 0; 
    let ultraFastStreak = 0;   

    function startGame() {
        initAudio(); SFX.gameStart();
        
        // Track same-track-game streak for achievement
        const lastTrack = playerStats.lastGameTrack || '';
        const curTrack = playerStats.selectedTrack || 'track_chill';
        // Always register current track as tried
        if (!playerStats.tracksTriedSet) playerStats.tracksTriedSet = [];
        if (!playerStats.tracksTriedSet.includes(curTrack)) playerStats.tracksTriedSet.push(curTrack);
        if (playerStats.tracksTriedSet.length >= 3) playerStats.triedAllTracks = true;
        if (lastTrack === curTrack) {
            playerStats.sameTrackGames = (playerStats.sameTrackGames || 0) + 1;
        } else {
            playerStats.sameTrackGames = 1;
        }
        playerStats.lastGameTrack = curTrack;
        
        const hora = new Date().getHours();
        if(hora>=23||hora<1) playerStats.playedNocturno=true;
        if(hora<6) playerStats.playedMadrugador=true;
        
        const todayStr2 = new Date().toISOString().split('T')[0];
        if(!playerStats.totalDaysPlayed) playerStats.totalDaysPlayed = 0;
        if(!playerStats.lastPlayedDay || playerStats.lastPlayedDay !== todayStr2) {
            playerStats.lastPlayedDay = todayStr2;
            playerStats.totalDaysPlayed++;
        }
        
        document.getElementById('player-name-display').innerText = playerStats.playerName; 
        document.getElementById('final-name').innerText = playerStats.playerName;
        
        currentSessionQuestions = shuffleArray([...quizDataPool]);
        _recentQuestionIds.clear(); _recentQueue = [];
        currentQuestionIndex = score = streak = currentMaxStreak = currentFastAnswers = currentWrongAnswers = currentTimeoutAnswers = 0; 
        currentGameLog = []; isGamePaused = false;
        lives = 3; multiplier = 1;
        lastSecondAnswers = 0; ultraFastStreak = 0;
        
        document.getElementById('lives-container').style.display = 'flex';
        document.getElementById('progress-container').style.display = 'none';
        document.getElementById('score-display').innerText = 0;
        updateLivesUI(); updateMultiplierUI(); updateStreakVisuals();
        
        showCountdown(() => {
            switchScreen('question-screen');
            setTimeout(loadQuestion, 200);
        });
    }

    function showCountdown(callback) {
        switchScreen('countdown-screen');
        const numEl = document.getElementById('countdown-number');
        const lblEl = document.getElementById('countdown-label');
        const steps = [
            { text: '3', label: 'Prepárate...' },
            { text: '2', label: '¡Concéntrate!' },
            { text: '1', label: '¡Ya casi!' },
            { text: '¡YA!', label: '' }
        ];
        let i = 0;
        function tick() {
            if (i >= steps.length) { callback(); return; }
            numEl.style.transform = 'scale(0.5)'; numEl.style.opacity = '0';
            lblEl.style.opacity = '0';
            setTimeout(() => {
                numEl.textContent = steps[i].text;
                lblEl.textContent = steps[i].label;
                numEl.style.transform = 'scale(1)'; numEl.style.opacity = '1';
                lblEl.style.opacity = '1';
                SFX.tick();
                i++;
                setTimeout(tick, i < steps.length ? 800 : 400);
            }, 150);
        }
        tick();
    }

    function updateLivesUI() {
        const c = document.getElementById('lives-container');
        c.innerHTML = '';
        for(let i = 0; i < 3; i++) {
            let el = document.createElement('div');
            el.innerHTML = SVG_BOLT;
            if(i >= lives) el.classList.add('life-lost');
            c.appendChild(el);
        }
    }

    function updateMultiplierUI() {
        const b = document.getElementById('multiplier-badge');
        multiplier = Math.min(10, Math.max(1, Math.floor(streak / 5) + 1));
        if(multiplier > (playerStats.maxMult||1)) { playerStats.maxMult = multiplier; }
        if(multiplier > 1) {
            b.style.display = 'block';
            b.innerText = `x${multiplier}`;
            const cls = multiplier <= 6 ? `mult-x${multiplier}` :
                        multiplier === 7 ? 'mult-x7' :
                        multiplier === 8 ? 'mult-x8' :
                        multiplier === 9 ? 'mult-x9' : 'mult-x10';
            b.className = 'multiplier-badge ' + cls;
        } else {
            b.style.display = 'none';
            b.className = 'multiplier-badge';
        }
    }
    
    function updateStreakVisuals() { 
        const app = document.getElementById('app'); 
        if (streak >= 5) { 
            if (!app.classList.contains('streak-active')) { app.classList.add('streak-active'); SFX.streakTrigger(); }
            // Efecto visual escalado según multiplicador alcanzado
            if (streak % 5 === 0) {
                triggerMultiplierEffect(multiplier);
            }
        } else app.classList.remove('streak-active'); 
    }

    function triggerMultiplierEffect(mult) {
        // Effects removed per user request — multiplier badge CSS handles visual feedback
    }

    // Smart question engine: tracks recently used questions to avoid repetition
    const _recentQuestionIds = new Set();
    const _RECENT_WINDOW = 20; // avoid repeating same question within last 20
    let _recentQueue = [];

    function _markUsed(q) {
        const key = q.question.slice(0, 30);
        if (_recentQueue.length >= _RECENT_WINDOW) {
            const oldest = _recentQueue.shift();
            _recentQuestionIds.delete(oldest);
        }
        _recentQueue.push(key);
        _recentQuestionIds.add(key);
    }

    function getNextQuestion() {
        if (currentQuestionIndex >= currentSessionQuestions.length - 2) {
            // Rebuild with fresh shuffle, excluding recently used if pool allows
            const fresh = shuffleArray([...quizDataPool]);
            const notRecent = fresh.filter(q => !_recentQuestionIds.has(q.question.slice(0, 30)));
            const pool = notRecent.length >= 10 ? notRecent : fresh;
            currentSessionQuestions = currentSessionQuestions.concat(pool);
        }
        const q = currentSessionQuestions[currentQuestionIndex];
        if (q) _markUsed(q);
        return q;
    }
    
    function loadQuestion() {
        const currentQ = getNextQuestion();
        const timerPath = document.getElementById('timer-path');
        const timerText = document.getElementById('timer-display');
        
        document.getElementById('question-text').innerText = currentQ.question;
        
        let mixedAnswers = currentQ.answers.map((text, idx) => ({ text: text, isCorrect: idx === currentQ.correctIndex }));
        mixedAnswers = shuffleArray(mixedAnswers);
        for(let i=0; i<4; i++) { 
            document.getElementById(`ans-${i}`).innerText = mixedAnswers[i].text;
            if (mixedAnswers[i].isCorrect) currentQ.currentCorrectIndex = i;
        }

        document.getElementById('answers-grid').classList.remove('answered'); 
        document.querySelectorAll('.answer-btn').forEach(btn => btn.classList.remove('selected'));
        isAnsweringAllowed = true; isGamePaused = false; timeLeft = TIMER_LIMIT; timerText.innerText = timeLeft; 
        
        timerPath.style.transition = 'none'; timerPath.style.strokeDashoffset = '0'; timerPath.style.stroke = 'var(--text-primary)'; timerText.style.color = 'var(--text-primary)'; void timerPath.offsetWidth; timerPath.style.transition = 'stroke-dashoffset 1s linear, stroke 0.3s ease';
        
        clearInterval(timerInterval); 
        timerInterval = setInterval(() => { 
            if (isGamePaused) return;
            timeLeft--; timerText.innerText = timeLeft; timerPath.style.strokeDashoffset = 283 - (timeLeft/TIMER_LIMIT)*283; 
            if(timeLeft <= 5 && timeLeft > 0) { SFX.tick(); timerPath.style.stroke = 'var(--accent-red)'; timerText.style.color = 'var(--accent-red)'; } 
            if(timeLeft <= 0) handleTimeout(); 
        }, 1000);
    }
    
    function selectAnswer(selectedIndex) {
        if (!isAnsweringAllowed || isGamePaused) return; isAnsweringAllowed = false; clearInterval(timerInterval); SFX.select();
        document.getElementById('answers-grid').classList.add('answered'); document.querySelectorAll('.answer-btn')[selectedIndex].classList.add('selected');
        
        const q = getNextQuestion();
        const isCorrect = (selectedIndex === q.currentCorrectIndex); 
        const answerTime = timeLeft;
        currentGameLog.push({ correct: isCorrect, time: answerTime });
        
        if(isCorrect) { 
            playerStats.totalCorrect++; 
            if(answerTime >= TIMER_LIMIT - 2) { currentFastAnswers++; playerStats.fastAnswersTotal++; }
            if(answerTime <= 1) lastSecondAnswers++;
            if(answerTime >= TIMER_LIMIT - 3) { ultraFastStreak++; } else { ultraFastStreak = 0; }
        } else { 
            playerStats.totalWrong++; currentWrongAnswers++;
            ultraFastStreak = 0;
        }
        
        saveStatsDebounced(); setTimeout(() => showFeedback(isCorrect), 600);
    }
    
    function handleTimeout() {
        if (!isAnsweringAllowed || isGamePaused) return; isAnsweringAllowed = false; clearInterval(timerInterval); 
        playerStats.totalTimeouts++; currentTimeoutAnswers++; 
        currentGameLog.push({ correct: false, timeout: true, time: 0 });
        ultraFastStreak = 0;
        saveStatsDebounced(); document.getElementById('answers-grid').classList.add('answered'); setTimeout(() => showFeedback(false, true), 600);
    }

    function abandonGame() {
        if(lives <= 0) return; // partida ya terminada
        SFX.click();
        isGamePaused = true;
        clearInterval(timerInterval);
        document.getElementById('abandon-modal').classList.add('active');
    }

    function cancelAbandon() {
        SFX.click();
        isGamePaused = false;
        document.getElementById('abandon-modal').classList.remove('active');
    }

    function confirmAbandon() {
        document.getElementById('abandon-modal').classList.remove('active');
        isAnsweringAllowed = false;
        clearInterval(timerInterval);
        initAudio(); SFX.incorrect(); 
        const penalty = 300; 
        playerStats.totalScore = Math.max(0, playerStats.totalScore - penalty);
        saveStatsLocally(); submitLeaderboard(); 
        showToast('Partida Abandonada', `Penalidad de -300 pts.`, 'var(--text-secondary)', SVG_INCORRECT);
        document.getElementById('app').classList.remove('streak-active');
        streak = 0;
        switchScreen('start-screen');
    }

    function replayGame() {
        SFX.click();
        startGame();
    }

    function animateScore(target) {
        const el = document.getElementById('score-display'); let curr = parseInt(el.innerText); const diff = target - curr; if(diff <= 0) return;
        const step = Math.ceil(diff / 20), t = setInterval(() => { curr += step; if(curr >= target) { curr = target; clearInterval(t); } el.innerText = curr; }, 20);
    }
    
    function showFeedback(isCorrect, isTimeout = false) {
        const scr = document.getElementById('feedback-screen'), icon = document.getElementById('feedback-icon-container'), title = document.getElementById('feedback-title'), points = document.getElementById('feedback-points');
        
        if (isCorrect) {
            SFX.correct(); scr.className = 'screen correct'; icon.innerHTML = SVG_CORRECT; 
            title.innerText = currentRankInfo.title === 'Leyenda' ? '¡LEYENDA!' : currentRankInfo.title === 'Maestro' ? '¡Maestro!' : currentRankInfo.title === 'Pro' ? '¡Pro!' : currentRankInfo.title === 'Junior' ? '¡Junior!' : '¡Excelente!';
            let earned = 800 + Math.round((timeLeft / TIMER_LIMIT) * 800);
            earned = earned * multiplier;
            score += earned; streak++; if(streak > currentMaxStreak) currentMaxStreak = streak;
            // np1: 10 aciertos seguidos con las 3 vidas intactas — solo válido in-game
            if (streak >= 10 && lives === 3) {
                if (!playerStats.achievements.includes('np1')) {
                    playerStats.achievements.push('np1');
                    SFX.achievement();
                    showToast('Logro Desbloqueado', 'Examen de Oro', colors.yellow, SVG_SHIELD);
                    saveStatsLocally(); renderAchievements();
                }
            }
            if (streak > 0 && streak % 5 === 0) { playerStats.frenziesTriggered++; playerStats.currentFrenzyStreak = (playerStats.currentFrenzyStreak||0) + 1; }
            if ((playerStats.currentFrenzyStreak||0) > (playerStats.maxFrenzyStreak||0)) playerStats.maxFrenzyStreak = playerStats.currentFrenzyStreak;
            points.innerText = `+${earned}`; points.style.display = 'block';
        } else {
            SFX.incorrect(); 
            if (isTimeout) { scr.className = 'screen timeout'; icon.innerHTML = SVG_TIMEOUT; title.innerText = "Tiempo Agotado"; } 
            else { scr.className = 'screen incorrect'; icon.innerHTML = SVG_INCORRECT; title.innerText = "Incorrecto"; }
            streak = 0; points.style.display = 'none';
            playerStats.currentFrenzyStreak = 0;
            lives--;
            updateLivesUI();
        }
        
        updateMultiplierUI();
        document.getElementById('streak-display').innerText = streak; 
        updateStreakVisuals(); 
        switchScreen('feedback-screen'); 
        setTimeout(() => animateScore(score), 300); 
        checkAchievements();
        
        setTimeout(() => { 
            currentQuestionIndex++;
            if(lives > 0) {
                switchScreen('question-screen'); setTimeout(loadQuestion, 400);
            } else {
                endGame();
            }
        }, 2000);
    }
    
    function saveGameStats() {
        playerStats.gamesPlayed++; playerStats.todayGames++; playerStats.totalScore += score; 
        if(score > playerStats.bestScore) playerStats.bestScore = score; 
        if(currentMaxStreak > playerStats.maxStreak) playerStats.maxStreak = currentMaxStreak;
        if(score >= 100000) playerStats.maxScoreCount++;
        if(!playerStats.maxQuestionReached || currentQuestionIndex > playerStats.maxQuestionReached) playerStats.maxQuestionReached = currentQuestionIndex;
        if(currentQuestionIndex >= 50) playerStats.perfectGames = (playerStats.perfectGames||0) + 1;
        playerStats.previousGameScore = score; 
        currentRankInfo = getRankInfo(playerStats); updateLogoDots(); saveStatsLocally(); checkAchievements();
        submitLeaderboard(); 
    }
    
    function endGame() {
        document.getElementById('final-score-display').innerText = score.toLocaleString(); saveGameStats();
        
        SFX.gameEnd();
        
        const msg = document.getElementById('final-message');
        const rankLabel = document.getElementById('end-rank-label');

        if(score > 300000) { msg.innerText = "Leyenda"; if(rankLabel) rankLabel.innerText = "Clasificacion Final"; }
        else if(score > 100000) { msg.innerText = "Superviviente Nato"; if(rankLabel) rankLabel.innerText = "Resultado"; }
        else if(score > 25000) { msg.innerText = "Buen Desempeno"; if(rankLabel) rankLabel.innerText = "Resultado"; }
        else { msg.innerText = "Sigue Practicando"; if(rankLabel) rankLabel.innerText = "Resultado"; }

        document.getElementById('final-name').innerText = playerStats.playerName || 'ESTUDIANTE';
        document.getElementById('final-correct-label').innerText = 'Aciertos';
        document.getElementById('final-correct').innerText = currentQuestionIndex - currentWrongAnswers - currentTimeoutAnswers;
        document.getElementById('final-streak').innerText = currentMaxStreak; 
        document.getElementById('final-speed').innerText = currentFastAnswers;
        
        document.getElementById('app').classList.remove('streak-active'); streak = 0; switchScreen('end-screen');
    }

    // --- FPS Controlled Particles (optimized: batched canvas draws) ---
    const canvas = document.getElementById('particle-canvas'); 
    const ctx = canvas.getContext('2d', { alpha: true }); 
    let particlesArray = [];
    let fpsInterval = 1000 / playerStats.maxFps; let then = performance.now();
    
    function initParticles() { 
        canvas.width = window.innerWidth; canvas.height = window.innerHeight; particlesArray = []; 
        const isMobile = window.innerWidth < 768;
        let num = Math.min((canvas.width * canvas.height) / 12000, isMobile ? 40 : 80); 
        for (let i = 0; i < num; i++) {
            particlesArray.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                dx: (Math.random() - 0.5) * 0.8,
                dy: (Math.random() - 0.5) * 0.8,
                s: Math.random() * 1.5 + 0.5
            });
        }
    }
    
    function updateAndDrawParticles(timeScale, pulse) {
        const m = streak >= 5 ? 2.5 : 1;
        const speedBoost = 1 + (pulse * 1.2);  // subtle music reactivity
        const sizeBoost = 1 + pulse * 0.8;      // minimal size growth with beat
        const dynamicOpacity = Math.min(1, (streak >= 5 ? 0.65 : 0.42) * playerStats.particleOpacity + pulse * 0.12);
        const rgb = currentRankInfo.rgb;
        const W = canvas.width, H = canvas.height;
        
        // Batch all particle circles into one path
        ctx.beginPath();
        ctx.fillStyle = `rgba(${rgb}, ${dynamicOpacity})`;
        
        for (let i = 0; i < particlesArray.length; i++) {
            const p = particlesArray[i];
            // Bounce off walls
            if (p.x > W || p.x < 0) p.dx = -p.dx;
            if (p.y > H || p.y < 0) p.dy = -p.dy;
            // Move
            p.x += p.dx * m * timeScale * speedBoost;
            p.y += p.dy * m * timeScale * speedBoost;
            // Draw with subtle music reactivity
            const r = (p.s + pulse * 1.0) * sizeBoost;
            ctx.moveTo(p.x + r, p.y);
            ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
        }
        ctx.fill();
    }
    
    function connectParticles(pulse) { 
        const isStreak = streak >= 5;
        const baseOpacity = isStreak ? 0.35 : 0.18;
        const rgb = currentRankInfo.rgb;
        const distMult = 1 + pulse * 0.3;
        const maxDistSq = (canvas.width / 9) * (canvas.height / 9) * distMult;
        const pOp = playerStats.particleOpacity;
        const n = particlesArray.length;
        
        ctx.lineWidth = (0.6 + pulse * 0.8) * (isStreak ? 1.3 : 1);
        
        for (let a = 0; a < n; a++) { 
            for (let b = a + 1; b < n; b++) { 
                const dx = particlesArray[a].x - particlesArray[b].x;
                const dy = particlesArray[a].y - particlesArray[b].y;
                const distSq = dx * dx + dy * dy;
                if (distSq < maxDistSq) { 
                    const alpha = (1 - distSq / maxDistSq) * (baseOpacity + pulse * 0.1) * pOp;
                    ctx.strokeStyle = `rgba(${rgb},${alpha.toFixed(2)})`; 
                    ctx.beginPath(); 
                    ctx.moveTo(particlesArray[a].x, particlesArray[a].y); 
                    ctx.lineTo(particlesArray[b].x, particlesArray[b].y); 
                    ctx.stroke(); 
                } 
            } 
        } 
    }
    
    function animateParticles(now) { 
        requestAnimationFrame(animateParticles); 
        const elapsed = now - then; 
        if (elapsed > fpsInterval) { 
            then = now; // Reset cleanly — no debt accumulation
            // Clamp timeScale to prevent jump on tab focus restore
            let timeScale = Math.min(elapsed / 16.666, 2.5);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // If opacity is 0, don't draw anything (background disappears fully)
            if (!playerStats || playerStats.particleOpacity <= 0) return;
            
            const pulse = getAudioPulse(); 
            updateAndDrawParticles(timeScale, pulse);
            connectParticles(pulse); 
        } 
    }
    
    window.addEventListener('resize', () => initParticles()); initParticles(); requestAnimationFrame(animateParticles);

    // Reset particle timer when tab becomes visible to prevent accumulated frame debt causing speed burst
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            then = performance.now();
        }
    });

    setTimeout(() => { processDailyLogin(); currentRankInfo = getRankInfo(playerStats); updateLogoDots(); revokeInvalidAchievements(); checkAchievements(); submitLeaderboard(); fetchLeaderboard(); loadQuestions(); }, 500);
</script>
</body>
</html>
