<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Klick - Experiencia de Aprendizaje</title>
    <link id="dynamic-favicon" rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300ff66' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolygon points='13 2 3 14 12 14 11 22 21 10 12 10 13 2'%3E%3C/polygon%3E%3C/svg%3E">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800;900&display=swap');

        :root {
            --bg-base: #050505;
            --bg-surface: #111111;
            --bg-elevated: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            
            --accent-red: #ff2a5f;
            --accent-blue: #00d4ff;
            --accent-yellow: #ffb800;
            --accent-green: #00ff66;
            --accent-purple: #b5179e;
            --accent-orange: #f77f00;
            
            --bpd-gold: #f59e0b; 
            --bpd-gold-light: #fbbf24;

            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;

            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            
            --rank-rgb: 0, 255, 102;
            --rank-color: #00ff66;
        }

        * { 
            box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; 
            user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
            -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; 
        }
        body, html { width: 100%; height: 100%; overflow: hidden; background-color: var(--bg-base); color: var(--text-primary); }

        #app { width: 100%; height: 100%; position: relative; background: radial-gradient(circle at 50% -20%, rgba(255,255,255,0.03) 0%, transparent 70%); transition: background 0.5s ease; }
        #app.streak-active { background: radial-gradient(circle at 50% 50%, rgba(var(--rank-rgb), 0.15) 0%, var(--bg-base) 80%); animation: streak-pulse 1.5s infinite alternate ease-out; }
        @keyframes streak-pulse { 0% { box-shadow: inset 0 0 0px rgba(var(--rank-rgb), 0); } 100% { box-shadow: inset 0 0 60px rgba(var(--rank-rgb), 0.15); } }

        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        .screen { width: 100%; height: 100%; flex-direction: column; position: absolute; top: 0; left: 0; opacity: 0; visibility: hidden; pointer-events: none; transform: scale(0.97) translateY(10px); transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; z-index: 1; }
        .screen.active { opacity: 1; visibility: visible; pointer-events: auto; transform: scale(1) translateY(0); z-index: 10; }

        .glass-panel { background: rgba(17, 17, 17, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 15px 35px rgba(0,0,0,0.5); }

        #start-screen { justify-content: center; align-items: center; position: relative; }

        /* Botones superiores */
        .top-btn-container { position: absolute; top: 25px; display: flex; gap: 15px; z-index: 20; width: 100%; justify-content: space-between; padding: 0 25px; pointer-events: none; }
        .top-btn { pointer-events: auto; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; transition: all 0.3s; }
        .top-btn:hover { color: var(--text-primary); background: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }
        .top-btn svg { width: 26px; height: 26px; }

        .logo-container { font-size: clamp(3.5rem, 10vw, 7rem); font-weight: 900; font-style: italic; letter-spacing: -2px; color: var(--text-primary); text-align: center; line-height: 1; }
        .logo-dot { color: var(--accent-green); transition: color 0.5s ease; font-style: normal; }
        .logo-subtitle { font-size: clamp(0.7rem, 2vw, 0.9rem); font-weight: 600; letter-spacing: 4px; color: var(--text-secondary); margin-top: 5px; margin-bottom: 40px; display: block; text-transform: uppercase; text-align: center; }

        .menu-box { display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 360px; }
        .btn-solid, .btn-outline, .btn-bpd { width: 100%; padding: clamp(14px, 2.5vh, 18px); font-size: 1rem; font-weight: 800; letter-spacing: 1.5px; border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease-out; display: flex; justify-content: center; align-items: center; text-transform: uppercase; gap: 10px; }
        
        /* Botones del menú principal – paleta unificada */
        .btn-solid { color: var(--rank-color); background-color: rgba(var(--rank-rgb), 0.08); border: 1px solid rgba(var(--rank-rgb), 0.6); }
        .btn-solid:hover { background-color: rgba(var(--rank-rgb), 0.18); border-color: var(--rank-color); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(var(--rank-rgb), 0.25); }
        .btn-solid:active { transform: scale(0.96); }

        .btn-outline { color: rgba(var(--rank-rgb), 0.7); background-color: transparent; border: 1px solid rgba(var(--rank-rgb), 0.25); }
        .btn-outline:hover { color: var(--rank-color); border-color: rgba(var(--rank-rgb), 0.6); background-color: rgba(var(--rank-rgb), 0.08); transform: translateY(-2px); }
        .btn-outline:active { transform: scale(0.96); }

        .btn-bpd { color: var(--bpd-gold); background-color: rgba(245, 158, 11, 0.06); border: 1px solid rgba(245, 158, 11, 0.4); }
        .btn-bpd:hover:not(:disabled) { background-color: rgba(245, 158, 11, 0.15); border-color: var(--bpd-gold-light); color: var(--bpd-gold-light); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(245, 158, 11, 0.2); }
        .btn-bpd:active { transform: scale(0.96); }

        .top-nav { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--bg-elevated); background: rgba(5, 5, 5, 0.6); backdrop-filter: blur(15px); z-index: 10; flex-shrink: 0; }
        .btn-back { background: transparent; color: var(--text-secondary); border: 1px solid var(--bg-elevated); padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; width: 110px; }
        .btn-back:hover { color: var(--text-primary); border-color: var(--text-primary); background: rgba(255,255,255,0.05); }
        .nav-title { font-weight: 800; letter-spacing: 2px; color: var(--text-primary); text-align: center; flex: 1; text-transform: uppercase; font-size: 0.9rem; }
        .nav-spacer { width: 110px; display: block; }

        .content-fit { width: 100%; height: calc(100% - 65px); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: clamp(10px, 2vh, 20px); overflow: hidden; }
        .content-scroll { width: 100%; height: calc(100% - 65px); display: flex; flex-direction: column; align-items: center; padding: 20px 15px 40px 15px; overflow-y: auto; }
        .content-scroll::-webkit-scrollbar { width: 6px; } .content-scroll::-webkit-scrollbar-track { background: transparent; } .content-scroll::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 10px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Modales */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s var(--ease-out); z-index: 100; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        /* --- Pantalla de Configuración --- */
        .settings-dashboard { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: clamp(15px, 2vh, 30px); margin: 0 auto; justify-content: center; min-height: 100%; padding-bottom: 20px; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: clamp(15px, 2vw, 25px); width: 100%; }
        .setting-card { padding: clamp(20px, 3vh, 30px); border-radius: var(--radius-lg); border: 1px solid var(--bg-elevated); display: flex; flex-direction: column; gap: 20px; transition: all 0.3s ease; }
        .setting-card:hover { border-color: rgba(255,255,255,0.1); transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .setting-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .setting-title-box { display: flex; align-items: center; gap: 15px; }
        .setting-icon { width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .setting-icon svg { width: 22px; height: 22px; }
        .setting-label { font-size: clamp(0.9rem, 1.5vw, 1.1rem); font-weight: 800; color: var(--text-primary); text-transform: uppercase; letter-spacing: 1px; display: flex; flex-direction: column; }
        .setting-desc { font-size: clamp(0.65rem, 1vw, 0.75rem); color: var(--text-secondary); margin-top: 4px; font-weight: 500; text-transform: none; letter-spacing: 0; }
        .setting-value { font-family: monospace; font-size: clamp(0.9rem, 1.5vw, 1.1rem); font-weight: 900; padding: 6px 14px; border-radius: var(--radius-sm); border: 1px solid rgba(255,255,255,0.05); }

        /* Estilos de Rango/Deslizadores */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 5px 0 0 0; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; background: rgba(0,0,0,0.6); border-radius: 4px; border: 1px solid rgba(255,255,255,0.05); box-shadow: inset 0 1px 3px rgba(0,0,0,0.8); }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 22px; width: 22px; border-radius: 50%; 
            background: var(--text-primary); margin-top: -8px; cursor: pointer;
            border: 4px solid var(--bg-elevated);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            transition: all 0.3s var(--ease-spring);
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.3); background: var(--rank-color); border-color: rgba(255,255,255,0.9); box-shadow: 0 0 15px rgba(var(--rank-rgb), 0.6); }
        input[type=range]::-webkit-slider-thumb:active { transform: scale(0.9); }
        /* ------------------------------------------- */

        /* Perfil */
        .profile-dashboard { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: clamp(10px, 2vh, 30px); height: 100%; justify-content: center; }
        .profile-hero { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: clamp(20px, 4vh, 40px); border-radius: var(--radius-lg); text-align: center; }
        .profile-rank { font-weight: 800; font-size: clamp(0.8rem, 1.5vw, 1rem); text-transform: uppercase; letter-spacing: 2px; }
        .profile-name-input { width: 100%; background: transparent; border: none; border-bottom: 2px solid var(--bg-elevated); color: var(--text-primary); font-size: clamp(1.8rem, 5vw, 3.5rem); font-weight: 900; text-align: center; padding: 5px 0; outline: none; text-transform: uppercase; transition: all 0.3s; }
        .profile-name-input:focus { border-bottom-color: var(--text-primary); }
        .profile-warning { color: var(--accent-red); font-size: 0.8rem; margin-top: 5px; font-weight: 600; opacity: 0; transition: opacity 0.3s ease; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: clamp(10px, 2vw, 20px); width: 100%; }
        .stat-card { padding: clamp(15px, 3vh, 25px) 10px; border-radius: var(--radius-md); border: 1px solid var(--bg-elevated); display: flex; flex-direction: column; align-items: center; text-align: center; gap: 5px; }
        .stat-value { font-size: clamp(1.5rem, 3vw, 2.5rem); font-weight: 900; color: var(--text-primary); line-height: 1; }
        .stat-label { font-size: clamp(0.6rem, 1vw, 0.8rem); color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .profile-achievements-title { font-size: clamp(0.9rem, 2vw, 1.2rem); font-weight: 800; text-align: center; color: var(--text-primary); text-transform: uppercase; margin-top: 5px; letter-spacing: 1px; }
        .profile-achievements-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: clamp(10px, 2vw, 15px); width: 100%; }
        .achievement-slot { background: rgba(17, 17, 17, 0.4); border: 1px dashed var(--bg-elevated); border-radius: var(--radius-md); padding: clamp(10px, 2vh, 20px); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; opacity: 0.4; filter: grayscale(1); }
        .achievement-slot.unlocked { border-style: solid; opacity: 1; filter: grayscale(0); background: rgba(17, 17, 17, 0.7); backdrop-filter: blur(10px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .ach-icon { width: clamp(24px, 4vw, 32px); height: clamp(24px, 4vw, 32px); }
        .ach-icon svg { width: 100%; height: 100%; }
        .ach-title { font-size: clamp(0.65rem, 1vw, 0.8rem); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; text-align: center; }

        /* Guía y Rangos */
        .guide-dashboard { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: clamp(5px, 1.5vh, 15px); height: 100%; justify-content: center; }
        .guide-grid { display: grid; grid-template-columns: 1fr 1fr; gap: clamp(5px, 1.5vw, 15px); width: 100%; }
        .guide-card { padding: clamp(15px, 2vh, 20px); border-radius: var(--radius-md); border: 1px solid var(--bg-elevated); display: flex; flex-direction: column; align-items: center; text-align: center; gap: 5px; }
        .guide-card.full-width { grid-column: 1 / -1; }
        .guide-icon { width: 30px; height: 30px; color: var(--text-primary); margin-bottom: 5px; }
        .guide-title { font-size: clamp(0.9rem, 1.5vw, 1.2rem); font-weight: 800; color: var(--text-primary); letter-spacing: -0.5px; }
        .guide-text { color: var(--text-secondary); font-size: clamp(0.75rem, 1.2vw, 0.9rem); line-height: 1.3; }
        .guide-text strong { color: var(--text-primary); }
        .rank-list { display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; width: 100%; gap: 5px; margin-top: 5px; }
        .rank-item { display: flex; flex-direction: column; align-items: center; padding: clamp(5px, 1vh, 10px); background: rgba(5,5,5,0.5); border-radius: var(--radius-sm); border: 1px solid var(--bg-elevated); flex: 1 1 30%; }
        .rank-item-name { font-weight: 800; font-size: clamp(0.8rem, 1.2vw, 1rem); text-transform: uppercase; margin-bottom: 2px; }
        .rank-item-pts { color: var(--text-secondary); font-size: clamp(0.65rem, 1vw, 0.8rem); line-height: 1.2; text-align: center; }

        /* Zona Canje BPD */
        .canje-dashboard { width: 100%; max-width: 900px; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; }
        .cheque-container { background: rgba(17, 17, 17, 0.7); backdrop-filter: blur(15px); border: 2px dashed var(--bpd-gold); border-radius: var(--radius-lg); padding: clamp(15px, 3vh, 25px) clamp(20px, 4vw, 40px); width: 100%; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: clamp(8px, 1.5vh, 15px); position: relative; overflow: hidden; }
        .cheque-top { display: flex; align-items: center; justify-content: space-between; gap: 15px; border-bottom: 1px solid rgba(245,158,11,0.3); padding-bottom: 10px; margin-bottom: 5px; }
        .cheque-top-left { display: flex; align-items: center; gap: 15px; }
        .cheque-top svg { width: clamp(25px, 4vw, 35px); height: clamp(25px, 4vw, 35px); color: var(--bpd-gold); }
        .cheque-title { font-size: clamp(1rem, 2.5vw, 1.5rem); font-weight: 900; color: var(--bpd-gold-light); text-transform: uppercase; letter-spacing: 1px; }
        .cheque-serial { font-family: monospace; color: var(--text-secondary); font-size: clamp(0.7rem, 1.2vw, 0.9rem); }
        
        .cheque-body { display: flex; flex-direction: column; gap: clamp(5px, 1vh, 10px); }
        .c-row { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px dotted var(--bg-elevated); padding-bottom: 2px; }
        .c-label { font-size: clamp(0.65rem, 1.2vw, 0.8rem); color: var(--text-secondary); text-transform: uppercase; font-weight: 800; letter-spacing: 1px; }
        .c-value { font-size: clamp(0.9rem, 1.8vw, 1.2rem); font-weight: 900; color: var(--text-primary); font-family: monospace; text-align: right; text-transform: uppercase; }
        .c-value.locked { color: var(--text-secondary); font-style: italic; }
        .c-value.gold { color: var(--bpd-gold-light); text-shadow: 0 0 10px rgba(245,158,11,0.3); font-size: clamp(1.2rem, 2.2vw, 1.5rem); }
        
        .cheque-footer { display: flex; flex-direction: row; justify-content: space-between; align-items: center; gap: 15px; margin-top: 5px; border-top: 1px solid rgba(245,158,11,0.2); padding-top: 10px; }
        .canje-status-text { text-align: left; font-size: clamp(0.75rem, 1.2vw, 0.9rem); font-weight: 800; color: var(--text-primary); line-height: 1.4; }
        .canje-status-sub { font-size: clamp(0.65rem, 1vw, 0.75rem); color: var(--text-secondary); display: block; font-weight: 500; margin-top: 2px; }
        .c-instruction { display: none; font-size: clamp(0.7rem, 1.2vw, 0.85rem); color: var(--accent-green); text-align: left; font-weight: 600; padding: 10px; background: rgba(0,255,102,0.1); border: 1px solid rgba(0,255,102,0.2); border-radius: var(--radius-sm); margin-top: 0; flex: 1; }

        /* Banco de Logros */
        .achievements-wrapper { width: 100%; max-width: 1400px; display: flex; flex-direction: column; gap: 20px; }
        .achievements-stats { text-align: center; color: var(--text-secondary); font-weight: 600; font-size: 0.9rem; letter-spacing: 1px; }
        .achievements-grid { display: grid; gap: 20px; width: 100%; }
        @media (min-width: 650px) { .achievements-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1100px) { .achievements-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1500px) { .achievements-grid { grid-template-columns: repeat(5, 1fr); } }
        .ach-card { background: rgba(17, 17, 17, 0.7); backdrop-filter: blur(10px); padding: 25px 20px; border-radius: var(--radius-md); border: 1px dashed var(--bg-elevated); display: flex; flex-direction: column; align-items: center; text-align: center; gap: 12px; opacity: 0.5; filter: grayscale(1); transition: all 0.3s ease; position: relative; cursor: pointer; }
        .ach-card:hover { transform: scale(1.02); }
        .ach-card.unlocked { border-style: solid; opacity: 1; filter: grayscale(0); background: rgba(25, 25, 25, 0.8); }
        .ach-card.pinned { box-shadow: 0 0 15px var(--accent-yellow) !important; border-color: var(--accent-yellow) !important; }
        .ach-card .ach-icon { width: 40px; height: 40px; margin-bottom: 5px;}
        .ach-card .ach-title { font-size: 1.1rem; color: var(--text-primary); font-weight: 800; }
        .ach-desc { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; font-style: italic;}
        .ach-card.unlocked .ach-desc { font-style: normal; }

        /* --- RANKING GLOBAL --- */
        .ranking-wrapper { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: 15px; }
        .ranking-list { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .rank-card { display: grid; grid-template-columns: 50px 1fr auto; align-items: center; background: rgba(17, 17, 17, 0.7); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: var(--radius-md); border: 1px solid var(--bg-elevated); transition: all 0.3s ease; }
        .rank-card:hover { background: rgba(255, 255, 255, 0.05); transform: translateX(5px); }
        .rc-pos { font-size: 1.5rem; font-weight: 900; color: var(--text-secondary); text-align: center; }
        .rc-info { display: flex; flex-direction: column; justify-content: center; gap: 2px; }
        .rc-name { font-size: 1.1rem; font-weight: 800; color: var(--text-primary); text-transform: uppercase; }
        .rc-title { font-size: 0.7rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .rc-score { font-size: 1.2rem; font-weight: 900; font-family: monospace; color: var(--accent-blue); text-align: right; }
        .rc-score span { font-size: 0.6rem; color: var(--text-secondary); vertical-align: middle; margin-left: 2px;}

        .rank-card.pos-1 { border-color: #ffd700; background: rgba(255, 215, 0, 0.05); }
        .rank-card.pos-1 .rc-pos { color: #ffd700; }
        .rank-card.pos-1 .rc-score { color: #ffd700; }
        
        .rank-card.pos-2 { border-color: #c0c0c0; background: rgba(192, 192, 192, 0.05); }
        .rank-card.pos-2 .rc-pos { color: #c0c0c0; }
        .rank-card.pos-2 .rc-score { color: #c0c0c0; }
        
        .rank-card.pos-3 { border-color: #cd7f32; background: rgba(205, 127, 50, 0.05); }
        .rank-card.pos-3 .rc-pos { color: #cd7f32; }
        .rank-card.pos-3 .rc-score { color: #cd7f32; }

        .rank-card.is-me { border-left: 4px solid var(--accent-green); }

        .ranking-loading { text-align: center; color: var(--text-secondary); padding: 40px; font-weight: 600; font-size: 1.1rem; }

        #countdown-screen { justify-content: center; align-items: center; }
        #countdown-number { transition: transform 0.25s var(--ease-spring), opacity 0.25s ease; }
        #countdown-label { transition: opacity 0.25s ease; }

        /* --- Pantalla de Pregunta --- */
        #question-screen { justify-content: space-between; }
        
        .top-bar { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 15px 20px; font-weight: 600; font-size: 0.9rem; color: var(--text-secondary); z-index: 5; }
        .top-bar > *:nth-child(1) { justify-self: start; display: flex; align-items: center; gap: 15px; }
        .top-bar > *:nth-child(2) { justify-self: center; text-align: center; font-size: 1rem; color: var(--text-primary); letter-spacing: 1px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .top-bar > *:nth-child(3) { justify-self: end; display: flex; align-items: center; gap: 10px; }
        
        .btn-abandon { background: transparent; color: var(--accent-red); border: 1px solid rgba(255, 42, 95, 0.5); padding: 6px 12px; border-radius: 20px; cursor: pointer; font-weight: 800; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; transition: all 0.2s; text-transform: uppercase; }
        .btn-abandon:hover { background: rgba(255, 42, 95, 0.2); border-color: var(--accent-red); transform: scale(0.95); }
        .btn-abandon svg { width: 14px; height: 14px; }

        #lives-container { display: flex; gap: 3px; color: var(--accent-yellow); }
        #lives-container svg { width: 16px; height: 16px; transition: all 0.3s; }
        .life-lost { opacity: 0.2; transform: scale(0.8); filter: grayscale(1); }

        .multiplier-badge { background: transparent; color: var(--accent-red); font-weight: 900; font-size: 1.2rem; display: none; text-shadow: 0 0 10px rgba(255,42,95,0.5); }

        .score-badge { background: transparent; color: var(--text-primary); padding: 6px 15px; border-radius: 30px; border: 1px solid var(--text-secondary); font-variant-numeric: tabular-nums; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .score-badge::before { content: ''; display: inline-block; width: 8px; height: 8px; background: var(--accent-yellow); border-radius: 50%; box-shadow: 0 0 10px var(--accent-yellow); }
        
        .question-container { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px 20px; gap: 20px; width: 100%; max-width: 1000px; margin: 0 auto; z-index: 5; }
        .timer-wrapper { position: relative; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; }
        .timer-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
        .timer-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 6; }
        .timer-path { fill: none; stroke: var(--text-primary); stroke-width: 6; stroke-linecap: round; stroke-dasharray: 283; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear, stroke 0.3s ease; }
        .timer-text { font-size: 1.4rem; font-weight: 800; color: var(--text-primary); font-variant-numeric: tabular-nums; }
        .question-text { font-size: clamp(1.4rem, 4vw, 2.5rem); font-weight: 800; text-align: center; line-height: 1.2; width: 100%; letter-spacing: -1px; }
        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 15px; padding: 10px 20px 30px 20px; flex: 0 0 45vh; max-width: 1400px; width: 100%; margin: 0 auto; z-index: 5; }
        .answer-btn { position: relative; background-color: transparent; border: 1px solid var(--text-secondary); border-radius: var(--radius-lg); color: var(--text-primary); font-size: clamp(1rem, 2vw, 1.2rem); font-weight: 600; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; opacity: 0; transform: translateY(20px); transition: transform 0.4s var(--ease-spring), opacity 0.4s var(--ease-out), background-color 0.2s, border-color 0.2s, filter 0.3s; }
        .screen.active .answer-btn { opacity: 1; transform: translateY(0); }
        .color-red { border-bottom: 2px solid var(--accent-red); } .color-blue { border-bottom: 2px solid var(--accent-blue); } .color-yellow { border-bottom: 2px solid var(--accent-yellow); } .color-green { border-bottom: 2px solid var(--accent-green); }
        .answer-btn:active { transform: scale(0.96); }
        .answers-grid.answered .answer-btn:not(.selected) { opacity: 0.2; transform: scale(0.95); filter: grayscale(1); pointer-events: none; }
        .answers-grid.answered .answer-btn.selected { background-color: rgba(255,255,255,0.1); transform: scale(1.02); z-index: 2; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .shape-icon { width: 28px; height: 28px; margin: 0 0 8px 0; }
        .progress-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: rgba(255,255,255,0.1); z-index: 10; }
        .progress-bar { height: 100%; background-color: var(--text-primary); width: 0%; transition: width 0.3s var(--ease-out); }

        /* --- Pantallas Extra --- */
        #feedback-screen { justify-content: center; align-items: center; text-align: center; }
        #feedback-screen.correct .feedback-title { color: var(--accent-green); } #feedback-screen.incorrect .feedback-title { color: var(--accent-red); }
        .feedback-content { display: flex; flex-direction: column; align-items: center; transform: scale(0.9); opacity: 0; transition: all 0.5s var(--ease-spring); }
        .screen.active .feedback-content { transform: scale(1); opacity: 1; }
        #feedback-icon-container svg { width: 80px; height: 80px; margin-bottom: 15px; }
        .feedback-title { font-size: clamp(2.5rem, 8vw, 4rem); font-weight: 900; margin-bottom: 5px; letter-spacing: -2px; }
        .feedback-points { font-size: 2rem; font-weight: 800; color: var(--text-primary); margin-bottom: 20px; font-variant-numeric: tabular-nums; background: transparent; padding: 5px 20px; border-radius: 30px; border: 1px solid var(--text-secondary); }
        .streak-box { font-size: 1rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 2px; }
        .streak-box span { color: var(--accent-yellow); font-weight: 900; font-size: 1.2rem; }

        /* --- PANTALLA DE FIN (Estética Homogeneizada) --- */
        #end-screen .settings-card {
            max-width: 450px; text-align: center; padding: 35px 30px;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .results-icon { width: 70px; height: 70px; background: rgba(var(--rank-rgb), 0.1); border-radius: 50%; color: var(--rank-color); display: flex; justify-content: center; align-items: center; margin: 0 auto; box-shadow: 0 0 20px rgba(var(--rank-rgb), 0.2); }
        .results-icon svg { width: 35px; height: 35px; }
        .podium-title { font-size: clamp(1.8rem, 5vw, 2.2rem); font-weight: 900; color: var(--text-primary); line-height: 1.1; margin-top: 5px;}
        .final-name { font-size: 1rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 2px; font-weight: 800;}
        .final-score-value { font-size: clamp(3.5rem, 10vw, 5rem); font-weight: 900; color: var(--text-primary); line-height: 1; text-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .results-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 20px; margin-bottom: 10px;}
        .r-stat { display: flex; flex-direction: column; align-items: center; gap: 3px; background: rgba(255,255,255,0.02); padding: 10px; border-radius: var(--radius-sm);}
        .r-stat-val { font-size: 1.3rem; font-weight: 900; color: var(--text-primary); }
        .r-stat-label { font-size: 0.65rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;}

        /* Toast UI */
        .toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100; pointer-events: none; }
        .toast-item { background: rgba(17, 17, 17, 0.9); backdrop-filter: blur(10px); border: 1px solid var(--bg-elevated); border-left: 4px solid var(--accent-yellow); padding: 12px 15px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 10px; transform: translateX(120%); opacity: 0; transition: all 0.5s var(--ease-spring); }
        .toast-item.show { transform: translateX(0); opacity: 1; }
        .toast-icon { width: 24px; height: 24px; color: var(--accent-yellow); }
        .toast-title { font-size: 0.7rem; text-transform: uppercase; color: var(--text-secondary); font-weight: 800; display: block; }
        .toast-name { font-size: 0.85rem; color: var(--text-primary); font-weight: 800; }

        @media (max-width: 850px) {
            .btn-back span, .nav-spacer { width: 60px; } .btn-back span { display: none; }
            .answers-grid { grid-template-columns: 1fr; grid-template-rows: repeat(4, 1fr); flex: 0 0 55vh; gap: 10px; padding: 10px; }
            .answer-btn { padding: 15px; font-size: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .guide-grid { grid-template-columns: 1fr; }
            .toast-container { bottom: auto; top: 20px; right: 50%; transform: translateX(50%); width: 90%; }
            .toast-item { transform: translateY(-120%); }
            .toast-item.show { transform: translateY(0); }
            .c-row { flex-direction: column; align-items: flex-start; gap: 2px; }
            .c-value { text-align: left; width: 100%; }
            .cheque-footer { flex-direction: column; align-items: stretch; text-align: center; }
            .canje-status-text { text-align: center; margin-bottom: 10px; }
        }
    </style>
</head>
<body ondragstart="return false;" ondrop="return false;">

<div id="app">
    <canvas id="particle-canvas"></canvas>
    <div class="toast-container" id="toast-container"></div>

    <div id="start-screen" class="screen active content-fit">
        
        <div class="top-btn-container">
            <button class="top-btn" onclick="goToRanking()" title="Ranking Global">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="18" y="3" width="4" height="18"></rect><rect x="10" y="8" width="4" height="13"></rect><rect x="2" y="13" width="4" height="8"></rect></svg>
            </button>
            <button class="top-btn" onclick="openSettings()" title="Configuración">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>

        <div class="logo-container">KLICK<span class="logo-dot">.</span></div>
        <div class="logo-subtitle">By Didac-Click Group</div>

        <div class="menu-box" id="menu-box">
            <button class="btn-solid" onclick="startGameCheck()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                ¡Jugar!
            </button>
            <button class="btn-outline" onclick="goToProfile()" style="margin-top: 10px;">Mi Perfil</button>
            <button class="btn-outline" onclick="goToAchievements()">Banco de Logros</button>
            <button class="btn-outline" onclick="goToGuide()">Instrucciones</button>
            <button class="btn-bpd" onclick="goToCanje()">Zona de Canje (BPD)</button>
        </div>
    </div>

    <div id="settings-screen" class="screen nav-screen">
        <div class="top-nav">
            <button class="btn-back" onclick="goToMainMenu()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg><span>Regresar</span></button>
            <div class="nav-title">CONFIGURACIÓN</div><div class="nav-spacer"></div>
        </div>
        <div class="content-scroll no-scrollbar">
            <div class="settings-dashboard">
                <div class="settings-grid">
                    
                    <div class="setting-card glass-panel">
                        <div class="setting-header">
                            <div class="setting-title-box">
                                <div class="setting-icon" style="color: var(--accent-green);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                                </div>
                                <div class="setting-label">Música Ambiental<div class="setting-desc">Volumen de la banda sonora</div></div>
                            </div>
                            <span id="val-music" class="setting-value" style="color: var(--accent-green); background: rgba(0, 255, 102, 0.1);">100%</span>
                        </div>
                        <input type="range" id="op-music" min="0" max="1" step="0.05" value="1">
                    </div>

                    <div class="setting-card glass-panel">
                        <div class="setting-header">
                            <div class="setting-title-box">
                                <div class="setting-icon" style="color: var(--accent-blue);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </div>
                                <div class="setting-label">Efectos (SFX)<div class="setting-desc">Volumen de respuestas y clics</div></div>
                            </div>
                            <span id="val-sfx" class="setting-value" style="color: var(--accent-blue); background: rgba(0, 212, 255, 0.1);">100%</span>
                        </div>
                        <input type="range" id="op-sfx" min="0" max="1" step="0.05" value="1">
                    </div>

                    <div class="setting-card glass-panel">
                        <div class="setting-header">
                            <div class="setting-title-box">
                                <div class="setting-icon" style="color: var(--accent-purple);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                </div>
                                <div class="setting-label">Fondo Activo<div class="setting-desc">Opacidad de las partículas reactivas</div></div>
                            </div>
                            <span id="val-particles" class="setting-value" style="color: var(--accent-purple); background: rgba(181, 23, 158, 0.1);">100%</span>
                        </div>
                        <input type="range" id="op-particles" min="0" max="1" step="0.05" value="1">
                    </div>

                    <div class="setting-card glass-panel">
                        <div class="setting-header">
                            <div class="setting-title-box">
                                <div class="setting-icon" style="color: var(--accent-yellow);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                </div>
                                <div class="setting-label">Fluidez (FPS)<div class="setting-desc">Tasa de refresco del sistema</div></div>
                            </div>
                            <span id="val-fps" class="setting-value" style="color: var(--accent-yellow); background: rgba(255, 184, 0, 0.1);">60 FPS</span>
                        </div>
                        <input type="range" id="op-fps" min="0" max="4" step="1" value="2">
                    </div>

                </div>
                
                <button class="btn-solid" onclick="goToMainMenu()" style="max-width: 300px; margin: 15px auto 0 auto; border-color: var(--rank-color); color: var(--rank-color); background: rgba(var(--rank-rgb), 0.05);">Guardar y Regresar</button>
            </div>
        </div>
    </div>

    <div id="abandon-modal" class="modal-overlay">
        <div class="settings-card glass-panel" style="text-align: center; max-width: 320px; padding: 25px 30px; border-radius: var(--radius-lg); border-top: 4px solid var(--accent-red); display: flex; flex-direction: column; gap: 15px;">
            <div style="font-size: 1.2rem; font-weight: 900; color: var(--accent-red); text-transform: uppercase;">¿Abandonar Partida?</div>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">Se aplicará una penalidad de <strong style="color: var(--accent-red);">-1,000 pts</strong> a tu acumulado.</p>
            <div style="display: flex; gap: 10px; width: 100%;">
                <button class="btn-outline" onclick="cancelAbandon()" style="flex: 1; border-color: var(--text-secondary); color: var(--text-secondary);">Cancelar</button>
                <button class="btn-solid" onclick="confirmAbandon()" style="flex: 1; background: transparent; color: var(--accent-red); border-color: var(--accent-red);">Salir</button>
            </div>
        </div>
    </div>

    <div id="ranking-screen" class="screen nav-screen">
        <div class="top-nav">
            <button class="btn-back" onclick="goToMainMenu()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg><span>Regresar</span></button>
            <div class="nav-title">TOP 20 MUNDIAL</div><div class="nav-spacer"></div>
        </div>
        <div class="content-scroll no-scrollbar">
            <div class="ranking-wrapper">
                <div id="ranking-list" class="ranking-list">
                    <div class="ranking-loading">Conectando con la base de datos global...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-screen" class="screen nav-screen">
        <div class="top-nav">
            <button class="btn-back" onclick="goToMainMenu()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg><span>Regresar</span></button>
            <div class="nav-title">DASHBOARD</div><div class="nav-spacer"></div>
        </div>
        <div class="content-fit">
            <div class="profile-dashboard">
                <div class="profile-hero glass-panel">
                    <div class="profile-rank" id="profile-rank-display">Rango: Novato</div>
                    <input type="text" id="profile-name-input" class="profile-name-input" placeholder="JUGADOR" autocomplete="off" maxlength="12">
                    <div id="profile-warning" class="profile-warning">Se requiere un nombre</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card glass-panel"><div class="stat-value" id="stat-score">0</div><div class="stat-label">Mejor Puntuación</div></div>
                    <div class="stat-card glass-panel"><div class="stat-value" id="stat-games">0</div><div class="stat-label">Partidas</div></div>
                    <div class="stat-card glass-panel"><div class="stat-value" id="stat-streak">0</div><div class="stat-label">Racha Máx</div></div>
                    <div class="stat-card glass-panel"><div class="stat-value" id="stat-days">0</div><div class="stat-label">Días</div></div>
                </div>
                <div class="profile-achievements-title">Fijados Recientemente</div>
                <div class="profile-achievements-grid" id="profile-achievements-grid"></div>
            </div>
        </div>
    </div>

    <div id="guide-screen" class="screen nav-screen">
        <div class="top-nav">
            <button class="btn-back" onclick="goToMainMenu()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg><span>Regresar</span></button>
            <div class="nav-title">MANUAL</div><div class="nav-spacer"></div>
        </div>
        <div class="content-scroll no-scrollbar">
            <div class="guide-dashboard">
                <div class="guide-grid">
                    <div class="guide-card glass-panel full-width" style="border-color: var(--accent-red);">
                        <svg class="guide-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent-red);"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                        <div class="guide-title" style="color: var(--accent-red);">Modo de Juego</div>
                        <div class="guide-text"><strong>Preguntas infinitas</strong>, solo <strong>15 segundos</strong> por pregunta y <strong>3 vidas</strong>. Si fallas o se acaba el tiempo, pierdes una vida. ¡Sobrevive tanto como puedas!</div>
                    </div>
                    <div class="guide-card glass-panel full-width">
                        <svg class="guide-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"></path></svg>
                        <div class="guide-title" style="color: var(--accent-orange);">Racha de Frenesí (Multiplicador)</div>
                        <div class="guide-text">Al llegar a <strong>5 aciertos seguidos</strong> entras en Modo Frenesí. El multiplicador global sube <strong>(x2, x3, x4...)</strong> cada 5 aciertos consecutivos. ¡Pero un fallo lo resetea todo!</div>
                    </div>
                    <div class="guide-card full-width glass-panel">
                        <div class="guide-title" style="color: var(--text-primary);">Sistema de Rangos Base</div>
                        <div class="guide-text mb-1">Debes cumplir <strong>TODOS</strong> los requisitos simultáneamente para ascender de categoría.</div>
                        <div class="rank-list">
                            <div class="rank-item"><span class="rank-item-name" style="color: var(--accent-orange);">Junior</span><span class="rank-item-pts">8k pts récord | 100 aciertos | 20 partidas jugadas.</span></div>
                            <div class="rank-item"><span class="rank-item-name" style="color: var(--accent-blue);">Pro</span><span class="rank-item-pts">12k pts récord | 500 aciertos | 100 ptds | Racha de 10.</span></div>
                            <div class="rank-item"><span class="rank-item-name" style="color: var(--accent-red);">Maestro</span><span class="rank-item-pts">16k pts récord | 2k aciertos | 200 ptds | Racha de 15.</span></div>
                        </div>
                    </div>
                    
                    <div class="guide-card full-width glass-panel" style="border-color: var(--accent-yellow);">
                        <div class="rank-list" style="margin-top: 0; width: 100%;">
                            <div class="rank-item" style="width: 100%; background: transparent; border: none; padding: 0;">
                                <span class="rank-item-name" style="color: var(--accent-yellow);">Rango: Leyenda</span>
                                <span class="rank-item-pts">20k pts récord | 5k aciertos | 500 ptds | Racha de 20 | 20 perfectas.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="guide-card full-width glass-panel" style="border-color: var(--accent-purple);">
                        <div class="guide-title" style="color: var(--accent-purple);">Nivel de Poder Global (PL)</div>
                        <div class="guide-text">
                            El <strong>Top 20 Mundial</strong> se calcula mediante tu <strong>Nivel de Poder (PL)</strong>. Este algoritmo combina tu récord personal, racha máxima, cantidad de partidas perfectas, logros desbloqueados y tu tasa de precisión general.
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="canje-screen" class="screen nav-screen">
        <div class="top-nav">
            <button class="btn-back" onclick="goToMainMenu()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg><span>Regresar</span></button>
            <div class="nav-title" style="color: var(--bpd-gold);">CANJE BPD</div><div class="nav-spacer"></div>
        </div>
        <div class="content-fit">
            <div class="canje-dashboard">
                <div class="cheque-container">
                    <div class="cheque-top">
                        <div class="cheque-top-left">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                            <span class="cheque-title">Banco del Pincel Dorado</span>
                        </div>
                        <span class="cheque-serial">No. 0000000</span>
                    </div>

                    <div class="cheque-body">
                        <div class="c-row">
                            <span class="c-label">Páguese a la orden de:</span>
                            <span class="c-value" id="c-name">JUGADOR ANÓNIMO</span>
                        </div>
                        <div class="c-row">
                            <span class="c-label">La suma de:</span>
                            <span class="c-value locked" id="c-amount">*** BLOQUEADO ***</span>
                        </div>
                        <div class="c-row">
                            <span class="c-label">Por concepto de:</span>
                            <span class="c-value">Completar 100 Logros y Rango Leyenda en Klick</span>
                        </div>
                        <div class="c-row">
                            <span class="c-label">Fecha de emisión:</span>
                            <span class="c-value" id="c-date">--/--/----</span>
                        </div>
                    </div>

                    <div class="cheque-footer">
                        <div id="canje-status" class="canje-status-text">
                            </div>
                        <button class="btn-bpd" id="canje-btn" onclick="revelarCheque()" disabled style="opacity:0.5; cursor:not-allowed; max-width: 250px;">Generar Recibo de Canje</button>
                        <div id="canje-instruction" class="c-instruction">
                            ¡Aprobado! Presenta esta pantalla intacta a un administrador del Banco del Pincel Dorado para que te otorgue los fondos.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="achievements-screen" class="screen nav-screen">
        <div class="top-nav">
            <button class="btn-back" onclick="goToMainMenu()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg><span>Regresar</span></button>
            <div class="nav-title">LOGROS</div><div class="nav-spacer"></div>
        </div>
        <div class="content-scroll no-scrollbar">
            <div class="achievements-wrapper">
                <div class="achievements-stats" id="achievements-progress-text">Desbloqueados: 0 / 100</div>
                <div class="achievements-grid" id="full-achievements-grid" style="content-visibility: auto;"></div>
            </div>
        </div>
    </div>

    <div id="countdown-screen" class="screen">
        <div style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:15px;">
            <div id="countdown-number" style="font-size:clamp(8rem,25vw,14rem);font-weight:900;color:var(--rank-color);text-shadow:0 0 40px rgba(var(--rank-rgb),0.5);transition:all 0.3s var(--ease-spring);line-height:1;"></div>
            <div id="countdown-label" style="font-size:clamp(0.8rem,2vw,1.1rem);font-weight:700;letter-spacing:4px;color:var(--text-secondary);text-transform:uppercase;"></div>
        </div>
    </div>

    <div id="question-screen" class="screen">
        <div class="top-bar">
            <div>
                <button class="btn-abandon" onclick="abandonGame()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Salir
                </button>
            </div>
            <div>
                <div id="player-name-display">JUGADOR</div>
                <div id="lives-container">
                    </div>
            </div>
            <div>
                <div id="multiplier-badge" class="multiplier-badge">x1</div>
                <div class="score-badge" id="score-display">0</div>
            </div>
        </div>
        <div class="question-container">
            <div class="timer-wrapper">
                <svg class="timer-svg" viewBox="0 0 100 100"><circle class="timer-bg" cx="50" cy="50" r="45"></circle><circle class="timer-path" id="timer-path" cx="50" cy="50" r="45"></circle></svg>
                <div class="timer-text" id="timer-display">20</div>
            </div>
            <div class="question-text" id="question-text">Cargando...</div>
        </div>
        <div class="answers-grid" id="answers-grid">
            <button class="answer-btn color-red ans-delay-1" onclick="selectAnswer(0)"><svg class="shape-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 22 20 2 20"></polygon></svg><span id="ans-0">Opción 1</span></button>
            <button class="answer-btn color-blue ans-delay-2" onclick="selectAnswer(1)"><svg class="shape-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 22 12 12 22 2 12"></polygon></svg><span id="ans-1">Opción 2</span></button>
            <button class="answer-btn color-yellow ans-delay-3" onclick="selectAnswer(2)"><svg class="shape-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle></svg><span id="ans-2">Opción 3</span></button>
            <button class="answer-btn color-green ans-delay-4" onclick="selectAnswer(3)"><svg class="shape-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="3" ry="3"></rect></svg><span id="ans-3">Opción 4</span></button>
        </div>
        <div class="progress-bar-container" id="progress-container"><div class="progress-bar" id="global-progress"></div></div>
    </div>

    <div id="feedback-screen" class="screen">
        <div class="feedback-content">
            <div id="feedback-icon-container"></div>
            <div class="feedback-title" id="feedback-title">Correcto</div>
            <div class="feedback-points" id="feedback-points">+850</div>
            <div class="streak-box">Racha <span id="streak-display">1</span></div>
        </div>
    </div>

    <div id="end-screen" class="screen nav-screen">
        <div class="content-fit">
            <div class="settings-card glass-panel" id="end-glass-panel">
                <div class="results-icon" id="results-icon-svg"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline><circle cx="12" cy="8" r="7"></circle></svg></div>
                <div class="podium-title" id="final-message">Rendimiento Excelente</div>
                <div class="final-name" id="final-name">ESTUDIANTE</div>
                
                <div class="final-score-value" id="final-score-display">0</div>
                
                <div class="results-stats-grid">
                    <div class="r-stat"><span class="r-stat-val" id="final-correct">0/20</span><span class="r-stat-label" id="final-correct-label">Aciertos</span></div>
                    <div class="r-stat"><span class="r-stat-val" id="final-streak">0</span><span class="r-stat-label">Racha Máx</span></div>
                    <div class="r-stat"><span class="r-stat-val" id="final-speed">0</span><span class="r-stat-label">Rápidas</span></div>
                </div>

                <div style="display: flex; gap: 15px; width: 100%; margin-top: 10px;">
                    <button class="btn-outline" onclick="goToMainMenu()" style="flex: 1;">Menú</button>
                    <button class="btn-solid" onclick="replayGame()" style="flex: 1; border-color: var(--rank-color); background: rgba(var(--rank-rgb), 0.1);">Jugar de Nuevo</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- SISTEMAS DE PROTECCIÓN ANTI-TRAMPAS ---
    document.addEventListener('contextmenu', e => e.preventDefault());

    document.addEventListener('keydown', e => {
        if (e.keyCode === 123 || 
            (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || 
            (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 67 || e.keyCode === 83 || e.keyCode === 80))) { 
            e.preventDefault();
            return false;
        }
    });

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'hidden' && isAnsweringAllowed && !isGamePaused) punishCheater();
    });
    window.addEventListener("blur", () => {
        if (isAnsweringAllowed && !isGamePaused) punishCheater();
    });

    function punishCheater() {
        if(!isAnsweringAllowed || isGamePaused) return;
        isAnsweringAllowed = false;
        clearInterval(timerInterval);
        
        const penalty = 2000; 
        playerStats.totalScore = Math.max(0, playerStats.totalScore - penalty);
        playerStats.bestScore = Math.max(0, playerStats.bestScore - penalty);
        playerStats.maxStreak = Math.max(0, playerStats.maxStreak - 5);
        playerStats.perfectGames = Math.max(0, playerStats.perfectGames - 1);
        
        // --- LOGRO OCULTO TRAMPOSO ---
        if (!playerStats.achievements.includes('tramposo')) {
            playerStats.achievements.push('tramposo');
        }

        saveStatsLocally();
        submitLeaderboard(); 
        
        initAudio(); SFX.incorrect();
        showToast('Trampa Detectada', `Has recibido la marca permanente de TRAMPOSO.`, 'var(--accent-red)', SVG_SKULL);
        
        document.getElementById('app').classList.remove('streak-active');
        streak = 0;
        switchScreen('start-screen');
    }

    // --- GENERACIÓN DE UUID (Para identificar jugadores unicos en el ranking) ---
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // --- SVGs ---
    const SVG_CORRECT = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
    const SVG_INCORRECT = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
    const SVG_TIMEOUT = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
    const SVG_LOCK = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;
    const SVG_TROPHY = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline><circle cx="12" cy="8" r="7"></circle></svg>`;
    const SVG_USER = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`;
    const SVG_STAR = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
    const SVG_PIN = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>`;
    const SVG_TARGET = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`;
    const SVG_FIRE = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"></path></svg>`;
    const SVG_BOLT = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`;
    const SVG_CLOCK = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
    const SVG_SKULL = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="12" r="1"></circle><circle cx="15" cy="12" r="1"></circle><path d="M8 20v2h8v-2"></path><path d="M12.5 17l-.5-1-.5 1h1z"></path><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"></path></svg>`;
    const SVG_HEART = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
    const SVG_SHIELD = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`;

    // --- Stats y Logros (Persistencia Absoluta) ---
    const defaultStats = {
        uuid: generateUUID(),
        playerName: "JUGADOR", gamesPlayed: 0, bestScore: 0, maxStreak: 0, achievements: [], pinnedAchievements: [],
        nameChanges: 0, achViews: 0, guideViews: 0, totalScore: 0, perfectGames: 0, totalCorrect: 0, totalWrong: 0, 
        totalTimeouts: 0, fastAnswersTotal: 0, frenziesTriggered: 0, lastLoginDate: "", currentLoginStreak: 0, 
        maxLoginStreak: 0, todayGames: 0, maxScoreCount: 0, perfectStreak: 0, previousGameScore: -1,
        musicVol: 1.0, sfxVol: 1.0, particleOpacity: 1.0, maxFps: 60,
        rankingViews: 0, configViews: 0, fpsChanges: 0, allSectionsVisited: false,
        sectionsVisitedThisSession: new Set(), rankingPosition: 999,
        musicSetTo0: false, sfxSetTo0: false, particles0: false,
        powerLevel: 0, totalWrong: 0, maxMult: 1,
        profileViewedAfterGames: 0, guideViewedBeforeGame: false
    };
    
    const STORAGE_KEY = 'klick_player_data_permanent';
    let savedData = localStorage.getItem(STORAGE_KEY) || localStorage.getItem('klickStats_v9') || localStorage.getItem('klickStats_v8') || '{}';
    let playerStats = { ...defaultStats, ...JSON.parse(savedData) };
    
    if(!playerStats.uuid) playerStats.uuid = generateUUID();

    function saveStatsLocally() { 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(playerStats)); 
    }

    window.addEventListener('beforeunload', () => {
        saveStatsLocally();
    });

    // --- Audio y Reactividad Musical ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx, isMusicPlaying = false, musicSeqStep = 0, nextNoteTime = 0, musicTimerID;
    let chordIndex = 0;
    
    let masterMusicGain, masterSFXGain, audioAnalyser;
    let audioDataArray;

    function initAudio() {
        if (!audioCtx) { 
            audioCtx = new AudioContext(); 
            
            // Nodos Maestros
            masterMusicGain = audioCtx.createGain();
            masterSFXGain = audioCtx.createGain();
            
            // Analizador para reactividad de partículas
            audioAnalyser = audioCtx.createAnalyser();
            audioAnalyser.fftSize = 64; // Pequeño para capturar bajos rápido
            audioDataArray = new Uint8Array(audioAnalyser.frequencyBinCount);
            
            // Ruteo
            masterMusicGain.connect(audioAnalyser);
            masterSFXGain.connect(audioCtx.destination); // SFX sin pasar por el analizador (para no alterar partículas con clics)
            audioAnalyser.connect(audioCtx.destination);
            
            updateVolumes();
            startMusicEngine(); 
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    
    function updateVolumes() {
        if (masterMusicGain) {
            masterMusicGain.gain.setValueAtTime(playerStats.musicVol, audioCtx.currentTime);
        }
        if (masterSFXGain) {
            masterSFXGain.gain.setValueAtTime(playerStats.sfxVol, audioCtx.currentTime);
        }
    }

    // Funciones de utilidad para audio
    let currentAudioPulse = 0;
    function getAudioPulse() {
        if (!audioAnalyser) return 0;
        audioAnalyser.getByteFrequencyData(audioDataArray);
        let sum = 0;
        for(let i = 0; i < 4; i++) sum += audioDataArray[i]; // Captura los graves
        currentAudioPulse = sum / (4 * 255); // Valor normalizado 0 a 1
        return currentAudioPulse;
    }

    function playTone(freq, type, duration, vol = 0.05) {
        if (!audioCtx) return; 
        const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(masterSFXGain); 
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }
    
    function playNoiseAt(time, duration, vol, cutoff = 5000) {
        if (!audioCtx) return; 
        const bufferSize = audioCtx.sampleRate * duration, buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate), data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = audioCtx.createBufferSource(); noise.buffer = buffer; const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(vol, time); gain.gain.exponentialRampToValueAtTime(0.001, time + duration);
        const filter = audioCtx.createBiquadFilter(); filter.type = 'highpass'; filter.frequency.value = cutoff;
        noise.connect(filter); filter.connect(gain); gain.connect(masterMusicGain); noise.start(time);
    }
    
    function startMusicEngine() { isMusicPlaying = true; nextNoteTime = audioCtx.currentTime + 0.1; scheduler(); }
    function scheduler() { if (!isMusicPlaying) return; while (nextNoteTime < audioCtx.currentTime + 0.1) { playMusicStep(nextNoteTime); nextNoteStep(); } musicTimerID = setTimeout(scheduler, 25); }
    
    function nextNoteStep() { 
        const isFrenzy = streak >= 5; 
        // 115 BPM base, 130 BPM Frenzy (Ritmo inspirador)
        nextNoteTime += 0.25 * (60.0 / (isFrenzy ? 130 : 115)); 
        musicSeqStep++; 
        if (musicSeqStep >= 16) { 
            musicSeqStep = 0; 
            chordIndex = (chordIndex + 1) % 4; 
        } 
    }
    
    function playMusicStep(time) {
        const isFrenzy = streak >= 5;
        
        // Progresión de acordes inspiradora (Am - F - C - G) en MIDI
        const chordProgression = [
            [57, 60, 64, 69], // Am: A3 C4 E4 A4
            [53, 57, 60, 65], // F:  F3 A3 C4 F4
            [48, 52, 55, 60], // C:  C3 E3 G3 C4
            [55, 59, 62, 67]  // G:  G3 B3 D4 G4
        ];
        const currentChord = chordProgression[chordIndex];
        const midiToFreq = (m) => 440 * Math.pow(2, (m - 69) / 12);

        // 1. Bombo (Kick)
        if (musicSeqStep % 4 === 0) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(120, time);
            osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.3);
            gain.gain.setValueAtTime(0.8, time); 
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.3);
            osc.connect(gain); gain.connect(masterMusicGain);
            osc.start(time); osc.stop(time + 0.3);
        }
        
        // 2. Línea de Bajo (Warm Pad/Bass)
        if (musicSeqStep % 2 === 0) {
             const osc = audioCtx.createOscillator();
             const gain = audioCtx.createGain();
             const filter = audioCtx.createBiquadFilter();
             
             osc.type = 'sawtooth';
             osc.frequency.setValueAtTime(midiToFreq(currentChord[0] - 12), time);
             
             filter.type = 'lowpass';
             filter.frequency.setValueAtTime(isFrenzy ? 800 : 350, time);
             filter.frequency.exponentialRampToValueAtTime(100, time + 0.2);

             gain.gain.setValueAtTime(isFrenzy ? 0.5 : 0.35, time);
             gain.gain.exponentialRampToValueAtTime(0.01, time + 0.2);

             osc.connect(filter); filter.connect(gain); gain.connect(masterMusicGain);
             osc.start(time); osc.stop(time + 0.2);
        }

        // 3. Arpegiador Principal
        const arpPattern = [0, 2, 1, 3, 0, 3, 2, 1, 0, 2, 3, 1, 2, 0, 1, 3]; 
        const noteMidi = currentChord[arpPattern[musicSeqStep % arpPattern.length]] + (isFrenzy ? 12 : 0);
        
        const oscArp = audioCtx.createOscillator();
        const gainArp = audioCtx.createGain();
        const filterArp = audioCtx.createBiquadFilter();

        oscArp.type = 'triangle'; 
        oscArp.frequency.setValueAtTime(midiToFreq(noteMidi), time);

        filterArp.type = 'lowpass';
        filterArp.frequency.setValueAtTime(isFrenzy ? 2500 : 1000, time);

        gainArp.gain.setValueAtTime(0.0, time);
        gainArp.gain.linearRampToValueAtTime(isFrenzy ? 0.4 : 0.3, time + 0.02); 
        gainArp.gain.exponentialRampToValueAtTime(0.001, time + (isFrenzy ? 0.15 : 0.25));

        oscArp.connect(filterArp); filterArp.connect(gainArp); gainArp.connect(masterMusicGain);
        oscArp.start(time); oscArp.stop(time + 0.3);
        
        // 4. Percusión de ambiente en Frenesí
        if (isFrenzy) {
            if (musicSeqStep % 2 !== 0) {
                playNoiseAt(time, 0.05, 0.2, 7000); 
            }
            if (musicSeqStep === 4 || musicSeqStep === 12) {
                playNoiseAt(time, 0.15, 0.3, 2000); 
            }
        }
    }
    
    const SFX = {
        click: () => playTone(600, 'sine', 0.1, 0.1), tick: () => playTone(800, 'square', 0.05, 0.02), select: () => { playTone(400, 'sine', 0.1, 0.05); setTimeout(()=>playTone(600, 'sine', 0.15, 0.05), 50); },
        correct: () => { playTone(523.25, 'triangle', 0.2, 0.1); setTimeout(() => playTone(783.99, 'triangle', 0.4, 0.1), 100); }, incorrect: () => playTone(150, 'sawtooth', 0.4, 0.1),
        streakTrigger: () => { playTone(440, 'sine', 0.1, 0.1); setTimeout(() => playTone(659.25, 'sine', 0.1, 0.1), 100); setTimeout(() => playTone(880, 'sine', 0.4, 0.15), 200); },
        achievement: () => { playTone(880, 'sine', 0.1, 0.1); setTimeout(() => playTone(1108.73, 'sine', 0.1, 0.1), 100); setTimeout(() => playTone(1318.51, 'sine', 0.3, 0.1), 200); },
        perfectGame: () => { playTone(440, 'sine', 0.2, 0.15); setTimeout(() => playTone(554.37, 'sine', 0.2, 0.15), 150); setTimeout(() => playTone(659.25, 'sine', 0.2, 0.15), 300); setTimeout(() => playTone(880, 'sine', 0.6, 0.2), 450); },
        allWrongGame: () => { playTone(300, 'sawtooth', 0.3, 0.15); setTimeout(() => playTone(250, 'sawtooth', 0.3, 0.15), 300); setTimeout(() => playTone(200, 'sawtooth', 0.6, 0.2), 600); },
        allTimeoutGame: () => { playTone(100, 'square', 0.1, 0.1); setTimeout(() => playTone(100, 'square', 0.1, 0.1), 300); setTimeout(() => playTone(100, 'square', 0.3, 0.15), 600); },
        gameStart: () => { playTone(300, 'sine', 0.1, 0.1); setTimeout(() => playTone(400, 'sine', 0.1, 0.1), 100); setTimeout(() => playTone(600, 'sine', 0.3, 0.15), 200); },
        gameEnd: () => { playTone(500, 'triangle', 0.15, 0.1); setTimeout(() => playTone(700, 'triangle', 0.15, 0.1), 150); setTimeout(() => playTone(900, 'triangle', 0.4, 0.15), 300); }
    };

    // --- UI Modal y Configuracion ---
    function openSettings() {
        initAudio(); SFX.click();
        playerStats.configViews = (playerStats.configViews||0) + 1;
        saveStatsLocally(); checkAchievements();
        document.getElementById('op-music').value = playerStats.musicVol; document.getElementById('op-sfx').value = playerStats.sfxVol; 
        document.getElementById('op-particles').value = playerStats.particleOpacity; 
        document.getElementById('op-fps').value = FPS_VALUES.indexOf(playerStats.maxFps) >= 0 ? FPS_VALUES.indexOf(playerStats.maxFps) : 2;
        document.getElementById('val-music').innerText = Math.round(playerStats.musicVol*100)+'%'; document.getElementById('val-sfx').innerText = Math.round(playerStats.sfxVol*100)+'%'; 
        document.getElementById('val-particles').innerText = Math.round(playerStats.particleOpacity*100)+'%'; document.getElementById('val-fps').innerText = playerStats.maxFps+' FPS';
        switchScreen('settings-screen');
    }

    document.getElementById('op-music').addEventListener('input', (e) => { 
        playerStats.musicVol = parseFloat(e.target.value); 
        document.getElementById('val-music').innerText = Math.round(playerStats.musicVol*100)+'%'; 
        updateVolumes(); 
        if(playerStats.musicVol===0) { playerStats.musicSetTo0=true; checkAchievements(); }
        if(playerStats.musicVol>=1.0 && (playerStats.particleOpacity||1)>=1.0) { unlock_cfg8(); }
        saveStatsLocally(); 
    });
    document.getElementById('op-sfx').addEventListener('input', (e) => { 
        playerStats.sfxVol = parseFloat(e.target.value); 
        document.getElementById('val-sfx').innerText = Math.round(playerStats.sfxVol*100)+'%'; 
        updateVolumes(); 
        if(playerStats.sfxVol===0) { playerStats.sfxSetTo0=true; checkAchievements(); }
        saveStatsLocally(); 
    });
    document.getElementById('op-particles').addEventListener('input', (e) => { 
        playerStats.particleOpacity = parseFloat(e.target.value); 
        document.getElementById('val-particles').innerText = Math.round(playerStats.particleOpacity*100)+'%'; 
        if(playerStats.particleOpacity===0) { playerStats.particles0=true; checkAchievements(); }
        if(playerStats.musicVol>=1.0 && playerStats.particleOpacity>=1.0) { unlock_cfg8(); }
        saveStatsLocally(); 
    });
    function unlock_cfg8() { if(!playerStats.achievements.includes('cfg8')) { playerStats.achievements.push('cfg8'); SFX.achievement(); showToast('Logro Desbloqueado','Purpurina',colors.purple,SVG_STAR); saveStatsLocally(); renderAchievements(); } }
    const FPS_VALUES = [15, 30, 60, 120, 240];
    document.getElementById('op-fps').addEventListener('input', (e) => { 
        playerStats.maxFps = FPS_VALUES[parseInt(e.target.value)]; 
        fpsInterval = 1000/playerStats.maxFps; 
        document.getElementById('val-fps').innerText = playerStats.maxFps+' FPS'; 
        playerStats.fpsChanges = (playerStats.fpsChanges||0)+1;
        checkAchievements();
        saveStatsLocally(); 
    });

    // --- UI General Toasts ---
    function showToast(title, message, color, icon) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div'); 
        toast.className = 'toast-item'; 
        toast.style.borderLeftColor = color;
        toast.innerHTML = `<div class="toast-icon" style="color: ${color}">${icon}</div><div class="toast-text"><span class="toast-title">${title}</span><span class="toast-name">${message}</span></div>`;
        container.appendChild(toast); 
        setTimeout(() => toast.classList.add('show'), 50); 
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 3500);
    }

    // --- Módulo: Ranking Global (Google Apps Script) ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxbLrjL45NYaQsRaSlZJXHKlQj-1Qh4f-CPxz4KsOMpfMI4jwwYC1UrNpnm_-f6ISeCww/exec"; 
    
    function calculatePowerLevel(stats) {
        const base = stats.totalScore * 0.05; 
        const best = stats.bestScore * 1.5; 
        const streak = stats.maxStreak * 200;
        const perf = stats.perfectGames * 1000;
        const achs = stats.achievements.length * 300;
        const winRate = stats.gamesPlayed > 0 ? (stats.totalCorrect / (stats.gamesPlayed * 20)) * 5000 : 0;
        return Math.floor(base + best + streak + perf + achs + winRate);
    }

    async function submitLeaderboard() {
        if (!playerStats.playerName || playerStats.playerName === "JUGADOR" || GAS_URL === "URL_DE_TU_GOOGLE_APPS_SCRIPT_AQUI") return;
        
        playerStats.powerLevel = calculatePowerLevel(playerStats);
        
        const payload = {
            uuid: playerStats.uuid,
            name: playerStats.playerName,
            rankTitle: getRankInfo(playerStats).title,
            powerLevel: calculatePowerLevel(playerStats),
            totalScore: playerStats.totalScore,
            maxStreak: playerStats.maxStreak
        };

        try {
            await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            });
        } catch(e) {
            console.log("Error al sincronizar ranking:", e);
        }
    }

    async function fetchLeaderboard() {
        if(GAS_URL === "URL_DE_TU_GOOGLE_APPS_SCRIPT_AQUI") {
            document.getElementById('ranking-list').innerHTML = `<div class="ranking-loading">Debes configurar la URL de Google Apps Script en el código HTML.</div>`;
            return;
        }

        try {
            const res = await fetch(GAS_URL);
            const topPlayers = await res.json();
            
            let html = "";
            topPlayers.forEach((p, index) => {
                const pos = index + 1;
                const isMe = p.uuid === playerStats.uuid;
                if(isMe) { 
                    playerStats.rankingPosition = pos; 
                    saveStatsLocally(); checkAchievements(); 
                }
                let classPos = pos <= 3 ? `pos-${pos}` : ``;
                if(isMe) classPos += " is-me";
                
                html += `
                <div class="rank-card ${classPos}">
                    <div class="rc-pos">${pos}</div>
                    <div class="rc-info">
                        <div class="rc-name">${p.name} ${isMe ? '(Tú)' : ''}</div>
                        <div class="rc-title">${p.rankTitle}</div>
                    </div>
                    <div class="rc-score">${p.powerLevel.toLocaleString()} <span>PL</span></div>
                </div>`;
            });
            
            document.getElementById('ranking-list').innerHTML = html;
        } catch(e) {
            if(document.getElementById('ranking-list').innerHTML.includes('ranking-loading')) {
               document.getElementById('ranking-list').innerHTML = `<div class="ranking-loading">Error al conectar con la base de datos global. Reintentando...</div>`;
            }
            console.log("Error fetching leaderboard", e);
        }
    }

    setInterval(() => {
        submitLeaderboard();
        fetchLeaderboard();
    }, 60000);

    // --- SISTEMA DE PREGUNTAS MASIVAS (JSON EXTERNO) ---
    let quizDataPool = [];
    
    async function loadQuestions() {
        try {
            const response = await fetch('preguntas.json');
            if (!response.ok) throw new Error('No se pudo cargar el archivo');
            quizDataPool = await response.json();
        } catch (error) {
            quizDataPool = [
                { "question": "⚠️ ERROR: No se pudo cargar 'preguntas.json'. ¿Estás abriendo el HTML directamente (file://) en vez de usar un servidor local?", "answers": ["Sí, ese es el error", "Debo usar Live Server", "Falta el archivo JSON", "Todas las anteriores"], "correctIndex": 3 }
            ];
            while(quizDataPool.length < 20) {
                quizDataPool.push({ "question": "Por favor, carga el juego en un servidor web o súbelo a GitHub Pages para que el JSON funcione.", "answers": ["Entendido", "Ok", "Comprendo", "Solucionar"], "correctIndex": 0 });
            }
        }
    }

    // --- Data 250 Logros ---
    const ACHIEVEMENTS_DATA = [];
    const colors = { blue: 'var(--accent-blue)', green: 'var(--accent-green)', yellow: 'var(--accent-yellow)', orange: 'var(--accent-orange)', red: 'var(--accent-red)', purple: 'var(--accent-purple)', dark: 'var(--text-secondary)' };
    
    const CHEATER_ACHIEVEMENT = { id: 'tramposo', title: 'TRAMPOSO', desc: 'Infringió las normas. Marca imborrable.', color: 'var(--accent-red)', icon: SVG_SKULL };

    function addAchs(arr) { arr.forEach(a => ACHIEVEMENTS_DATA.push(a)); }

    // --- META (10) ---
    addAchs([
        { id: 'm1',  title: 'Bautizado',      desc: 'Configura tu nombre de jugador por primera vez.',           color: colors.blue,   icon: SVG_USER },
        { id: 'm2',  title: 'Agente Secreto', desc: 'Cambia tu nombre de jugador 5 veces.',                     color: colors.purple, icon: SVG_USER },
        { id: 'm3',  title: 'Identidad Falsa',desc: 'Cambia tu nombre de jugador 20 veces.',                    color: colors.red,    icon: SVG_USER },
        { id: 'm4',  title: 'Curioso',         desc: 'Abre el Banco de Logros por primera vez.',                 color: colors.orange, icon: SVG_TROPHY },
        { id: 'm5',  title: 'Investigador',    desc: 'Visita el Banco de Logros 10 veces.',                      color: colors.blue,   icon: SVG_TROPHY },
        { id: 'm6',  title: 'Obsesivo',        desc: 'Visita el Banco de Logros 50 veces.',                      color: colors.purple, icon: SVG_TROPHY },
        { id: 'm7',  title: 'Diseñador',       desc: 'Fija tu primer logro en el perfil.',                       color: colors.yellow, icon: SVG_STAR },
        { id: 'm8',  title: 'Coleccionista',   desc: 'Desbloquea 10 logros en total.',                           color: colors.green,  icon: SVG_STAR },
        { id: 'm9',  title: 'Completista',     desc: 'Alcanza el hito de 50 logros desbloqueados.',              color: colors.orange, icon: SVG_STAR },
        { id: 'm10', title: 'Centenario',      desc: 'Consigue los primeros 100 logros.',                        color: colors.red,    icon: SVG_STAR },
    ]);

    // --- COLECCIÓN MAESTRA (4) ---
    addAchs([
        { id: 'master1', title: 'Casi Dios',    desc: 'Desbloquea 150 logros en total.',                         color: colors.yellow, icon: SVG_STAR },
        { id: 'master2', title: 'Semidivino',   desc: 'Desbloquea 200 logros en total.',                         color: colors.orange, icon: SVG_STAR },
        { id: 'master3', title: 'Dios Klick',   desc: 'Consigue los 250 logros del juego. Eres absoluto.',       color: colors.red,    icon: SVG_STAR },
        { id: 'master4', title: 'Leyenda Total',desc: 'Desbloquea 225 logros.',                                  color: colors.purple, icon: SVG_STAR },
    ]);

    // --- DÍAS CONSECUTIVOS (10) ---
    const daysTiers  = [1, 2, 3, 5, 7, 15, 21, 30, 60, 90];
    const daysTitles = ['Hola Mundo','Doble','Triple','Cinco','Semana Activa','Quincena','Tres Semanas','Un Mes','Bimestre','Trimestre Fuego'];
    for(let i=0;i<10;i++) addAchs([{ id:`d${i+1}`, title:daysTitles[i], desc:`Inicia sesión durante ${daysTiers[i]} días consecutivos.`, color:colors.green, icon:SVG_CLOCK }]);

    // --- PARTIDAS JUGADAS (8) ---
    const ptTiers=[1,10,25,50,100,200,350,500];
    for(let i=0;i<8;i++) addAchs([{ id:`p${i+1}`, title:`Jugador ${i+1}`, desc:`Acumula ${ptTiers[i]} partidas jugadas.`, color:colors.blue, icon:SVG_TARGET }]);

    // --- PUNTOS TOTALES (8) ---
    const ptsTiers=[5000,25000,75000,150000,300000,600000,1000000,2000000];
    for(let i=0;i<8;i++) addAchs([{ id:`pt${i+1}`, title:`Ahorrador ${i+1}`, desc:`Acumula ${ptsTiers[i].toLocaleString()} puntos totales en tu carrera.`, color:colors.green, icon:SVG_STAR }]);

    // --- RÉCORDS PERFECTOS (8) ---
    const hsCountTiers=[1,3,5,10,20,35,50,75];
    for(let i=0;i<8;i++) addAchs([{ id:`hs${i+1}`, title:`Récord ${i+1}`, desc:`Supera 20,000 puntos en ${hsCountTiers[i]} partidas distintas.`, color:colors.purple, icon:SVG_FIRE }]);

    // --- FRENESÍ (8) ---
    const frTiers=[1,5,15,30,60,100,200,350];
    for(let i=0;i<8;i++) addAchs([{ id:`r${i+1}`, title:`Frenético ${i+1}`, desc:`Activa el Modo Frenesí en ${frTiers[i]} ocasiones.`, color:colors.orange, icon:SVG_FIRE }]);

    // --- PARTIDAS PERFECTAS (8) ---
    const pfTiers=[1,3,5,10,20,35,50,75];
    for(let i=0;i<8;i++) addAchs([{ id:`pf${i+1}`, title:`Resistencia ${i+1}`, desc:`Llega a la pregunta ${pfTiers[i]*10} sin perder todas las vidas.`, color:colors.yellow, icon:SVG_TARGET }]);

    // --- VELOCIDAD (8) ---
    const spdTiers=[5,15,30,60,100,200,350,500];
    for(let i=0;i<8;i++) addAchs([{ id:`sp${i+1}`, title:`Reflejos ${i+1}`, desc:`Responde correctamente en los primeros 2s en ${spdTiers[i]} ocasiones.`, color:colors.blue, icon:SVG_BOLT }]);

    // --- ACIERTOS TOTALES (8) ---
    const acTiers=[10,50,100,250,500,1000,2000,5000];
    for(let i=0;i<8;i++) addAchs([{ id:`ac${i+1}`, title:`Cerebro ${i+1}`, desc:`Acumula ${acTiers[i]} respuestas correctas en total.`, color:colors.green, icon:SVG_CORRECT }]);

    // --- RACHA MÁX ACUMULADA (8 escalables) ---
    const strkTiers=[5,10,15,20,30,40,50,75];
    for(let i=0;i<8;i++) addAchs([{ id:`sk${i+1}`, title:`Encadenado ${i+1}`, desc:`Alcanza una racha de ${strkTiers[i]} aciertos seguidos en alguna partida.`, color:colors.orange, icon:SVG_BOLT }]);

    // --- MULTIPLICADOR MÁX (5 escalables) ---
    const multTiers=[2,3,4,5,6];
    for(let i=0;i<5;i++) addAchs([{ id:`mx${i+1}`, title:`Multiplicador x${multTiers[i]}`, desc:`Alcanza el multiplicador x${multTiers[i]} en una partida.`, color:colors.red, icon:SVG_FIRE }]);

    // --- VISITAS A RANKING (5 escalables) ---
    const rankVisTiers=[1,5,10,25,50];
    for(let i=0;i<5;i++) addAchs([{ id:`rv${i+1}`, title:`Espía de Ranking ${i+1}`, desc:`Visita el Top 20 Mundial ${rankVisTiers[i]} veces.`, color:colors.blue, icon:SVG_TROPHY }]);

    // --- VISITAS A CONFIGURACIÓN (5 escalables) ---
    const cfgVisTiers=[1,3,10,25,50];
    for(let i=0;i<5;i++) addAchs([{ id:`cv${i+1}`, title:`Ajustador ${i+1}`, desc:`Abre el menú de Configuración ${cfgVisTiers[i]} veces.`, color:colors.purple, icon:SVG_USER }]);

    // --- VISITAS AL MANUAL (5 escalables) ---
    const guideVisTiers=[1,3,10,25,50];
    for(let i=0;i<5;i++) addAchs([{ id:`gv${i+1}`, title:`Estudiante ${i+1}`, desc:`Visita las Instrucciones del juego ${guideVisTiers[i]} veces.`, color:colors.green, icon:SVG_TARGET }]);

    // --- TIEMPO SIN FALLOS (5 escalables) ---
    const noTimoutTiers=[5,10,20,40,80];
    for(let i=0;i<5;i++) addAchs([{ id:`nt${i+1}`, title:`Puntual ${i+1}`, desc:`Responde ${noTimoutTiers[i]} preguntas seguidas sin que se acabe el tiempo.`, color:colors.yellow, icon:SVG_CLOCK }]);

    // --- LOGROS ÚNICOS (24) ---
    addAchs([
        { id: 'u1',  title: 'Error Inicial',   desc: 'Equivócate al responder por primera vez.',                         color: colors.dark,   icon: SVG_INCORRECT },
        { id: 'u2',  title: 'Tropiezo',        desc: 'Acumula 100 respuestas incorrectas en tu carrera.',                color: colors.dark,   icon: SVG_INCORRECT },
        { id: 'u3',  title: 'Dormilón',        desc: 'Deja que el reloj llegue a cero en una pregunta.',                 color: colors.dark,   icon: SVG_CLOCK },
        { id: 'u4',  title: 'AFK',             desc: 'Deja que el reloj llegue a cero 50 veces en total.',               color: colors.dark,   icon: SVG_CLOCK },
        { id: 'u5',  title: 'Por los Pelos',   desc: 'Acierta una pregunta cuando el reloj marque exactamente 1 segundo.',color: colors.red,   icon: SVG_CLOCK },
        { id: 'u6',  title: 'Pro',             desc: 'Alcanza el rango Pro.',                                            color: colors.blue,   icon: SVG_TROPHY },
        { id: 'u7',  title: 'Maestro',         desc: 'Alcanza el rango Maestro.',                                        color: colors.red,    icon: SVG_TROPHY },
        { id: 'u8',  title: 'Leyenda',         desc: 'Alcanza el codiciado rango Leyenda.',                              color: colors.yellow, icon: SVG_TROPHY },
        { id: 'u9',  title: 'Inmortal',        desc: 'Completa 50 preguntas seguidas sin perder ninguna vida.',          color: colors.purple, icon: SVG_SHIELD },
        { id: 'u10', title: 'Desastre',        desc: 'Pierde las 3 vidas en las primeras 3 preguntas.',                  color: colors.dark,   icon: SVG_SKULL },
        { id: 'u11', title: 'Fénix',           desc: 'Pierde 2 vidas al inicio pero llega a 30 aciertos consecutivos.',  color: colors.orange, icon: SVG_FIRE },
        { id: 'u12', title: 'Tragedia',        desc: 'Pierde la última vida durante una racha de 20 o más.',             color: colors.dark,   icon: SVG_INCORRECT },
        { id: 'u13', title: 'Flash',           desc: 'Responde correctamente en menos de 1 segundo.',                    color: colors.yellow, icon: SVG_BOLT },
        { id: 'u14', title: 'Calculador',      desc: 'Acierta dejando que el reloj baje a 2-3 segundos.',                color: colors.blue,   icon: SVG_CLOCK },
        { id: 'u15', title: 'Superviviente',   desc: 'Llega a 100 preguntas en una sola partida.',                       color: colors.green,  icon: SVG_SHIELD },
        { id: 'u16', title: 'Frenesí Máximo',  desc: 'Alcanza el multiplicador x4 o superior.',                          color: colors.orange, icon: SVG_FIRE },
        { id: 'u17', title: 'Reloj de Arena',  desc: 'Acumula 50 respuestas de último segundo (1-2 seg).',               color: colors.blue,   icon: SVG_CLOCK },
        { id: 'u18', title: 'Suicida',         desc: 'Pierde las 3 vidas en menos de 30 segundos de partida.',           color: colors.dark,   icon: SVG_SKULL },
        { id: 'u19', title: 'Resurrección',    desc: 'Pierde 2 vidas seguidas y encadena 10 aciertos consecutivos.',     color: colors.yellow, icon: SVG_HEART },
        { id: 'u20', title: 'Centinela',       desc: 'Llega a la pregunta 50 sin usar ningún fallo por tiempo.',         color: colors.dark,   icon: SVG_CLOCK },
        { id: 'u21', title: 'Metralleta',      desc: 'Responde 10 preguntas seguidas en menos de 3 segundos cada una.',  color: colors.red,    icon: SVG_BOLT },
        { id: 'u22', title: 'Maratón',         desc: 'Juega 50 partidas en un solo día.',                                color: colors.purple, icon: SVG_HEART },
        { id: 'u23', title: 'Imparable',       desc: 'Encadena una racha de 25 aciertos o más en una partida.',          color: colors.yellow, icon: SVG_TARGET },
        { id: 'u24', title: 'Extremis',        desc: 'Consigue 3 aciertos de último segundo (1 seg) en una partida.',   color: colors.red,    icon: SVG_SHIELD },
    ]);

    // --- MODO DE JUEGO (nuevo modo oculto – interacciones con el ranking) (10) ---
    addAchs([
        { id: 'nm1', title: 'Primera Sangre',     desc: 'Aparece por primera vez en el Top 20 Mundial.',                  color: colors.red,    icon: SVG_TROPHY },
        { id: 'nm2', title: 'Top 10',             desc: 'Entra en el Top 10 del ranking global.',                        color: colors.orange, icon: SVG_TROPHY },
        { id: 'nm3', title: 'Podio',              desc: 'Entra en el Top 3 del ranking global.',                         color: colors.yellow, icon: SVG_TROPHY },
        { id: 'nm4', title: 'El Primero',         desc: 'Llega al primer lugar del ranking global.',                     color: colors.yellow, icon: SVG_STAR },
        { id: 'nm5', title: 'Vigilia',            desc: 'Sube al ranking en 3 días consecutivos.',                       color: colors.blue,   icon: SVG_CLOCK },
        { id: 'nm6', title: 'Impostado',          desc: 'Supera a otro jugador que tenía más de 1,000 PL que tú.',       color: colors.purple, icon: SVG_BOLT },
        { id: 'nm7', title: 'Remontada',          desc: 'Estabas en puesto 15+ y ascendiste al Top 5 en una partida.',   color: colors.orange, icon: SVG_FIRE },
        { id: 'nm8', title: 'PL 1000',            desc: 'Alcanza 1,000 Puntos de Poder.',                               color: colors.green,  icon: SVG_STAR },
        { id: 'nm9', title: 'PL 5000',            desc: 'Alcanza 5,000 Puntos de Poder.',                               color: colors.blue,   icon: SVG_STAR },
        { id: 'nm10',title: 'PL 15000',           desc: 'Alcanza 15,000 Puntos de Poder. Eres élite.',                  color: colors.yellow, icon: SVG_STAR },
    ]);

    // --- OCULTOS: INTERACCIÓN CON CONFIGURACIÓN (8) ---
    addAchs([
        { id: 'cfg1', title: 'Silencio Total',     desc: 'Pon la música en 0% desde Configuración.',                     color: colors.dark,   icon: SVG_CLOCK },
        { id: 'cfg2', title: 'Oídos Abiertos',    desc: 'Sube la música al 100% desde Configuración.',                  color: colors.green,  icon: SVG_STAR },
        { id: 'cfg3', title: 'Sordomudo',          desc: 'Pon tanto la música como el SFX en 0%.',                      color: colors.dark,   icon: SVG_SKULL },
        { id: 'cfg4', title: 'Ajuste Fino',        desc: 'Cambia el valor de FPS al menos 5 veces.',                   color: colors.purple, icon: SVG_BOLT },
        { id: 'cfg5', title: 'Velocista',          desc: 'Activa 240 FPS en Configuración.',                            color: colors.red,    icon: SVG_FIRE },
        { id: 'cfg6', title: 'Ahorro de Batería',  desc: 'Activa 15 FPS en Configuración.',                            color: colors.dark,   icon: SVG_CLOCK },
        { id: 'cfg7', title: 'Fantasma',           desc: 'Pon las partículas en 0%.',                                  color: colors.dark,   icon: SVG_SKULL },
        { id: 'cfg8', title: 'Purpurina',          desc: 'Pon las partículas en 100% y la música en 100% al mismo tiempo.',color: colors.purple, icon: SVG_STAR },
    ]);

    // --- OCULTOS: INTERACCIÓN CON RANKING E INTERFAZ (10) ---
    addAchs([
        { id: 'ui1',  title: 'Explorador',         desc: 'Visita todas las secciones del menú en una misma sesión.',     color: colors.blue,   icon: SVG_TARGET },
        { id: 'ui2',  title: 'Vuelvo en Un Segundo',desc: 'Entra y sal del menú de Configuración en menos de 3 segundos.',color: colors.yellow, icon: SVG_BOLT },
        { id: 'ui3',  title: 'La Guía No Miente',  desc: 'Lee el Manual y luego completa 5 aciertos en una partida.',   color: colors.green,  icon: SVG_SHIELD },
        { id: 'ui4',  title: 'Canje en Mente',     desc: 'Visita la Zona de Canje sin cumplir aún los requisitos.',     color: colors.orange, icon: SVG_TROPHY },
        { id: 'ui5',  title: 'El Perfil Importa',  desc: 'Visita tu perfil después de cada una de tus primeras 5 partidas.',color: colors.blue, icon: SVG_USER },
        { id: 'ui6',  title: 'Fan del Ranking',    desc: 'Visita el Top 20 mientras hay menos de 5 jugadores en él.',   color: colors.dark,   icon: SVG_TROPHY },
        { id: 'ui7',  title: 'Nuevo en el Barrio', desc: 'Juega tu primera partida con nombre registrado.',             color: colors.green,  icon: SVG_USER },
        { id: 'ui8',  title: 'Bien Conectado',     desc: 'El ranking global carga sin errores 10 veces.',               color: colors.blue,   icon: SVG_TARGET },
        { id: 'ui9',  title: 'Puntaje en Mente',   desc: 'Revisa tu perfil inmediatamente después de un puntaje récord.',color: colors.yellow, icon: SVG_STAR },
        { id: 'ui10', title: 'El Circuito',        desc: 'Navega por las 6 secciones (Perfil, Logros, Manual, Ranking, Canje, Config.) en orden.', color: colors.purple, icon: SVG_FIRE },
    ]);

    // --- ESCALABLES: FALLOS TOTALES (5) ---
    const wrnTiers=[100,250,500,1000,2000];
    for(let i=0;i<5;i++) addAchs([{ id:`wr${i+1}`, title:`Torpeza ${i+1}`, desc:`Acumula ${wrnTiers[i]} respuestas incorrectas en tu carrera.`, color:colors.dark, icon:SVG_INCORRECT }]);

    // --- ESCALABLES: TIMEOUTS TOTALES (5) ---
    const toTiers=[50,150,350,750,1500];
    for(let i=0;i<5;i++) addAchs([{ id:`to${i+1}`, title:`Ausente ${i+1}`, desc:`Deja el reloj llegar a cero ${toTiers[i]} veces.`, color:colors.dark, icon:SVG_CLOCK }]);

    // --- ESCALABLES: PARTIDAS HOY (5) ---
    const todayTiers=[5,10,20,35,50];
    for(let i=0;i<5;i++) addAchs([{ id:`td${i+1}`, title:`Intenso ${i+1}`, desc:`Juega ${todayTiers[i]} partidas en un solo día.`, color:colors.orange, icon:SVG_FIRE }]);

    // --- ESCALABLES: PUNTAJE RECORD (8) ---
    const bestScoreTiers=[1000,3000,6000,10000,14000,17000,19000,20000];
    const bestScoreTitles=['Primera Marca','Principiante','Prometedor','Serio','Elite','Extraordinario','Casi Perfecto','Puntaje Máximo'];
    for(let i=0;i<8;i++) addAchs([{ id:`bs${i+1}`, title:bestScoreTitles[i], desc:`Alcanza un puntaje récord de ${bestScoreTiers[i].toLocaleString()} puntos en una partida.`, color:colors.yellow, icon:SVG_TROPHY }]);

    // --- ESCALABLES: DÍAS VISITADOS (NO CONSECUTIVOS) (5) ---
    const totalDaysTiers=[3,7,15,30,60];
    for(let i=0;i<5;i++) addAchs([{ id:`td2${i+1}`, title:`Asiduo ${i+1}`, desc:`Juega en ${totalDaysTiers[i]} días distintos en total (no necesariamente seguidos).`, color:colors.green, icon:SVG_CLOCK }]);

    // --- ESCALABLES: VECES QUE SE FIjaron LOGROS (5) ---
    const pinTiers=[1,5,10,20,30];
    for(let i=0;i<5;i++) addAchs([{ id:`pin${i+1}`, title:`Curador ${i+1}`, desc:`Fija logros en el perfil ${pinTiers[i]} veces en total.`, color:colors.blue, icon:SVG_PIN }]);

    // --- ESCALABLES: LOGROS CONSEGUIDOS EN UN SOLO DÍA (5) ---
    const dailyAchTiers=[3,5,10,15,20];
    for(let i=0;i<5;i++) addAchs([{ id:`da${i+1}`, title:`Productivo ${i+1}`, desc:`Desbloquea ${dailyAchTiers[i]} logros nuevos en un mismo día.`, color:colors.purple, icon:SVG_STAR }]);

    // --- ESCALABLES: RACHAS DE FRENESÍ (tiempo continuo en modo frenesí) (5) ---
    const frenzyTimeTiers=[5,15,30,60,100];
    for(let i=0;i<5;i++) addAchs([{ id:`ft${i+1}`, title:`Frenesí Eterno ${i+1}`, desc:`Mantén el Modo Frenesí activo durante ${frenzyTimeTiers[i]} preguntas consecutivas.`, color:colors.red, icon:SVG_FIRE }]);

    // --- ÚNICOS EXTRA JUGABILIDAD (20) ---
    addAchs([
        { id: 'x1',  title: 'Primer Día',      desc: 'Inicia sesión por primera vez.',                              color: colors.blue,   icon: SVG_CLOCK },
        { id: 'x2',  title: 'Paciente',         desc: 'Espera 10 segundos en el menú principal sin hacer nada.',    color: colors.dark,   icon: SVG_CLOCK },
        { id: 'x3',  title: 'Aprendiz',         desc: 'Completa tu primera partida (sin importar el puntaje).',     color: colors.green,  icon: SVG_TARGET },
        { id: 'x4',  title: 'Doble Victoria',   desc: 'Gana más de 15,000 puntos dos partidas seguidas.',           color: colors.yellow, icon: SVG_TROPHY },
        { id: 'x5',  title: 'La Revancha',      desc: 'Después de una partida con 0 aciertos, consigue más de 10 aciertos.', color: colors.orange, icon: SVG_FIRE },
        { id: 'x6',  title: 'Consistente',      desc: 'Termina 5 partidas seguidas con al menos 5,000 puntos.',    color: colors.blue,   icon: SVG_SHIELD },
        { id: 'x7',  title: 'Un Golpe Certero', desc: 'Acumula 1,000 puntos en la primera pregunta.',               color: colors.yellow, icon: SVG_BOLT },
        { id: 'x8',  title: 'Sin Prisa',        desc: 'Termina una partida usando menos de 5 respuestas rápidas.', color: colors.dark,   icon: SVG_CLOCK },
        { id: 'x9',  title: 'Todo Gas',         desc: 'Responde las primeras 10 preguntas en menos de 3 segundos cada una.', color: colors.red, icon: SVG_BOLT },
        { id: 'x10', title: 'Economía',         desc: 'Completa 20 preguntas sin perder ninguna vida.',             color: colors.green,  icon: SVG_HEART },
        { id: 'x11', title: 'El Último Chance', desc: 'Responde correctamente estando en la última vida.',          color: colors.orange, icon: SVG_SHIELD },
        { id: 'x12', title: 'Principiante Letal',desc:'Consigue 10,000 puntos en tu primera partida del día.',     color: colors.blue,   icon: SVG_STAR },
        { id: 'x13', title: 'Noche de Fuego',   desc: 'Juega más de 10 partidas en un único día.',                 color: colors.red,    icon: SVG_FIRE },
        { id: 'x14', title: 'Invicto',          desc: 'Termina una partida de 30 preguntas sin perder una vida.',  color: colors.green,  icon: SVG_SHIELD },
        { id: 'x15', title: 'Punto de Quiebre', desc: 'Alcanza exactamente 10,000 puntos (±50).',                  color: colors.purple, icon: SVG_TARGET },
        { id: 'x16', title: 'Regreso Triunfal', desc: 'Después de no jugar por un día, supera tu último récord.',  color: colors.yellow, icon: SVG_TROPHY },
        { id: 'x17', title: 'Veterano',         desc: 'Acumula más de 100 partidas jugadas.',                      color: colors.blue,   icon: SVG_TROPHY },
        { id: 'x18', title: 'El Clásico',       desc: 'Usa el mismo nombre de jugador por 30 días seguidos.',      color: colors.purple, icon: SVG_USER },
        { id: 'x19', title: 'Espectacular',     desc: 'Consigue 5 respuestas Flash (< 1 seg) en una partida.',    color: colors.yellow, icon: SVG_BOLT },
        { id: 'x20', title: 'Pura Determinación',desc:'Juega 20 partidas en un día con al menos 1 logro desbloqueado en cada una.', color:colors.red, icon:SVG_FIRE },
    ]);

    // --- ESCALABLES: VISITAS AL PERFIL (5) ---
    const profileVisTiers=[1,5,15,30,60];
    for(let i=0;i<5;i++) addAchs([{ id:`pv${i+1}`, title:`Egocéntrico ${i+1}`, desc:`Visita tu perfil ${profileVisTiers[i]} veces.`, color:colors.purple, icon:SVG_USER }]);

    // --- ESCALABLES: VISITAS AL CANJE (5) ---
    const canjeVisTiers=[1,3,7,15,30];
    for(let i=0;i<5;i++) addAchs([{ id:`cj${i+1}`, title:`Aspirante ${i+1}`, desc:`Visita la Zona de Canje BPD ${canjeVisTiers[i]} veces.`, color:colors.yellow, icon:SVG_TROPHY }]);

    // --- ESCALABLES: SESIONES CONSECUTIVAS (dias que has vuelto, 5) ---
    const returnDayTiers=[2,5,10,20,30];
    for(let i=0;i<5;i++) addAchs([{ id:`ret${i+1}`, title:`Fiel ${i+1}`, desc:`Regresa a jugar ${returnDayTiers[i]} días diferentes (sin necesidad de ser consecutivos).`, color:colors.green, icon:SVG_HEART }]);

    // --- ÚNICOS BPD / CANJE (2) ---
    addAchs([
        { id: 'bpd1', title: 'En la Mira',    desc: 'Revela el cheque de la Zona de Canje BPD por primera vez.',  color: colors.yellow, icon: SVG_TROPHY },
        { id: 'bpd2', title: 'Seleccionado',  desc: 'Visita el Canje teniendo exactamente 99 logros desbloqueados.', color: colors.orange, icon: SVG_STAR },
    ]);

    // --- ÚNICOS FINALES (5 para llegar a 250) ---
    addAchs([
        { id: 'fin1', title: 'Nocturno',       desc: 'Juega una partida después de las 11:00 PM.',                 color: colors.dark,   icon: SVG_CLOCK },
        { id: 'fin2', title: 'Madrugador',     desc: 'Juega una partida antes de las 6:00 AM.',                   color: colors.blue,   icon: SVG_CLOCK },
        { id: 'fin3', title: 'Momento Épico',  desc: 'Entra en Modo Frenesí y luego consigue 20 aciertos más.',   color: colors.red,    icon: SVG_FIRE },
        { id: 'fin4', title: 'El Pacto',       desc: 'Juega durante 7 días seguidos y alcanza el rango Junior.',  color: colors.green,  icon: SVG_SHIELD },
        { id: 'fin5', title: 'Monarca',        desc: 'Alcanza simultáneamente el rango Leyenda y 200 logros.',    color: colors.yellow, icon: SVG_TROPHY },
    ]);




    function processDailyLogin() {
        const now = new Date(); const todayStr = now.toISOString().split('T')[0];
        if (playerStats.lastLoginDate !== todayStr) {
            const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1); const yesterdayStr = yesterday.toISOString().split('T')[0];
            if (playerStats.lastLoginDate === yesterdayStr) { playerStats.currentLoginStreak++; playerStats.maxLoginStreak = Math.max(playerStats.maxLoginStreak, playerStats.currentLoginStreak); } 
            else { playerStats.currentLoginStreak = 1; if(playerStats.maxLoginStreak === 0) playerStats.maxLoginStreak = 1; }
            playerStats.lastLoginDate = todayStr; playerStats.todayGames = 0; saveStatsLocally(); checkAchievements();
        }
    }
    function shuffleArray(array) { let current = array.length, random; while (current !== 0) { random = Math.floor(Math.random() * current); current--; [array[current], array[random]] = [array[random], array[current]]; } return array; }

    function getRankInfo(stats) {
        if (stats.bestScore >= 20000 && stats.totalCorrect >= 5000 && stats.gamesPlayed >= 500 && stats.perfectGames >= 20 && stats.maxStreak >= 20) return { title: "Leyenda", color: "var(--accent-yellow)", rgb: "255, 184, 0" };
        if (stats.bestScore >= 16000 && stats.totalCorrect >= 2000 && stats.gamesPlayed >= 200 && stats.maxStreak >= 15) return { title: "Maestro", color: "var(--accent-red)", rgb: "255, 42, 95" };
        if (stats.bestScore >= 12000 && stats.totalCorrect >= 500 && stats.gamesPlayed >= 100 && stats.maxStreak >= 10) return { title: "Pro", color: "var(--accent-blue)", rgb: "0, 212, 255" };
        if (stats.bestScore >= 8000 && stats.totalCorrect >= 100 && stats.gamesPlayed >= 20) return { title: "Junior", color: "var(--accent-orange)", rgb: "247, 127, 0" };
        return { title: "Novato", color: "var(--accent-green)", rgb: "0, 255, 102" };
    }
    let currentRankInfo = getRankInfo(playerStats);

    function checkAchievements() {
        let newlyUnlocked = [];
        const unlock = (id) => { if (!playerStats.achievements.includes(id)) { playerStats.achievements.push(id); const f = ACHIEVEMENTS_DATA.find(a => a.id === id); if(f) newlyUnlocked.push(f); } };
        
        if (playerStats.achievements.includes('tramposo')) {
            if (!playerStats.pinnedAchievements.includes('tramposo')) {
                playerStats.pinnedAchievements.unshift('tramposo');
                if (playerStats.pinnedAchievements.length > 3) playerStats.pinnedAchievements.pop();
            } else if (playerStats.pinnedAchievements.indexOf('tramposo') !== 0) {
                playerStats.pinnedAchievements.splice(playerStats.pinnedAchievements.indexOf('tramposo'), 1);
                playerStats.pinnedAchievements.unshift('tramposo');
            }
        }

        const normalAchs = playerStats.achievements.filter(id => id !== 'tramposo').length;

        // META
        if (playerStats.nameChanges >= 1) unlock('m1'); if (playerStats.nameChanges >= 5) unlock('m2'); if (playerStats.nameChanges >= 20) unlock('m3');
        if (playerStats.achViews >= 1) unlock('m4'); if (playerStats.achViews >= 10) unlock('m5'); if (playerStats.achViews >= 50) unlock('m6');
        if (playerStats.pinnedAchievements.filter(id => id !== 'tramposo').length > 0) unlock('m7'); 
        if (normalAchs >= 10) unlock('m8'); if (normalAchs >= 50) unlock('m9'); if (normalAchs >= 100) unlock('m10');
        if (normalAchs >= 150) unlock('master1'); if (normalAchs >= 200) unlock('master2'); if (normalAchs >= 225) unlock('master4'); if (normalAchs >= 250) unlock('master3');

        // DÍAS
        const days = playerStats.maxLoginStreak; for(let i=0;i<10;i++) if(days>=daysTiers[i]) unlock(`d${i+1}`);
        // PARTIDAS
        const pts = playerStats.gamesPlayed; for(let i=0;i<8;i++) if(pts>=ptTiers[i]) unlock(`p${i+1}`);
        // PUNTOS TOTALES
        const tot = playerStats.totalScore; for(let i=0;i<8;i++) if(tot>=ptsTiers[i]) unlock(`pt${i+1}`);
        // RÉCORDS
        const hsc = playerStats.maxScoreCount; for(let i=0;i<8;i++) if(hsc>=hsCountTiers[i]) unlock(`hs${i+1}`);
        // FRENESÍ
        const fr = playerStats.frenziesTriggered; for(let i=0;i<8;i++) if(fr>=frTiers[i]) unlock(`r${i+1}`);
        // PARTIDAS LARGAS
        const pf = playerStats.perfectGames; for(let i=0;i<8;i++) if(pf>=pfTiers[i]) unlock(`pf${i+1}`);
        // VELOCIDAD
        const sp = playerStats.fastAnswersTotal; for(let i=0;i<8;i++) if(sp>=spdTiers[i]) unlock(`sp${i+1}`);
        // ACIERTOS
        const ac = playerStats.totalCorrect; for(let i=0;i<8;i++) if(ac>=acTiers[i]) unlock(`ac${i+1}`);
        // RACHAS
        const sk = playerStats.maxStreak; for(let i=0;i<8;i++) if(sk>=strkTiers[i]) unlock(`sk${i+1}`);
        // MULTIPLICADORES
        const mx = playerStats.maxMult||1; for(let i=0;i<5;i++) if(mx>=multTiers[i]) unlock(`mx${i+1}`);
        // VISITAS RANKING
        const rv = playerStats.rankingViews||0; for(let i=0;i<5;i++) if(rv>=rankVisTiers[i]) unlock(`rv${i+1}`);
        // VISITAS CONFIG
        const cv = playerStats.configViews||0; for(let i=0;i<5;i++) if(cv>=cfgVisTiers[i]) unlock(`cv${i+1}`);
        // VISITAS MANUAL
        const gv = playerStats.guideViews||0; for(let i=0;i<5;i++) if(gv>=guideVisTiers[i]) unlock(`gv${i+1}`);
        // NO TIMEOUTS SEGUIDOS
        const nt = playerStats.maxNoTimeoutStreak||0; for(let i=0;i<5;i++) if(nt>=noTimoutTiers[i]) unlock(`nt${i+1}`);

        // ÚNICOS DE JUEGO
        if (playerStats.totalWrong > 0) unlock('u1'); if (playerStats.totalWrong >= 100) unlock('u2'); 
        if (playerStats.totalTimeouts > 0) unlock('u3'); if (playerStats.totalTimeouts >= 50) unlock('u4'); 
        if (playerStats.todayGames >= 50) unlock('u22'); if (playerStats.perfectStreak >= 2) unlock('u23');
        const rank = getRankInfo(playerStats).title; 
        if (rank==="Pro"||rank==="Maestro"||rank==="Leyenda") unlock('u6'); 
        if (rank==="Maestro"||rank==="Leyenda") unlock('u7'); 
        if (rank==="Leyenda") unlock('u8');

        // FALLOS ESCALABLES
        const wr = playerStats.totalWrong||0; for(let i=0;i<5;i++) if(wr>=wrnTiers[i]) unlock(`wr${i+1}`);
        // TIMEOUTS ESCALABLES
        const to = playerStats.totalTimeouts||0; for(let i=0;i<5;i++) if(to>=toTiers[i]) unlock(`to${i+1}`);
        // PARTIDAS HOY
        const td = playerStats.todayGames||0; for(let i=0;i<5;i++) if(td>=todayTiers[i]) unlock(`td${i+1}`);

        // RANKING
        const pl = playerStats.powerLevel||0; 
        if(pl>=1000) unlock('nm8'); if(pl>=5000) unlock('nm9'); if(pl>=15000) unlock('nm10');
        const rp = playerStats.rankingPosition||999;
        if(rp<=20) unlock('nm1'); if(rp<=10) unlock('nm2'); if(rp<=3) unlock('nm3'); if(rp===1) unlock('nm4');

        // CONFIG OCULTOS
        if(playerStats.musicSetTo0) unlock('cfg1');
        if((playerStats.musicVol||1)>=1.0 && (playerStats.sfxVol||1)>=1.0) {}  // handled on slider
        if(playerStats.musicSetTo0 && playerStats.sfxSetTo0) unlock('cfg3');
        if((playerStats.fpsChanges||0)>=5) unlock('cfg4');
        if(playerStats.maxFps===240) unlock('cfg5');
        if(playerStats.maxFps===15) unlock('cfg6');
        if(playerStats.particles0) unlock('cfg7');

        // UI OCULTOS
        if((playerStats.rankingViews||0)>=1) unlock('ui1');  // simplificado
        if(playerStats.nameChanges>=1 && playerStats.gamesPlayed>=1) unlock('ui7');

        // VISITAS AL PERFIL
        const pvv = playerStats.profileViews||0; for(let i=0;i<5;i++) if(pvv>=profileVisTiers[i]) unlock(`pv${i+1}`);
        // VISITAS AL CANJE
        const cjv = playerStats.canjeViews||0; for(let i=0;i<5;i++) if(cjv>=canjeVisTiers[i]) unlock(`cj${i+1}`);
        // DÍAS DE REGRESO
        const retv = playerStats.totalDaysPlayed||0; for(let i=0;i<5;i++) if(retv>=returnDayTiers[i]) unlock(`ret${i+1}`);
        // BPD
        if(playerStats.chequerevealed) unlock('bpd1');
        if((playerStats.canjeViews||0)>=1 && playerStats.achievements.filter(id=>id!=='tramposo').length===99) unlock('bpd2');

        // ESCALABLES NUEVAS
        const bsv = playerStats.bestScore||0; for(let i=0;i<8;i++) if(bsv>=bestScoreTiers[i]) unlock(`bs${i+1}`);
        const fts = playerStats.maxFrenzyStreak||0; for(let i=0;i<5;i++) if(fts>=frenzyTimeTiers[i]) unlock(`ft${i+1}`);

        // ÚNICOS EXTRA
        if(playerStats.gamesPlayed>=1) unlock('x3');
        if(playerStats.gamesPlayed>=100) unlock('x17');
        if(playerStats.nameChanges===0 && playerStats.maxLoginStreak>=30) unlock('x18');
        if(rank==='Leyenda' && normalAchs>=200) unlock('fin5');
        if(days>=7 && (getRankInfo(playerStats).title!=='Novato')) unlock('fin4');

        // TIEMPO DEL DÍA
        const hora = new Date().getHours();
        if(hora>=23||hora<1) { if(!playerStats.playedNocturno) playerStats.playedNocturno=true; }
        if(hora<6) { if(!playerStats.playedMadrugador) playerStats.playedMadrugador=true; }
        if(playerStats.playedNocturno) unlock('fin1');
        if(playerStats.playedMadrugador) unlock('fin2');

        if (newlyUnlocked.length > 0) { saveStatsLocally(); renderAchievements(); newlyUnlocked.forEach((ach, index) => { setTimeout(() => { SFX.achievement(); showToast('Logro Desbloqueado', ach.title, ach.color, ach.icon); }, index * 1300); }); }
    }

    function togglePin(achId) {
        if (achId === 'tramposo') { 
            showToast('Condena Permanente', 'Los tramposos no pueden ocultar sus actos.', 'var(--accent-red)', SVG_SKULL); 
            return; 
        }
        if (!playerStats.achievements.includes(achId)) return; SFX.click(); const index = playerStats.pinnedAchievements.indexOf(achId);
        if (index > -1) playerStats.pinnedAchievements.splice(index, 1); else { if (playerStats.pinnedAchievements.length >= 3) { showToast('Límite', 'Máximo 3 fijados', 'var(--accent-red)', SVG_INCORRECT); return; } playerStats.pinnedAchievements.push(achId); }
        saveStatsLocally(); checkAchievements(); renderAchievements();
    }
    let isAchievementsInitialized = false; const achCardElements = {};
    function initializeAchievementsDOM() {
        const fullGrid = document.getElementById('full-achievements-grid'); if(!fullGrid) return; fullGrid.innerHTML = ''; const fragment = document.createDocumentFragment();
        ACHIEVEMENTS_DATA.forEach(ach => { const card = document.createElement('div'); card.id = `ach-card-${ach.id}`; card.className = 'ach-card'; card.onclick = () => togglePin(ach.id); achCardElements[ach.id] = card; fragment.appendChild(card); });
        fullGrid.appendChild(fragment); isAchievementsInitialized = true;
    }
    function renderAchievements() {
        if (!isAchievementsInitialized) initializeAchievementsDOM();
        const profileGrid = document.getElementById('profile-achievements-grid'); let unlockedCount = playerStats.achievements.filter(id => id !== 'tramposo').length;
        ACHIEVEMENTS_DATA.forEach(ach => {
            const isUnlocked = playerStats.achievements.includes(ach.id), isPinned = playerStats.pinnedAchievements.includes(ach.id), card = achCardElements[ach.id]; if(!card) return;
            card.className = `ach-card ${isUnlocked ? 'unlocked' : ''} ${isPinned ? 'pinned' : ''}`;
            if(isUnlocked && !isPinned) { card.style.borderColor = ach.color; card.style.boxShadow = `0 10px 20px ${ach.color.replace(')', ', 0.1)').replace('var(', 'rgba(')}`; } else { card.style.borderColor = ''; card.style.boxShadow = ''; }
            card.innerHTML = `<div class="pin-hint" style="position:absolute;top:5px;right:5px;font-size:0.6rem;color:var(--accent-yellow);opacity:${isPinned?1:0}">${SVG_PIN}</div><div class="ach-icon" style="color: ${isUnlocked ? ach.color : 'var(--text-secondary)'};">${isUnlocked ? ach.icon : SVG_LOCK}</div><div class="ach-title">${ach.title}</div><div class="ach-desc">${isUnlocked ? ach.desc : 'Misterio... Sigue jugando para descubrirlo.'}</div>`;
        });
        if (profileGrid) {
            profileGrid.innerHTML = ''; const profFragment = document.createDocumentFragment(); let profileRendered = 0;
            playerStats.pinnedAchievements.forEach(id => { 
                if (profileRendered >= 3) return; 
                let ach = ACHIEVEMENTS_DATA.find(a => a.id === id); 
                if (id === 'tramposo') ach = CHEATER_ACHIEVEMENT;
                if (ach) { appendProfileSlot(profFragment, ach, true); profileRendered++; } 
            });
            [...playerStats.achievements].reverse().forEach(id => { 
                if (profileRendered >= 3 || playerStats.pinnedAchievements.includes(id) || id === 'tramposo') return; 
                const ach = ACHIEVEMENTS_DATA.find(a => a.id === id); 
                if (ach) { appendProfileSlot(profFragment, ach, false); profileRendered++; } 
            });
            while (profileRendered < 3) { const slot = document.createElement('div'); slot.className = 'achievement-slot'; slot.innerHTML = `<div class="ach-icon" style="color: var(--text-secondary);">${SVG_LOCK}</div><div class="ach-title" style="color: var(--text-secondary);">Vacío</div>`; profFragment.appendChild(slot); profileRendered++; }
            profileGrid.appendChild(profFragment);
        }
        document.getElementById('achievements-progress-text').innerText = `Desbloqueados: ${unlockedCount} / 250`;
    }
    function appendProfileSlot(grid, ach, isPinned) {
        const slot = document.createElement('div'); slot.className = `achievement-slot unlocked ${isPinned ? 'pinned' : ''}`; slot.style.borderColor = ach.color;
        slot.innerHTML = `<div class="pin-indicator" style="display:${isPinned?'block':'none'}">${SVG_PIN}</div><div class="ach-icon" style="color: ${ach.color};">${ach.icon}</div><div class="ach-title">${ach.title}</div>`; grid.appendChild(slot);
    }

    // --- UI Flow ---
    function switchScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); setTimeout(() => document.getElementById(id).classList.add('active'), 50); }
    function goToMainMenu() { SFX.click(); switchScreen('start-screen'); }
    function goToGuide() { initAudio(); SFX.click(); playerStats.guideViews++; saveStatsLocally(); checkAchievements(); switchScreen('guide-screen'); }
    function goToAchievements() { initAudio(); SFX.click(); playerStats.achViews++; saveStatsLocally(); checkAchievements(); renderAchievements(); switchScreen('achievements-screen'); }
    
    function goToRanking() { 
        initAudio(); SFX.click();
        playerStats.rankingViews = (playerStats.rankingViews||0) + 1;
        saveStatsLocally(); checkAchievements();
        switchScreen('ranking-screen');
    }

    function goToCanje() {
        initAudio(); SFX.click();
        playerStats.canjeViews = (playerStats.canjeViews||0) + 1;
        saveStatsLocally(); checkAchievements();
        const unlocked = playerStats.achievements.length;
        const isLeyenda = currentRankInfo.title === "Leyenda";
        
        let statusHtml = `Logros: <span style="color:${unlocked >= 100 ? 'var(--accent-green)' : 'var(--accent-yellow)'}">${unlocked}/250</span><br>`;
        statusHtml += `Rango: <span style="color:${isLeyenda ? 'var(--accent-green)' : 'var(--accent-yellow)'}">${currentRankInfo.title}</span> (Requiere Leyenda)<br>`;

        if(unlocked < 100 || !isLeyenda) { statusHtml += `<span class="canje-status-sub" style="color:var(--accent-red)">Faltan requisitos para reclamar.</span>`; } 
        else { statusHtml += `<span class="canje-status-sub" style="color:var(--accent-green)">¡Cumples todos los requisitos!</span>`; }
        
        document.getElementById('canje-status').innerHTML = statusHtml;
        const btn = document.getElementById('canje-btn');
        const cName = document.getElementById('c-name');
        const cAmount = document.getElementById('c-amount');
        
        cName.innerText = (playerStats.playerName && playerStats.playerName !== "JUGADOR") ? playerStats.playerName : "JUGADOR ANÓNIMO";
        cName.classList.remove('locked');
        
        if(unlocked >= 100 && isLeyenda) { 
            btn.disabled = false; btn.style.opacity = 1; btn.style.cursor = 'pointer'; 
            cAmount.classList.remove('locked'); cAmount.innerText = "1,000,000 ℙ";
        } else { 
            btn.disabled = true; btn.style.opacity = 0.5; btn.style.cursor = 'not-allowed'; 
            cAmount.classList.add('locked'); cAmount.innerText = "*** BLOQUEADO ***";
            document.getElementById('canje-instruction').style.display = 'none';
        }
        switchScreen('canje-screen');
    }
    
    function revelarCheque() {
        SFX.achievement();
        playerStats.chequerevealed = true;
        saveStatsLocally(); checkAchievements();
        document.getElementById('canje-status').style.display = 'none';
        document.getElementById('canje-btn').style.display = 'none';
        const cAmount = document.getElementById('c-amount'); cAmount.classList.add('gold');
        document.getElementById('canje-instruction').style.display = 'block';
        document.getElementById('c-date').innerText = new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    function goToProfile(needsName = false) {
        initAudio(); SFX.click();
        playerStats.profileViews = (playerStats.profileViews||0) + 1;
        document.getElementById('stat-games').innerText = playerStats.gamesPlayed; document.getElementById('stat-score').innerText = playerStats.bestScore; document.getElementById('stat-streak').innerText = playerStats.maxStreak; document.getElementById('stat-days').innerText = playerStats.maxLoginStreak;
        document.getElementById('profile-name-input').value = (playerStats.playerName === "JUGADOR") ? "" : playerStats.playerName;
        document.getElementById('profile-warning').style.opacity = needsName ? '1' : '0';
        currentRankInfo = getRankInfo(playerStats); updateLogoDots(); document.getElementById('profile-rank-display').innerText = `Rango: ${currentRankInfo.title}`; document.getElementById('profile-rank-display').style.color = currentRankInfo.color;
        renderAchievements(); switchScreen('profile-screen');
        if (needsName) setTimeout(() => { document.getElementById('profile-name-input').focus(); document.getElementById('profile-name-input').classList.add('shake'); setTimeout(() => document.getElementById('profile-name-input').classList.remove('shake'), 400); }, 400);
    }

    async function startGameCheck() { 
        initAudio(); 
        if (!playerStats.playerName || playerStats.playerName === "JUGADOR") { 
            SFX.incorrect(); goToProfile(true); 
            return;
        } 
        if (quizDataPool.length === 0) {
            const btn = document.querySelector('.btn-solid');
            const originalText = btn.innerText;
            btn.innerText = "Cargando..."; btn.style.opacity = "0.7";
            await loadQuestions();
            btn.innerText = originalText; btn.style.opacity = "1";
        }
        startGame(); 
    }

    document.getElementById('profile-name-input').addEventListener('input', e => { e.target.value = e.target.value.replace(/[^a-zA-Z0-9ÁÉÍÓÚÑáéíóúñ ]/g, '').toUpperCase(); document.getElementById('profile-warning').style.opacity = e.target.value ? '0' : '1'; });
    document.getElementById('profile-name-input').addEventListener('change', e => { 
        const n = e.target.value.trim(); 
        if(n && n !== "JUGADOR" && n !== playerStats.playerName) playerStats.nameChanges++; 
        playerStats.playerName = n || "JUGADOR"; 
        saveStatsLocally(); checkAchievements(); 
        submitLeaderboard();
    });
    document.getElementById('profile-name-input').addEventListener('keypress', function(e) { if(e.key === 'Enter') this.blur(); });
    
    function updateLogoDots() { 
        document.documentElement.style.setProperty('--rank-rgb', currentRankInfo.rgb); 
        document.documentElement.style.setProperty('--rank-color', currentRankInfo.color); 
        document.querySelectorAll('.logo-dot').forEach(d => { d.style.color = currentRankInfo.color; d.style.textShadow = `0 0 15px rgba(${currentRankInfo.rgb}, 0.5)`; }); 
        
        const favicon = document.getElementById('dynamic-favicon');
        if(favicon) {
            const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='rgb(${currentRankInfo.rgb})' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'><polygon points='13 2 3 14 12 14 11 22 21 10 12 10 13 2'></polygon></svg>`;
            favicon.href = `data:image/svg+xml,${encodeURIComponent(svg)}`;
        }
    }

    // --- Game Logic ---
    let currentSessionQuestions = [], currentQuestionIndex = 0, score = 0, streak = 0, currentMaxStreak = 0, timerInterval, timeLeft = 15; 
    const TIMER_LIMIT = 15;
    let currentFastAnswers = 0, currentWrongAnswers = 0, currentTimeoutAnswers = 0, isAnsweringAllowed = false, currentGameLog = [];
    let isGamePaused = false;
    let lives = 3;
    let multiplier = 1;
    // Tracked per-game for achievements
    let lastSecondAnswers = 0; // count of answers at 1 sec remaining
    let ultraFastStreak = 0;   // consecutive answers under 3 sec

    function startGame() {
        initAudio(); SFX.gameStart();
        
        // Hora del día para logros
        const hora = new Date().getHours();
        if(hora>=23||hora<1) playerStats.playedNocturno=true;
        if(hora<6) playerStats.playedMadrugador=true;
        
        // Total days tracking
        const todayStr2 = new Date().toISOString().split('T')[0];
        if(!playerStats.totalDaysSet) playerStats.totalDaysSet = new Set();
        if(!playerStats.totalDaysPlayed) playerStats.totalDaysPlayed = 0;
        if(!playerStats.lastPlayedDay || playerStats.lastPlayedDay !== todayStr2) {
            playerStats.lastPlayedDay = todayStr2;
            playerStats.totalDaysPlayed++;
        }
        
        document.getElementById('player-name-display').innerText = playerStats.playerName; 
        document.getElementById('final-name').innerText = playerStats.playerName;
        
        currentSessionQuestions = shuffleArray([...quizDataPool]);
        currentQuestionIndex = score = streak = currentMaxStreak = currentFastAnswers = currentWrongAnswers = currentTimeoutAnswers = 0; 
        currentGameLog = []; isGamePaused = false;
        lives = 3; multiplier = 1;
        lastSecondAnswers = 0; ultraFastStreak = 0;
        
        document.getElementById('lives-container').style.display = 'flex';
        document.getElementById('progress-container').style.display = 'none';
        document.getElementById('score-display').innerText = 0;
        updateLivesUI(); updateMultiplierUI(); updateStreakVisuals();
        
        showCountdown(() => {
            switchScreen('question-screen');
            setTimeout(loadQuestion, 200);
        });
    }

    function showCountdown(callback) {
        switchScreen('countdown-screen');
        const numEl = document.getElementById('countdown-number');
        const lblEl = document.getElementById('countdown-label');
        const steps = [
            { text: '3', label: 'Prepárate...' },
            { text: '2', label: '¡Concéntrate!' },
            { text: '1', label: '¡Ya casi!' },
            { text: '¡YA!', label: '' }
        ];
        let i = 0;
        function tick() {
            if (i >= steps.length) { callback(); return; }
            numEl.style.transform = 'scale(0.5)'; numEl.style.opacity = '0';
            lblEl.style.opacity = '0';
            setTimeout(() => {
                numEl.textContent = steps[i].text;
                lblEl.textContent = steps[i].label;
                numEl.style.transform = 'scale(1)'; numEl.style.opacity = '1';
                lblEl.style.opacity = '1';
                SFX.tick();
                i++;
                setTimeout(tick, i < steps.length ? 800 : 400);
            }, 150);
        }
        tick();
    }

    function updateLivesUI() {
        const c = document.getElementById('lives-container');
        c.innerHTML = '';
        for(let i = 0; i < 3; i++) {
            let el = document.createElement('div');
            el.innerHTML = SVG_BOLT;
            if(i >= lives) el.classList.add('life-lost');
            c.appendChild(el);
        }
    }

    function updateMultiplierUI() {
        const b = document.getElementById('multiplier-badge');
        multiplier = Math.max(1, Math.floor(streak / 5) + 1);
        if(multiplier > (playerStats.maxMult||1)) { playerStats.maxMult = multiplier; }
        if(multiplier > 1) {
            b.style.display = 'block';
            b.innerText = `x${multiplier}`;
        } else {
            b.style.display = 'none';
        }
    }
    
    function updateStreakVisuals() { 
        const app = document.getElementById('app'); 
        if (streak >= 5) { 
            if (!app.classList.contains('streak-active')) { app.classList.add('streak-active'); SFX.streakTrigger(); } 
        } else app.classList.remove('streak-active'); 
    }

    function getNextQuestion() {
        if(currentQuestionIndex >= currentSessionQuestions.length - 2) {
            currentSessionQuestions = currentSessionQuestions.concat(shuffleArray([...quizDataPool]));
        }
        return currentSessionQuestions[currentQuestionIndex];
    }
    
    function loadQuestion() {
        const currentQ = getNextQuestion();
        const timerPath = document.getElementById('timer-path');
        const timerText = document.getElementById('timer-display');
        
        document.getElementById('question-text').innerText = currentQ.question;
        
        let mixedAnswers = currentQ.answers.map((text, idx) => ({ text: text, isCorrect: idx === currentQ.correctIndex }));
        mixedAnswers = shuffleArray(mixedAnswers);
        for(let i=0; i<4; i++) { 
            document.getElementById(`ans-${i}`).innerText = mixedAnswers[i].text;
            if (mixedAnswers[i].isCorrect) currentQ.currentCorrectIndex = i;
        }

        document.getElementById('answers-grid').classList.remove('answered'); 
        document.querySelectorAll('.answer-btn').forEach(btn => btn.classList.remove('selected'));
        isAnsweringAllowed = true; isGamePaused = false; timeLeft = TIMER_LIMIT; timerText.innerText = timeLeft; 
        
        timerPath.style.transition = 'none'; timerPath.style.strokeDashoffset = '0'; timerPath.style.stroke = 'var(--text-primary)'; timerText.style.color = 'var(--text-primary)'; void timerPath.offsetWidth; timerPath.style.transition = 'stroke-dashoffset 1s linear, stroke 0.3s ease';
        
        clearInterval(timerInterval); 
        timerInterval = setInterval(() => { 
            if (isGamePaused) return;
            timeLeft--; timerText.innerText = timeLeft; timerPath.style.strokeDashoffset = 283 - (timeLeft/TIMER_LIMIT)*283; 
            if(timeLeft <= 5 && timeLeft > 0) { SFX.tick(); timerPath.style.stroke = 'var(--accent-red)'; timerText.style.color = 'var(--accent-red)'; } 
            if(timeLeft <= 0) handleTimeout(); 
        }, 1000);
    }
    
    function selectAnswer(selectedIndex) {
        if (!isAnsweringAllowed || isGamePaused) return; isAnsweringAllowed = false; clearInterval(timerInterval); SFX.select();
        document.getElementById('answers-grid').classList.add('answered'); document.querySelectorAll('.answer-btn')[selectedIndex].classList.add('selected');
        
        const q = getNextQuestion();
        const isCorrect = (selectedIndex === q.currentCorrectIndex); 
        const answerTime = timeLeft;
        currentGameLog.push({ correct: isCorrect, time: answerTime });
        
        if(isCorrect) { 
            playerStats.totalCorrect++; 
            if(answerTime >= TIMER_LIMIT - 2) { currentFastAnswers++; playerStats.fastAnswersTotal++; }
            if(answerTime <= 1) lastSecondAnswers++;
            // Track ultra-fast for Metralleta
            if(answerTime >= TIMER_LIMIT - 3) { ultraFastStreak++; } else { ultraFastStreak = 0; }
        } else { 
            playerStats.totalWrong++; currentWrongAnswers++;
            ultraFastStreak = 0;
        }
        
        saveStatsLocally(); setTimeout(() => showFeedback(isCorrect), 600);
    }
    
    function handleTimeout() {
        if (!isAnsweringAllowed || isGamePaused) return; isAnsweringAllowed = false; clearInterval(timerInterval); 
        playerStats.totalWrong++; playerStats.totalTimeouts++; currentTimeoutAnswers++; 
        currentGameLog.push({ correct: false, timeout: true, time: 0 });
        ultraFastStreak = 0;
        saveStatsLocally(); document.getElementById('answers-grid').classList.add('answered'); setTimeout(() => showFeedback(false, true), 600);
    }

    function abandonGame() {
        if(!isAnsweringAllowed) return;
        SFX.click();
        isGamePaused = true;
        document.getElementById('abandon-modal').classList.add('active');
    }

    function cancelAbandon() {
        SFX.click();
        isGamePaused = false;
        document.getElementById('abandon-modal').classList.remove('active');
    }

    function confirmAbandon() {
        document.getElementById('abandon-modal').classList.remove('active');
        isAnsweringAllowed = false;
        clearInterval(timerInterval);
        initAudio(); SFX.incorrect(); 
        const penalty = 1000; 
        playerStats.totalScore = Math.max(0, playerStats.totalScore - penalty);
        saveStatsLocally(); submitLeaderboard(); 
        showToast('Partida Abandonada', `Penalidad de -1000 pts.`, 'var(--text-secondary)', SVG_INCORRECT);
        document.getElementById('app').classList.remove('streak-active');
        streak = 0;
        switchScreen('start-screen');
    }

    function replayGame() {
        SFX.click();
        startGame();
    }

    function animateScore(target) {
        const el = document.getElementById('score-display'); let curr = parseInt(el.innerText); const diff = target - curr; if(diff <= 0) return;
        const step = Math.ceil(diff / 20), t = setInterval(() => { curr += step; if(curr >= target) { curr = target; clearInterval(t); } el.innerText = curr; }, 20);
    }
    
    function showFeedback(isCorrect, isTimeout = false) {
        const scr = document.getElementById('feedback-screen'), icon = document.getElementById('feedback-icon-container'), title = document.getElementById('feedback-title'), points = document.getElementById('feedback-points');
        
        if (isCorrect) {
            SFX.correct(); scr.className = 'screen correct'; icon.innerHTML = SVG_CORRECT; title.innerText = "¡Excelente!";
            let earned = 800 + Math.round((timeLeft / TIMER_LIMIT) * 800);
            earned = earned * multiplier;
            score += earned; streak++; if(streak > currentMaxStreak) currentMaxStreak = streak;
            if (streak === 5) { playerStats.frenziesTriggered++; playerStats.currentFrenzyStreak = (playerStats.currentFrenzyStreak||0) + 1; }
            if (streak > 5 && streak % 5 !== 0) { playerStats.currentFrenzyStreak = (playerStats.currentFrenzyStreak||0) + 1; }
            if ((playerStats.currentFrenzyStreak||0) > (playerStats.maxFrenzyStreak||0)) playerStats.maxFrenzyStreak = playerStats.currentFrenzyStreak;
            points.innerText = `+${earned}`; points.style.display = 'block';
        } else {
            SFX.incorrect(); 
            if (isTimeout) { scr.className = 'screen timeout'; icon.innerHTML = SVG_TIMEOUT; title.innerText = "Tiempo Agotado"; } 
            else { scr.className = 'screen incorrect'; icon.innerHTML = SVG_INCORRECT; title.innerText = "Incorrecto"; }
            streak = 0; points.style.display = 'none';
            playerStats.currentFrenzyStreak = 0;
            lives--;
            updateLivesUI();
        }
        
        updateMultiplierUI();
        document.getElementById('streak-display').innerText = streak; 
        updateStreakVisuals(); 
        switchScreen('feedback-screen'); 
        setTimeout(() => animateScore(score), 300); 
        checkAchievements();
        
        setTimeout(() => { 
            currentQuestionIndex++;
            if(lives > 0) {
                switchScreen('question-screen'); setTimeout(loadQuestion, 400);
            } else {
                endGame();
            }
        }, 2000);
    }
    
    function saveGameStats() {
        playerStats.gamesPlayed++; playerStats.todayGames++; playerStats.totalScore += score; 
        if(score > playerStats.bestScore) playerStats.bestScore = score; 
        if(currentMaxStreak > playerStats.maxStreak) playerStats.maxStreak = currentMaxStreak;
        if(score >= 20000) playerStats.maxScoreCount++;
        playerStats.previousGameScore = score; 
        currentRankInfo = getRankInfo(playerStats); updateLogoDots(); saveStatsLocally(); checkAchievements();
        submitLeaderboard(); 
    }
    
    function endGame() {
        document.getElementById('final-score-display').innerText = score; saveGameStats();
        
        SFX.gameEnd();
        
        const msg = document.getElementById('final-message'), icn = document.getElementById('results-icon-svg');
        const endPanel = document.getElementById('end-glass-panel');

        if(score > 15000) { msg.innerText = "Superviviente Nato"; icn.innerHTML = SVG_TROPHY; endPanel.style.borderTopColor = 'var(--accent-yellow)'; }
        else if(score > 5000) { msg.innerText = "Buen Desempeño"; icn.innerHTML = SVG_STAR; endPanel.style.borderTopColor = 'var(--accent-blue)'; }
        else { msg.innerText = "Sigue Practicando"; icn.innerHTML = SVG_TARGET; endPanel.style.borderTopColor = 'var(--text-secondary)'; }

        document.getElementById('final-correct-label').innerText = 'Aciertos';
        document.getElementById('final-correct').innerText = currentQuestionIndex - currentWrongAnswers - currentTimeoutAnswers;
        document.getElementById('final-streak').innerText = currentMaxStreak; 
        document.getElementById('final-speed').innerText = currentFastAnswers;
        
        document.getElementById('app').classList.remove('streak-active'); streak = 0; switchScreen('end-screen');
    }

    // --- FPS Controlled Particles Reactivas ---
    const canvas = document.getElementById('particle-canvas'); const ctx = canvas.getContext('2d'); let particlesArray = [];
    let fpsInterval = 1000 / playerStats.maxFps; let then = performance.now();
    
    function initParticles() { 
        canvas.width = window.innerWidth; canvas.height = window.innerHeight; particlesArray = []; 
        let num = Math.min((canvas.width * canvas.height) / 10000, window.innerWidth < 768 ? 50 : 100); 
        for (let i = 0; i < num; i++) particlesArray.push(new Particle(Math.random() * innerWidth, Math.random() * innerHeight, (Math.random()*1)-0.5, (Math.random()*1)-0.5, (Math.random()*2)+1)); 
    }
    
    class Particle { 
        constructor(x, y, dx, dy, s) { this.x = x; this.y = y; this.dx = dx; this.dy = dy; this.s = s; this.baseS = s;} 
        draw(pulse) { 
            ctx.beginPath(); 
            // Las partículas crecen con los bajos de la música
            const dynamicSize = this.s + (pulse * 5); 
            ctx.arc(this.x, this.y, dynamicSize, 0, Math.PI*2); 
            ctx.fillStyle = `rgba(${currentRankInfo.rgb}, ${(streak >= 5 ? 0.8 : 0.5) * playerStats.particleOpacity})`; 
            ctx.fill(); 
        } 
        update(timeScale, pulse) { 
            const m = streak >= 5 ? 3.5 : 1; 
            if(this.x > canvas.width || this.x < 0) this.dx = -this.dx; 
            if(this.y > canvas.height || this.y < 0) this.dy = -this.dy; 
            
            // Reacción rápida al audio: Aceleración extra
            const speedBoost = 1 + (pulse * 2.5);
            this.x += this.dx * m * timeScale * speedBoost; 
            this.y += this.dy * m * timeScale * speedBoost; 
            
            this.draw(pulse); 
        } 
    }
    
    function connectParticles(pulse) { 
        const isStreak = streak >= 5; 
        for(let a = 0; a < particlesArray.length; a++) { 
            for(let b = a; b < particlesArray.length; b++) { 
                let dist = ((particlesArray[a].x - particlesArray[b].x)**2) + ((particlesArray[a].y - particlesArray[b].y)**2);
                let cDist = (canvas.width/10) * (canvas.height/10); 
                
                // Si la música golpea fuerte, conectan desde más lejos
                cDist = cDist * (1 + pulse);

                if (dist < cDist) { 
                    ctx.strokeStyle = `rgba(${currentRankInfo.rgb}, ${(1 - (dist / cDist)) * (isStreak ? 0.6 : 0.3) * playerStats.particleOpacity})`; 
                    // Grosor de la línea reacciona al audio
                    ctx.lineWidth = 1 + (pulse * 3); 
                    ctx.beginPath(); 
                    ctx.moveTo(particlesArray[a].x, particlesArray[a].y); 
                    ctx.lineTo(particlesArray[b].x, particlesArray[b].y); 
                    ctx.stroke(); 
                } 
            } 
        } 
    }
    
    function animateParticles(now) { 
        requestAnimationFrame(animateParticles); 
        let elapsed = now - then; 
        if (elapsed > fpsInterval) { 
            then = now - (elapsed % fpsInterval); 
            ctx.clearRect(0, 0, innerWidth, innerHeight); 
            
            let timeScale = elapsed / 16.666;
            if (timeScale > 10) timeScale = 10;
            
            const pulse = getAudioPulse(); // Extraemos la fuerza de la música

            for(let i=0; i<particlesArray.length; i++) particlesArray[i].update(timeScale, pulse); 
            connectParticles(pulse); 
        } 
    }
    
    window.addEventListener('resize', () => initParticles()); initParticles(); requestAnimationFrame(animateParticles);

    setTimeout(() => { processDailyLogin(); currentRankInfo = getRankInfo(playerStats); updateLogoDots(); checkAchievements(); submitLeaderboard(); fetchLeaderboard(); loadQuestions(); }, 500);
</script>
</body>
</html>
